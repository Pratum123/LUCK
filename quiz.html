<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ЁЯУЪ рдкреНрд░рд╢реНрдиреЛрддреНрддрд░реА рдРрдк (JSON рдЖрдпрд╛рдд рд╕рд╣рд┐рдд)</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #e4e7f0);
      margin: 0;
      padding: 0;
      color: #333;
      line-height: 1.6;
    }
    header {
      background: linear-gradient(135deg, #3949ab, #283593);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header div:first-child { font-size: 24px; font-weight: bold; }
    header div:last-child { font-size: 16px; margin-top: 8px; opacity: 0.9; }

    .section {
      background: white;
      max-width: 900px;
      margin: 20px auto;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h2, h3 { color: #3949ab; text-align: center; }

    textarea, input, select {
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 16px;
    }
    .btn {
      background: linear-gradient(135deg, #3949ab, #5c6bc0);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      font-weight: bold;
      transition: 0.3s;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    .submit-btn { background: linear-gradient(135deg, #4CAF50, #66BB6A); }
    .delete-btn { background: linear-gradient(135deg, #f44336, #e53935); }

    .btn-option {
      display: block;
      width: 100%;
      padding: 16px;
      margin: 12px 0;
      font-size: 17px;
      text-align: left;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn-option:hover { background: #e9ecef; transform: translateX(5px); }
    .btn-option:disabled { opacity: 0.7; cursor: not-allowed; }

    .explanation {
      margin-top: 20px;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #3949ab;
    }

    .image-preview-container {
      margin: 15px 0;
      text-align: center;
      height: 220px;
      border: 2px dashed #bbb;
      border-radius: 10px;
      overflow: hidden;
      background: #fafafa;
      position: relative;
    }
    .image-preview {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .remove-image-btn {
      position: absolute;
      top: 8px; right: 8px;
      background: #f44336;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 50%;
      cursor: pointer;
    }

    .upload-btn {
      background: #e3f2fd;
      color: #1976d2;
      padding: 16px;
      text-align: center;
      border-radius: 10px;
      border: 2px dashed #64b5f6;
      cursor: pointer;
      font-weight: bold;
      margin: 10px 0;
    }
    .upload-btn-wrapper { position: relative; display: inline-block; width: 100%; }
    .upload-btn-wrapper input[type=file] {
      position: absolute;
      left: 0; top: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer;
    }

    .question-image-container {
      margin: 20px 0;
      text-align: center;
    }
    .question-image {
      max-width: 100%;
      height: auto;
      max-height: 70vh;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }
    .action-buttons .btn { flex: 1; }

    .db-info {
      background: #e3f2fd;
      padding: 12px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
    }
    .status-indicator {
      display: inline-block;
      width: 12px; height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-connected { background: #4CAF50; }
    .status-disconnected { background: #f44336; }

    .backup-actions { display: flex; gap: 12px; margin-top: 15px; }
    .backup-actions .btn { flex: 1; }

    canvas { max-width: 100%; }

    @media (max-width: 600px) {
      .section { margin: 15px; padding: 15px; }
      .action-buttons, .backup-actions { flex-direction: column; }
      .btn-option { font-size: 18px; padding: 18px; }
      textarea, input, select { font-size: 17px; }
    }
  </style>
</head>
<body>

<header>
  <div>ЁЯУЪ рдкреНрд░рд╢реНрдиреЛрддреНрддрд░реА рдРрдк</div>
  <div>рдЕрдм JSON рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдкреНрд░рд╢реНрди рдЖрдпрд╛рдд рдХрд░реЗрдВ тАв рдкреВрд░реА рддрд░рд╣ рдСрдлрд╝рд▓рд╛рдЗрди</div>
</header>

<h2 id="pageTitle" style="text-align:center; color:#3949ab; margin:20px 0;"></h2>

<!-- ==================== INPUT SECTION ==================== -->
<div id="inputSection" class="section" style="display:none;">
  <h3>тЮХ рдирдпрд╛ рдкреНрд░рд╢реНрди рдЬреЛрдбрд╝реЗрдВ</h3>

  <textarea id="question" placeholder="рдкреНрд░рд╢реНрди рд▓рд┐рдЦреЗрдВ (рдкрд╣рд▓реА рд▓рд╛рдЗрди рдмреЛрд▓реНрдб рд╣реЛрдЧреА)"></textarea>

  <div class="upload-btn-wrapper">
    <div class="upload-btn">ЁЯУ╖ рдкреНрд░рд╢реНрди рдХреЗ рд▓рд┐рдП рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ)</div>
    <input type="file" id="imageUpload" accept="image/*">
  </div>
  <div class="image-preview-container">
    <img id="imagePreview" class="image-preview" style="display:none;">
    <button id="removeImageBtn" class="remove-image-btn" style="display:none;">тЬХ</button>
  </div>

  <input id="optA" placeholder="рд╡рд┐рдХрд▓реНрдк A">
  <input id="optB" placeholder="рд╡рд┐рдХрд▓реНрдк B">
  <input id="optC" placeholder="рд╡рд┐рдХрд▓реНрдк C">
  <input id="optD" placeholder="рд╡рд┐рдХрд▓реНрдк D">
  <select id="correct">
    <option value="A">A (рд╕рд╣реА)</option>
    <option value="B">B (рд╕рд╣реА)</option>
    <option value="C">C (рд╕рд╣реА)</option>
    <option value="D">D (рд╕рд╣реА)</option>
  </select>

  <textarea id="explanation" placeholder="рд╡реНрдпрд╛рдЦреНрдпрд╛ рд▓рд┐рдЦреЗрдВ"></textarea>

  <div class="upload-btn-wrapper">
    <div class="upload-btn">ЁЯУ╖ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХреЗ рд▓рд┐рдП рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ)</div>
    <input type="file" id="explanationImageUpload" accept="image/*">
  </div>
  <div class="image-preview-container">
    <img id="explanationImagePreview" class="image-preview" style="display:none;">
    <button id="removeExplanationImageBtn" class="remove-image-btn" style="display:none;">тЬХ</button>
  </div>

  <div class="action-buttons">
    <button class="btn" onclick="saveQuestion()">ЁЯТ╛ рд╕рд╣реЗрдЬреЗрдВ</button>
    <button class="btn delete-btn" onclick="clearForm()">ЁЯЧСя╕П рд╕рд╛рдлрд╝ рдХрд░реЗрдВ</button>
  </div>

  <div class="db-info">
    <div><span class="status-indicator status-connected" id="dbStatus"></span>IndexedDB рдХрдиреЗрдХреНрдЯреЗрдб</div>
    <div id="storageInfo">рд▓реЛрдб рд╣реЛ рд░рд╣рд╛...</div>
  </div>

  <div id="questionCount" style="font-size:18px; font-weight:bold; margin:20px 0; text-align:center;"></div>
  <div id="questionList"></div>

  <!-- JSON Import/Export -->
  <div style="margin-top:40px; padding-top:20px; border-top:2px solid #eee;">
    <h3 style="text-align:center;">ЁЯУе JSON рдмреИрдХрдЕрдк & рдЖрдпрд╛рдд</h3>
    <div class="upload-btn-wrapper">
      <div class="upload-btn">ЁЯУБ JSON рдлрд╝рд╛рдЗрд▓ рдЪреБрдиреЗрдВ</div>
      <input type="file" id="jsonImportFile" accept=".json">
    </div>
    <div class="backup-actions">
      <button class="btn" onclick="importJSONData()">тмЖя╕П рдЖрдпрд╛рдд рдХрд░реЗрдВ</button>
      <button class="btn submit-btn" onclick="exportJSONData()">тмЗя╕П рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдВ</button>
    </div>
  </div>
</div>

<!-- ==================== PRACTICE SECTION ==================== -->
<div id="practiceSection" class="section" style="display:none;">
  <h3>ЁЯОп рдЕрднреНрдпрд╛рд╕ рд╢реБрд░реВ рдХрд░реЗрдВ</h3>
  <div id="progress" style="text-align:center; font-size:20px; font-weight:bold; margin:20px 0;"></div>

  <div style="display:flex; gap:10px; margin-bottom:20px;">
    <input id="gotoInput" type="number" placeholder="рдкреНрд░рд╢реНрди рд╕рдВрдЦреНрдпрд╛" style="flex:1;">
    <button class="btn" onclick="goToQuestion()">ЁЯФН рдЬрд╛рдПрдВ</button>
  </div>

  <div id="quizQuestionContainer"></div>
  <div id="quizOptions" style="margin-top:20px;"></div>
</div>

<!-- ==================== RESULT SECTION ==================== -->
<div id="resultSection" class="section" style="display:none; text-align:center;">
  <h3>ЁЯУК рдЖрдкрдХреЗ рдкрд░рд┐рдгрд╛рдо</h3>
  <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:30px; align-items:center;">
    <div>
      <canvas id="resultChart" width="250" height="250"></canvas>
      <div style="font-size:36px; font-weight:bold; color:#3949ab; margin-top:10px;">
        <span id="bigAccuracy">0%</span>
      </div>
    </div>
    <div style="text-align:left;">
      <p><strong>рдХреБрд▓ рдкреНрд░рд╢реНрди:</strong> <span id="totalQuestions">0</span></p>
      <p><strong>рд╕рд╣реА рдЙрддреНрддрд░:</strong> <span id="correctAnswers">0</span></p>
      <p><strong>рдЧрд▓рдд рдЙрддреНрддрд░:</strong> <span id="incorrectAnswers">0</span></p>
      <p><strong>рд╕рдЯреАрдХрддрд╛:</strong> <span id="accuracyPercent">0%</span></p>
    </div>
  </div>
  <div class="action-buttons" style="margin-top:30px;">
    <button class="btn submit-btn" onclick="resetQuiz()">ЁЯФД рдирдпрд╛ рдЯреЗрд╕реНрдЯ</button>
    <button class="btn" onclick="showInputSection()">тЬПя╕П рдкреНрд░рд╢реНрди рдЬреЛрдбрд╝реЗрдВ</button>
  </div>
</div>

<script>
const DB_NAME = 'QuizAppDB', DB_VERSION = 2, STORE_NAME = 'quizzes';
let db, questions = [], currentQuestion = 0, correctCount = 0, incorrectCount = 0, editIndex = -1;
let currentImage = null, currentExplanationImage = null;

function openDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onsuccess = e => { db = e.target.result; document.getElementById('dbStatus').className = 'status-indicator status-connected'; res(db); };
    req.onerror = () => rej(req.error);
    req.onupgradeneeded = e => { db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, {keyPath:'id'}); };
  });
}

async function loadQuizFromDB(id) {
  await openDB();
  return new Promise(res => {
    const tx = db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).get(id);
    tx.onsuccess = () => res(tx.result ? tx.result.questions : []);
  });
}

async function saveQuizToDB(id, qns) {
  await openDB();
  return new Promise(res => {
    const tx = db.transaction(STORE_NAME, 'readwrite').objectStore(STORE_NAME).put({id, questions: qns, lastUpdated: new Date()});
    tx.onsuccess = () => { updateStorageUsage(); res(); };
  });
}

function updateStorageUsage() {
  if (navigator.storage?.estimate) {
    navigator.storage.estimate().then(e => {
      document.getElementById('storageInfo').textContent = `рдЙрдкрдпреЛрдЧ: ${(e.usage/1024/1024).toFixed(2)} MB`;
    });
  }
}

// рдЗрдореЗрдЬ рд╣реИрдВрдбрд▓рд░
document.getElementById('imageUpload').onchange = e => handleImage(e, 'imagePreview', 'removeImageBtn', v => currentImage = v);
document.getElementById('explanationImageUpload').onchange = e => handleImage(e, 'explanationImagePreview', 'removeExplanationImageBtn', v => currentExplanationImage = v);

function handleImage(event, previewId, btnId, setter) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    setter(ev.target.result);
    document.getElementById(previewId).src = ev.target.result;
    document.getElementById(previewId).style.display = 'block';
    document.getElementById(btnId).style.display = 'block';
  };
  reader.readAsDataURL(file);
}

document.getElementById('removeImageBtn').onclick = () => removeImage('imagePreview', 'removeImageBtn', () => currentImage = null, 'imageUpload');
document.getElementById('removeExplanationImageBtn').onclick = () => removeImage('explanationImagePreview', 'removeExplanationImageBtn', () => currentExplanationImage = null, 'explanationImageUpload');

function removeImage(previewId, btnId, setter, inputId) {
  setter();
  document.getElementById(previewId).src = '';
  document.getElementById(previewId).style.display = 'none';
  document.getElementById(btnId).style.display = 'none';
  document.getElementById(inputId).value = '';
}

function clearForm() {
  ['question','optA','optB','optC','optD','explanation'].forEach(id => document.getElementById(id).value = '');
  document.getElementById('correct').value = 'A';
  removeImage('imagePreview', 'removeImageBtn', () => currentImage = null, 'imageUpload');
  removeImage('explanationImagePreview', 'removeExplanationImageBtn', () => currentExplanationImage = null, 'explanationImageUpload');
  editIndex = -1;
}

async function saveQuestion() {
  const q = document.getElementById('question').value.trim();
  const opts = ['A','B','C','D'].map(l => document.getElementById('opt'+l).value.trim());
  const correct = document.getElementById('correct').value;
  const exp = document.getElementById('explanation').value.trim();
  if (!q || opts.some(o=>!o)) return alert('рд╕рднреА рдлрд╝реАрд▓реНрдб рднрд░реЗрдВ');

  const newQ = { question: q, options: {A:opts[0],B:opts[1],C:opts[2],D:opts[3]}, correct, explanation: exp, image: currentImage, explanationImage: currentExplanationImage };
  if (editIndex >= 0) { questions[editIndex] = newQ; editIndex = -1; alert('рдкреНрд░рд╢реНрди рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛'); }
  else { questions.push(newQ); alert('рдирдпрд╛ рдкреНрд░рд╢реНрди рдЬреЛрдбрд╝рд╛'); }

  const key = `quiz_${localStorage.getItem('selectedMain')}_${localStorage.getItem('selectedSub')}`;
  await saveQuizToDB(key, questions);
  document.getElementById('questionCount').textContent = `рдХреБрд▓ рдкреНрд░рд╢реНрди: ${questions.length}`;
  showAllQuestions();
  clearForm();
}

function formatQuestionText(t) {
  const lines = t.split('\n');
  return `<strong>${lines[0]}</strong>` + lines.slice(1).map(l => l ? `<div class="statement">${l}</div>` : '').join('');
}

function showAllQuestions() {
  const div = document.getElementById('questionList');
  div.innerHTML = questions.length === 0 ? '<p style="text-align:center;color:#999;">рдХреЛрдИ рдкреНрд░рд╢реНрди рдирд╣реАрдВ</p>' : '';
  questions.forEach((q,i) => {
    const el = document.createElement('div');
    el.className = 'question-item';
    el.style = 'padding:15px 0; border-bottom:1px solid #eee; position:relative;';
    el.innerHTML = `
      <button onclick="editQuestion(${i})" style="position:absolute;top:5px;right:50px;background:#FFC107;padding:5px 8px;border:none;border-radius:4px;cursor:pointer;">тЬПя╕П</button>
      <button onclick="deleteQuestion(${i})" style="position:absolute;top:5px;right:10px;background:#f44336;color:white;padding:5px 8px;border:none;border-radius:4px;cursor:pointer;">ЁЯЧСя╕П</button>
      <div style="font-weight:bold; padding-right:90px;">Q${i+1}: ${formatQuestionText(q.question)}</div>
      ${q.image ? '<small>ЁЯУ╖ рдкреНрд░рд╢реНрди рдЗрдореЗрдЬ</small><br>' : ''}
      ${q.explanationImage ? '<small>ЁЯУ╖ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдЗрдореЗрдЬ</small>' : ''}
    `;
    div.appendChild(el);
  });
}

function editQuestion(i) {
  const q = questions[i];
  document.getElementById('question').value = q.question;
  ['A','B','C','D'].forEach(l => document.getElementById('opt'+l).value = q.options[l]);
  document.getElementById('correct').value = q.correct;
  document.getElementById('explanation').value = q.explanation || '';
  currentImage = q.image || null; currentExplanationImage = q.explanationImage || null;
  ['imagePreview','explanationImagePreview'].forEach(id => {
    const img = document.getElementById(id);
    const btn = document.getElementById(id.replace('Preview','')+'Btn');
    if ((id === 'imagePreview' ? currentImage : currentExplanationImage)) {
      img.src = (id === 'imagePreview' ? currentImage : currentExplanationImage);
      img.style.display = 'block'; btn.style.display = 'block';
    } else { img.style.display = 'none'; btn.style.display = 'none'; }
  });
  editIndex = i;
  showInputSection();
  window.scrollTo(0,0);
}

async function deleteQuestion(i) {
  if (!confirm('рдпрд╣ рдкреНрд░рд╢реНрди рд╣рдореЗрд╢рд╛ рдХреЗ рд▓рд┐рдП рд╣рдЯ рдЬрд╛рдПрдЧрд╛!')) return;
  questions.splice(i,1);
  const key = `quiz_${localStorage.getItem('selectedMain')}_${localStorage.getItem('selectedSub')}`;
  await saveQuizToDB(key, questions);
  showAllQuestions();
  document.getElementById('questionCount').textContent = `рдХреБрд▓ рдкреНрд░рд╢реНрди: ${questions.length}`;
}

function showQuestion() {
  const q = questions[currentQuestion];
  let imgHTML = q.image ? `<div class="question-image-container"><img src="${q.image}" class="question-image" alt="рдкреНрд░рд╢реНрди рдЫрд╡рд┐"></div>` : '';
  document.getElementById('quizQuestionContainer').innerHTML = `
    <div class="question-container" style="padding:20px; background:white; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);">
      <div style="font-size:18px; font-weight:bold; margin-bottom:15px;">
        рдкреНрд░рд╢реНрди ${currentQuestion+1}/${questions.length}: ${formatQuestionText(q.question)}
      </div>
      ${imgHTML}
    </div>`;
  document.getElementById('progress').textContent = `рдкреНрд░рд╢реНрди ${currentQuestion+1} / ${questions.length}`;

  const optsDiv = document.getElementById('quizOptions');
  optsDiv.innerHTML = '';
  for (const k in q.options) {
    const btn = document.createElement('button');
    btn.className = 'btn-option';
    btn.textContent = `${k}: ${q.options[k]}`;
    btn.onclick = () => handleAnswer(k);
    optsDiv.appendChild(btn);
  }
}

function handleAnswer(selected) {
  const q = questions[currentQuestion];
  document.querySelectorAll('.btn-option').forEach(b => b.disabled = true);
  document.querySelectorAll('.btn-option').forEach(b => {
    const key = b.textContent[0];
    if (key === q.correct) b.style.background = '#4CAF50', b.style.color = 'white';
    else if (key === selected) b.style.background = '#f44336', b.style.color = 'white';
  });

  if (selected === q.correct) correctCount++; else incorrectCount++;

  const expDiv = document.createElement('div');
  expDiv.className = 'explanation';
  let expHTML = `<strong>рд╡реНрдпрд╛рдЦреНрдпрд╛:</strong><br>${(q.explanation || 'рдХреЛрдИ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдирд╣реАрдВ').replace(/\n/g,'<br>')}`;
  if (q.explanationImage) expHTML += `<div class="question-image-container"><img src="${q.explanationImage}" class="question-image" alt="рд╡реНрдпрд╛рдЦреНрдпрд╛"></div>`;
  expDiv.innerHTML = expHTML;
  document.getElementById('quizOptions').appendChild(expDiv);

  const nextBtn = document.createElement('button');
  nextBtn.className = 'btn submit-btn';
  nextBtn.style.marginTop = '20px';
  nextBtn.textContent = currentQuestion < questions.length-1 ? 'рдЕрдЧрд▓рд╛ рдкреНрд░рд╢реНрди тЖТ' : 'рдкрд░рд┐рдгрд╛рдо рджреЗрдЦреЗрдВ';
  nextBtn.onclick = () => currentQuestion < questions.length-1 ? (currentQuestion++, showQuestion()) : submitQuiz();
  document.getElementById('quizOptions').appendChild(nextBtn);
}

function goToQuestion() {
  const n = parseInt(document.getElementById('gotoInput').value);
  if (n >= 1 && n <= questions.length) { currentQuestion = n-1; showQuestion(); }
  else alert('рдЧрд▓рдд рдирдВрдмрд░');
}

function submitQuiz() {
  const attempted = correctCount + incorrectCount;
  const accuracy = attempted ? Math.round((correctCount / attempted) * 100) : 0;
  ['totalQuestions','correctAnswers','incorrectAnswers'].forEach(id => document.getElementById(id).textContent = eval(id.replace(/([a-z])([A-Z])/g,'$1').toLowerCase()));
  document.getElementById('accuracyPercent').textContent = document.getElementById('bigAccuracy').textContent = accuracy + '%';

  new Chart(document.getElementById('resultChart'), {
    type: 'doughnut',
    data: { labels: ['рд╕рд╣реА','рдЧрд▓рдд'], datasets: [{ data: [correctCount, incorrectCount], backgroundColor: ['#4CAF50','#f44336'] }] },
    options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
  });

  document.getElementById('practiceSection').style.display = 'none';
  document.getElementById('resultSection').style.display = 'block';
}

function showInputSection() {
  document.getElementById('resultSection').style.display = 'none';
  document.getElementById('practiceSection').style.display = 'none';
  document.getElementById('inputSection').style.display = 'block';
  document.getElementById('pageTitle').textContent = 'рдкреНрд░рд╢реНрди рдЬреЛрдбрд╝реЗрдВ / рд╕рдВрдкрд╛рджрд┐рдд рдХрд░реЗрдВ';
}

function resetQuiz() {
  currentQuestion = correctCount = incorrectCount = 0;
  document.getElementById('resultSection').style.display = 'none';
  document.getElementById('practiceSection').style.display = 'block';
  showQuestion();
}

async function populateQuiz() {
  const main = localStorage.getItem('selectedMain') || 'demo';
  const sub = localStorage.getItem('selectedSub') || 'demo';
  const mode = localStorage.getItem('quizMode') || 'practice';
  const key = `quiz_${main}_${sub}`;
  questions = await loadQuizFromDB(key);

  document.getElementById('pageTitle').textContent = mode === 'input' ? 'рдкреНрд░рд╢реНрди рдЬреЛрдбрд╝реЗрдВ' : 'рдЕрднреНрдпрд╛рд╕';
  document.getElementById('inputSection').style.display = mode === 'input' ? 'block' : 'none';
  document.getElementById('practiceSection').style.display = mode === 'input' ? 'none' : 'block';

  if (mode === 'input') {
    document.getElementById('questionCount').textContent = `рдХреБрд▓ рдкреНрд░рд╢реНрди: ${questions.length}`;
    showAllQuestions();
  } else {
    if (questions.length === 0) { alert('рдХреЛрдИ рдкреНрд░рд╢реНрди рдирд╣реАрдВ'); showInputSection(); }
    else showQuestion();
  }
}

async function importJSONData() {
  const file = document.getElementById('jsonImportFile').files[0];
  if (!file) return alert('рдлрд╝рд╛рдЗрд▓ рдЪреБрдиреЗрдВ');
  const text = await file.text();
  let data;
  try { data = JSON.parse(text); } catch { return alert('рдЧрд▓рдд JSON'); }
  if (!data.questions || !Array.isArray(data.questions)) return alert('рдЧрд▓рдд рдлреЙрд░реНрдореЗрдЯ');

  if (!confirm(`${data.questions.length} рдкреНрд░рд╢реНрди рдЖрдпрд╛рдд рдХрд░реЗрдВ?`)) return;

  const key = `quiz_${localStorage.getItem('selectedMain')}_${localStorage.getItem('selectedSub')}`;
  const existing = await loadQuizFromDB(key);
  questions = [...existing, ...data.questions];
  await saveQuizToDB(key, questions);
  document.getElementById('questionCount').textContent = `рдХреБрд▓ рдкреНрд░рд╢реНрди: ${questions.length}`;
  showAllQuestions();
  alert('рдЖрдпрд╛рдд рд╕рдлрд▓!');
}

async function exportJSONData() {
  const data = {
    subject: localStorage.getItem('selectedMain'),
    subtopic: localStorage.getItem('selectedSub'),
    questions,
    exportedAt: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `quiz_${localStorage.getItem('selectedMain')}_${localStorage.getItem('selectedSub')}_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  alert('рдирд┐рд░реНрдпрд╛рдд рд╕рдлрд▓!');
}

window.onload = async () => {
  if (!localStorage.getItem('selectedMain')) {
    localStorage.setItem('selectedMain', 'demo');
    localStorage.setItem('selectedSub', 'demo');
  }
  await populateQuiz();
  setTimeout(updateStorageUsage, 3000);
};
</script>
</body>
</html>
