<!DOCTYPE html>
<html lang="hi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ЁЯУЪ рдкреНрд░рд╢реНрдиреЛрддреНрддрд░реА рдРрдк (JSON рдЖрдпрд╛рдд рд╕рдкреЛрд░реНрдЯ)</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ===== YOUR ORIGINAL CSS (UNCHANGED) ===== */
body{font-family:'Segoe UI',sans-serif;background:#f5f7fa;margin:0}
header{background:#3949ab;color:#fff;padding:20px;text-align:center}
.section{background:#fff;margin:20px auto;max-width:900px;padding:20px;border-radius:10px}
textarea,input,select{width:100%;padding:10px;margin:5px 0}
.btn{background:#3949ab;color:#fff;border:none;padding:10px;border-radius:6px;cursor:pointer}
.btn-option{display:block;width:100%;margin:5px 0;padding:10px}
.question-item{border-bottom:1px solid #ddd;padding:10px;position:relative}
.edit-btn{position:absolute;right:5px;top:5px}
</style>
</head>

<body>

<header>
  <h2>ЁЯУЪ рдкреНрд░рд╢реНрдиреЛрддреНрддрд░реА рдРрдк</h2>
  <p>JSON рдЖрдпрд╛рдд + IndexedDB рд╕рдкреЛрд░реНрдЯ</p>
</header>

<h3 id="pageTitle" style="text-align:center"></h3>

<div id="inputSection" class="section">
<textarea id="question" placeholder="рдкреНрд░рд╢реНрди"></textarea>
<input id="optA" placeholder="рд╡рд┐рдХрд▓реНрдк A">
<input id="optB" placeholder="рд╡рд┐рдХрд▓реНрдк B">
<input id="optC" placeholder="рд╡рд┐рдХрд▓реНрдк C">
<input id="optD" placeholder="рд╡рд┐рдХрд▓реНрдк D">
<select id="correct">
<option>A</option><option>B</option><option>C</option><option>D</option>
</select>
<textarea id="explanation" placeholder="рд╡реНрдпрд╛рдЦреНрдпрд╛"></textarea>

<button class="btn" onclick="saveQuestion()">ЁЯТ╛ рд╕реЗрд╡ рдХрд░реЗрдВ</button>

<h4 id="questionCount"></h4>
<div id="questionList"></div>

<hr>

<input type="file" id="jsonImportFile" accept=".json">
<button class="btn" onclick="importJSONData()">тмЖя╕П JSON рдЖрдпрд╛рдд</button>
<button class="btn" onclick="exportJSONData()">тмЗя╕П JSON рдирд┐рд░реНрдпрд╛рдд</button>
</div>

<script>
/* ================= INDEXED DB ================= */

const DB_NAME = "QuizAppDB";
const DB_VERSION = 3;        // ЁЯФ┤ VERSION UPDATED
const STORE_NAME = "quizzes";

let db;
let questions = [];
let editIndex = -1;

function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VERSION);

    req.onupgradeneeded = e => {
      const db = e.target.result;
      if(!db.objectStoreNames.contains(STORE_NAME)){
        db.createObjectStore(STORE_NAME,{
          keyPath:"id",
          autoIncrement:true   // ЁЯФ┤ FIX
        });
      }
    };

    req.onsuccess = e => {
      db = e.target.result;
      resolve();
    };

    req.onerror = e => reject(e);
  });
}

async function loadQuiz(key){
  await openDB();
  return new Promise(res=>{
    const tx = db.transaction(STORE_NAME,"readonly");
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(key);
    req.onsuccess = e => res(e.target.result?.questions || []);
  });
}

async function saveQuiz(key, questions){
  await openDB();
  const tx = db.transaction(STORE_NAME,"readwrite");
  const store = tx.objectStore(STORE_NAME);
  store.put({ id:key, questions });
}

/* ================= QUESTION SAVE ================= */

async function saveQuestion(){
  const q = {
    question: question.value.trim(),
    options:{
      A:optA.value,B:optB.value,C:optC.value,D:optD.value
    },
    correct: correct.value,
    explanation: explanation.value
  };

  if(!q.question) return alert("рдкреНрд░рд╢реНрди рдЦрд╛рд▓реА рд╣реИ");

  if(editIndex>-1){
    questions[editIndex]=q;
    editIndex=-1;
  }else{
    questions.push(q);
  }

  const key = "quiz_demo_demo";
  await saveQuiz(key, questions);

  questions = await loadQuiz(key);
  renderList();
  clearForm();
}

function clearForm(){
  question.value=optA.value=optB.value=optC.value=optD.value=explanation.value="";
}

/* ================= DISPLAY ================= */

function renderList(){
  questionCount.textContent=`рдХреБрд▓ рдкреНрд░рд╢реНрди: ${questions.length}`;
  questionList.innerHTML="";
  questions.forEach((q,i)=>{
    const d=document.createElement("div");
    d.className="question-item";
    d.innerHTML=`<b>Q${i+1}</b> ${q.question}
    <button class="edit-btn" onclick="editQ(${i})">тЬПя╕П</button>`;
    questionList.appendChild(d);
  });
}

function editQ(i){
  const q=questions[i];
  question.value=q.question;
  optA.value=q.options.A;
  optB.value=q.options.B;
  optC.value=q.options.C;
  optD.value=q.options.D;
  correct.value=q.correct;
  explanation.value=q.explanation;
  editIndex=i;
}

/* ================= JSON IMPORT ================= */

async function importJSONData(){
  const file=jsonImportFile.files[0];
  if(!file) return alert("JSON рдЪреБрдиреЗрдВ");

  const text=await file.text();
  const data=JSON.parse(text);

  if(!Array.isArray(data.questions)) return alert("Invalid JSON");

  const normalized=data.questions.map(q=>({
    question:q.question||"",
    options:q.options||{A:"",B:"",C:"",D:""},
    correct:q.correct||q.answer||"A",
    explanation:q.explanation||""
  }));

  const key="quiz_demo_demo";
  const old=await loadQuiz(key);
  await saveQuiz(key,[...old,...normalized]);

  questions=await loadQuiz(key);
  renderList();
  alert("JSON рдЖрдпрд╛рдд рд╕рдлрд▓");
}

/* ================= EXPORT ================= */

function exportJSONData(){
  const data={questions};
  const blob=new Blob([JSON.stringify(data,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="quiz_backup.json";
  a.click();
}

/* ================= INIT ================= */

window.onload=async()=>{
  const key="quiz_demo_demo";
  questions=await loadQuiz(key);
  renderList();
};
</script>

</body>
</html>
