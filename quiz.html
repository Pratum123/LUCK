<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ЁЯУЪ рдкреНрд░рд╢реНрдиреЛрддреНрддрд░реА рдРрдк (JSON рдЖрдпрд╛рдд рд╕рдкреЛрд░реНрдЯ)</title>
  <style>
    body { font-family:'Segoe UI',sans-serif; background:linear-gradient(135deg,#f5f7fa,#e4e7f0); margin:0; padding:0; color:#333;}
    header { background:linear-gradient(135deg,#3949ab,#283593); color:white; padding:20px; font-size:24px; text-align:center; box-shadow:0 4px 6px rgba(0,0,0,0.1); position:relative;}
    .section { background:white; padding:25px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); max-width:850px; margin:30px auto; transition:all 0.3s ease; }
    textarea,input,select { width:100%; padding:12px; margin:8px 0; border-radius:8px; border:1px solid #ddd; font-size:16px; box-sizing:border-box; }
    .btn { background:linear-gradient(135deg,#3949ab,#5c6bc0); color:white; font-weight:bold; border:none; padding:12px 20px; border-radius:8px; font-size:16px; cursor:pointer; margin-top:10px; display:inline-block; }
    .btn:hover { transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,0.15); }
    .btn-option { display:block; width:100%; text-align:left; padding:12px 15px; border-radius:8px; background:#f8f9fa; border:1px solid #e0e0e0; margin:8px 0; font-size:16px; cursor:pointer; transition:all 0.2s; }
    .btn-option:hover { background:#e9ecef; transform:translateX(5px); }
    .explanation { margin-top:20px; padding-top:15px; border-top:1px solid #eee; color:#555; line-height:1.5; background:#f9f9f9; border-radius:8px; padding:15px; }
    .question-container { position:relative; padding:15px; background:#fff; border-radius:8px; margin-bottom:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); border-left:4px solid #3949ab; }
    .question-text { font-weight:bold; margin-bottom:10px; color:#2c3e50; }
    .statement { font-weight:normal; color:#555; margin:5px 0; line-height:1.4; padding-left:15px; border-left:2px solid #e0e0e0; }
    .image-preview-container, .question-image-container { margin:15px 0; text-align:center; width:100%; height:200px; border:1px dashed #ddd; border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; background:#fafafa;}
    .image-preview, .question-image { max-width:100%; max-height:100%; object-fit:contain; }
    .remove-image-btn { background:#f44336; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer; margin-top:5px; font-size:12px; }
    .upload-btn-wrapper { position:relative; overflow:hidden; display:inline-block; width:100%; }
    .upload-btn { background:#e3f2fd; color:#1976d2; border:1px dashed #64b5f6; padding:12px; border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer; text-align:center; margin:10px 0; display:block; transition:all 0.3s; }
    .upload-btn:hover { background:#bbdefb; }
    .upload-btn-wrapper input[type=file] { position:absolute; left:0; top:0; opacity:0; width:100%; height:100%; cursor:pointer; }
    .action-buttons { display:flex; gap:10px; margin-top:15px; }
    .action-buttons .btn { flex:1; }
    .db-info { background:#e3f2fd; padding:10px 15px; border-radius:8px; margin:15px 0; font-size:14px; display:flex; justify-content:space-between; align-items:center; }
    .status-indicator { display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:8px; }
    .status-connected { background:#4CAF50; }
    .status-disconnected { background:#f44336; }
    .backup-section { margin-top:30px; padding-top:20px; border-top:1px solid #eee; }
    .backup-title { text-align:center; color:#3949ab; margin-bottom:15px; }
    .backup-actions { display:flex; gap:10px; margin-top:15px; }
    .backup-actions .btn { flex:1; }
    @media (max-width:600px) {
      .action-buttons, .backup-actions { flex-direction:column; }
      .question-image-container { height:30vh; max-height:250px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <div>ЁЯУЪ рдкреНрд░рд╢реНрдиреЛрддреНрддрд░реА рдРрдк (JSON рдЖрдпрд╛рдд рд╕рдкреЛрд░реНрдЯ)</div>
  <div style="font-size:16px; margin-top:10px;">рдЕрдм JSON рдлрд╝рд╛рдЗрд▓реЛрдВ рд╕реЗ рдкреНрд░рд╢реНрди рдЖрдпрд╛рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ</div>
</header>
<h2 id="pageTitle" style="text-align:center; color:#3949ab;"></h2>

<div id="inputSection" class="section" style="display:none;">
  <h3>тЮХ рдирдпрд╛ рдкреНрд░рд╢реНрди рдЬреЛрдбрд╝реЗрдВ</h3>
  <textarea id="question" placeholder="рдкреНрд░рд╢реНрди рд▓рд┐рдЦреЗрдВ (рдмреЛрд▓реНрдб рджрд┐рдЦреЗрдЧрд╛)"></textarea>

  <div class="upload-btn-wrapper">
    <div class="upload-btn"><span>ЁЯУ╖ рдкреНрд░рд╢реНрди рдХреЗ рд▓рд┐рдП рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ)</span></div>
    <input type="file" id="imageUpload" accept="image/*">
  </div>
  <div class="image-preview-container">
    <img id="imagePreview" class="image-preview" alt="рдкреНрд░рд╢реНрди рдЫрд╡рд┐ рдкреВрд░реНрд╡рд╛рд╡рд▓реЛрдХрди" style="display:none;">
    <button id="removeImageBtn" class="remove-image-btn" style="display:none;">тЭМ рдЫрд╡рд┐ рд╣рдЯрд╛рдПрдВ</button>
  </div>

  <input id="optA" placeholder="рд╡рд┐рдХрд▓реНрдк A">
  <input id="optB" placeholder="рд╡рд┐рдХрд▓реНрдк B">
  <input id="optC" placeholder="рд╡рд┐рдХрд▓реНрдк C">
  <input id="optD" placeholder="рд╡рд┐рдХрд▓реНрдк D">
  <select id="correct">
    <option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option>
  </select>
  <textarea id="explanation" placeholder="рд╡реНрдпрд╛рдЦреНрдпрд╛ рд▓рд┐рдЦреЗрдВ (рд╕рд╛рдорд╛рдиреНрдп рдЯреЗрдХреНрд╕реНрдЯ)"></textarea>

  <div class="upload-btn-wrapper">
    <div class="upload-btn"><span>ЁЯУ╖ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХреЗ рд▓рд┐рдП рдЫрд╡рд┐ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ (рд╡реИрдХрд▓реНрдкрд┐рдХ)</span></div>
    <input type="file" id="explanationImageUpload" accept="image/*">
  </div>
  <div class="image-preview-container">
    <img id="explanationImagePreview" class="image-preview" alt="рд╡реНрдпрд╛рдЦреНрдпрд╛ рдЫрд╡рд┐ рдкреВрд░реНрд╡рд╛рд╡рд▓реЛрдХрди" style="display:none;">
    <button id="removeExplanationImageBtn" class="remove-image-btn" style="display:none;">тЭМ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдЫрд╡рд┐ рд╣рдЯрд╛рдПрдВ</button>
  </div>

  <div class="action-buttons">
    <button class="btn" onclick="saveQuestion()">ЁЯТ╛ рд╕реЗрд╡ рдХрд░реЗрдВ</button>
    <button class="btn delete-btn" onclick="clearForm()">ЁЯЧСя╕П рдлреЙрд░реНрдо рд╕рд╛рдлрд╝ рдХрд░реЗрдВ</button>
  </div>

  <div class="db-info">
    <div><span id="dbStatus" class="status-indicator status-disconnected"></span><span id="dbLabel">IndexedDB рдХрдиреЗрдХреНрдЯрд┐рдВрдЧ...</span></div>
    <div id="storageInfo">рд╕реНрдЯреЛрд░реЗрдЬ рдЙрдкрдпреЛрдЧ: рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рд╣реИ...</div>
  </div>

  <div id="questionCount"></div>
  <div id="questionList"></div>

  <div class="backup-section">
    <h3 class="backup-title">ЁЯУе JSON рдмреИрдХрдЕрдк рдФрд░ рдЖрдпрд╛рдд</h3>
    <p style="text-align:center; margin-bottom:15px;">рдирд┐рд░реНрдпрд╛рдд рдХрд┐рдП рдЧрдП JSON рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдкреНрд░рд╢реНрди рдЖрдпрд╛рдд рдХрд░реЗрдВ рдпрд╛ рд╡рд░реНрддрдорд╛рди рдбреЗрдЯрд╛ рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдВ</p>
    <div class="upload-btn-wrapper">
      <div class="upload-btn"><span id="jsonImportLabel">ЁЯУБ JSON рдлрд╝рд╛рдЗрд▓ рдЖрдпрд╛рдд рдХрд░реЗрдВ</span></div>
      <input type="file" id="jsonImportFile" accept=".json">
    </div>
    <div class="backup-actions">
      <button class="btn" onclick="importJSONData()">тмЖя╕П JSON рдЖрдпрд╛рдд рдХрд░реЗрдВ</button>
      <button class="btn" onclick="exportJSONData()">тмЗя╕П JSON рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдВ</button>
    </div>
    <div style="margin-top:15px; background:#f9f9f9; padding:15px; border-radius:8px;">
      <h4 style="margin-top:0; color:#3949ab;">JSON рдлрд╝рд╛рдЗрд▓ рдкреНрд░рд╛рд░реВрдк:</h4>
      <pre style="overflow:auto; max-height:150px; background:white; padding:10px; border-radius:4px;">
{
  "subject": "рд╡рд┐рд╖рдп рдХрд╛ рдирд╛рдо",
  "subtopic": "рдЙрдкрд╡рд┐рд╖рдп рдХрд╛ рдирд╛рдо",
  "questions": [
    {
      "question": "рдкреНрд░рд╢реНрди рдЯреЗрдХреНрд╕реНрдЯ",
      "options": { "A": "рд╡рд┐рдХрд▓реНрдк A", "B": "рд╡рд┐рдХрд▓реНрдк B", "C": "рд╡рд┐рдХрд▓реНрдк C", "D": "рд╡рд┐рдХрд▓реНрдк D" },
      "correct": "A",
      "explanation": "рд╡реНрдпрд╛рдЦреНрдпрд╛ рдЯреЗрдХреНрд╕реНрдЯ",
      "image": "base64 рдЫрд╡рд┐ рдбреЗрдЯрд╛ (рд╡реИрдХрд▓реНрдкрд┐рдХ)",
      "explanationImage": "base64 рд╡реНрдпрд╛рдЦреНрдпрд╛ рдЫрд╡рд┐ рдбреЗрдЯрд╛ (рд╡реИрдХрд▓реНрдкрд┐рдХ)"
    }
  ]
}</pre>
    </div>
  </div>
</div>

<div id="practiceSection" class="section" style="display:none;">
  <h3>ЁЯОп рдЕрднреНрдпрд╛рд╕ рд╢реБрд░реВ рдХрд░реЗрдВ</h3>
  <div id="progress" style="font-weight:bold; font-size:18px; text-align:center; margin-bottom:15px;"></div>
  <div id="gotoContainer" style="display:flex; gap:10px; margin-top:15px;">
    <input id="gotoInput" type="number" placeholder="рдкреНрд░рд╢реНрди рд╕рдВрдЦреНрдпрд╛" style="flex:1; padding:12px;">
    <button id="gotoBtn" onclick="goToQuestion()" class="btn">ЁЯФН рдЬрд╛рдПрдВ</button>
  </div>
  <div id="quizQuestionContainer" style="margin-top:20px;">
    <div id="quizQuestion" class="question-container"></div>
  </div>
  <div id="quizOptions"></div>
</div>

<div id="resultSection" class="section" style="display:none;">
  <div class="result-card">
    <h3 style="text-align:center; color:#3949ab;">ЁЯУК рдЖрдкрдХреЗ рдкрд░рд┐рдгрд╛рдо</h3>
    <div style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center; align-items:center;">
      <div style="flex:1; min-width:200px;">
        <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
          <p><strong>ЁЯУЭ рдХреБрд▓ рдкреНрд░рд╢реНрди:</strong> <span id="totalQuestions">0</span></p>
          <p><strong>тЬЕ рд╕рд╣реА рдЙрддреНрддрд░:</strong> <span id="correctAnswers">0</span></p>
          <p><strong>тЭМ рдЧрд▓рдд рдЙрддреНрддрд░:</strong> <span id="incorrectAnswers">0</span></p>
          <p><strong>ЁЯУК рд╕рдЯреАрдХрддрд╛:</strong> <span id="accuracyPercent" style="font-weight:bold; color:#3949ab;">0%</span></p>
        </div>
      </div>
      <div style="position:relative; width:250px; height:250px;">
        <canvas id="resultChart"></canvas>
        <div class="accuracy-display"><span id="bigAccuracy">0%</span><div style="font-size:14px; color:#666;">рд╕рдЯреАрдХрддрд╛</div></div>
      </div>
    </div>
    <div class="action-buttons">
      <button class="btn" onclick="resetQuiz()">ЁЯФД рдирдпрд╛ рдЯреЗрд╕реНрдЯ рд╢реБрд░реВ рдХрд░реЗрдВ</button>
      <button class="btn" onclick="showInputSection()">ЁЯУЭ рдкреНрд░рд╢реНрди рд╕рдВрдкрд╛рджрд┐рдд рдХрд░реЗрдВ</button>
    </div>
  </div>
</div>

<script>
// IndexedDB configuration - рдореБрдЦреНрдп рдлрд┐рдХреНрд╕ рдпрд╣рд╛рдБ
const DB_NAME = 'QuizAppDB';
const DB_VERSION = 3; // тЖР VersionError рдХреЛ рд╣рдореЗрд╢рд╛ рдХреЗ рд▓рд┐рдП рдЦрддреНрдо
const STORE_NAME = 'quizzes';
let db;
let questions = [];
let currentQuestion = 0;
let correctCount = 0;
let incorrectCount = 0;
let editIndex = -1;
let currentImage = null;
let currentExplanationImage = null;

function openDB() {
  return new Promise((resolve, reject) => {
    if (db) return resolve(db);
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = (event) => {
      console.error('рдбреЗрдЯрд╛рдмреЗрд╕ рддреНрд░реБрдЯрд┐:', event.target.error);
      document.getElementById('dbStatus').className = 'status-indicator status-disconnected';
      document.getElementById('dbLabel').textContent = 'IndexedDB рдХрдиреЗрдХреНрдЯ рд╡рд┐рдлрд▓';
      reject(event.target.error);
    };
    request.onsuccess = (event) => {
      db = event.target.result;
      document.getElementById('dbStatus').className = 'status-indicator status-connected';
      document.getElementById('dbLabel').textContent = 'IndexedDB рдХрдиреЗрдХреНрдЯреЗрдб';
      updateStorageUsage();
      resolve(db);
    };
    request.onupgradeneeded = (event) => {
      const dbu = event.target.result;
      console.log(`DB рдЕрдкрдЧреНрд░реЗрдб: ${event.oldVersion} тЖТ ${DB_VERSION}`);
      if (!dbu.objectStoreNames.contains(STORE_NAME)) {
        dbu.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
  });
}

async function loadQuizFromDB(quizId) {
  await openDB();
  return new Promise((resolve) => {
    const tx = db.transaction([STORE_NAME], 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(quizId);
    req.onsuccess = () => resolve(req.result ? req.result.questions : []);
  });
}

async function saveQuizToDB(quizId, questionsArr) {
  await openDB();
  return new Promise((resolve) => {
    const tx = db.transaction([STORE_NAME], 'readwrite');
    const store = tx.objectStore(STORE_NAME);
    store.put({ id: quizId, questions: questionsArr, lastUpdated: new Date() });
    tx.oncomplete = () => { updateStorageUsage(); resolve(); };
  });
}

function updateStorageUsage() {
  if (!navigator.storage?.estimate) return;
  navigator.storage.estimate().then(estimate => {
    const usedMB = (estimate.usage / (1024*1024)).toFixed(2);
    const quotaMB = (estimate.quota / (1024*1024)).toFixed(2);
    document.getElementById('storageInfo').textContent = `рд╕реНрдЯреЛрд░реЗрдЬ рдЙрдкрдпреЛрдЧ: ${usedMB} MB / ${quotaMB} MB`;
  });
}

/* Image handlers */
document.getElementById("imageUpload").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      currentImage = ev.target.result;
      document.getElementById("imagePreview").src = currentImage;
      document.getElementById("imagePreview").style.display = "block";
      document.getElementById("removeImageBtn").style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});
document.getElementById("removeImageBtn").addEventListener("click", function() {
  currentImage = null;
  document.getElementById("imagePreview").src = "";
  document.getElementById("imagePreview").style.display = "none";
  document.getElementById("removeImageBtn").style.display = "none";
  document.getElementById("imageUpload").value = "";
});
document.getElementById("explanationImageUpload").addEventListener("change", function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      currentExplanationImage = ev.target.result;
      document.getElementById("explanationImagePreview").src = currentExplanationImage;
      document.getElementById("explanationImagePreview").style.display = "block";
      document.getElementById("removeExplanationImageBtn").style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});
document.getElementById("removeExplanationImageBtn").addEventListener("click", function() {
  currentExplanationImage = null;
  document.getElementById("explanationImagePreview").src = "";
  document.getElementById("explanationImagePreview").style.display = "none";
  document.getElementById("removeExplanationImageBtn").style.display = "none";
  document.getElementById("explanationImageUpload").value = "";
});

/* Form & Question Management */
function clearForm() {
  document.getElementById("question").value = '';
  document.getElementById("optA").value = '';
  document.getElementById("optB").value = '';
  document.getElementById("optC").value = '';
  document.getElementById("optD").value = '';
  document.getElementById("explanation").value = '';
  document.getElementById("correct").value = 'A';
  currentImage = currentExplanationImage = null;
  ["imagePreview","explanationImagePreview"].forEach(id => {
    document.getElementById(id).style.display = "none";
    document.getElementById(id).src = "";
  });
  ["removeImageBtn","removeExplanationImageBtn"].forEach(id => document.getElementById(id).style.display = "none");
  ["imageUpload","explanationImageUpload"].forEach(id => document.getElementById(id).value = "");
  editIndex = -1;
}

async function saveQuestion() {
  const q = document.getElementById("question").value.trim();
  const opts = ["optA","optB","optC","optD"].map(id => document.getElementById(id).value.trim());
  const correct = document.getElementById("correct").value;
  const exp = document.getElementById("explanation").value.trim();
  if (!q || opts.some(o => !o)) { alert("тЭЧ рд╕рднреА рдлрд╝реАрд▓реНрдб рднрд░реЗрдВ!"); return; }
  const newQ = { question: q, options: {A:opts[0],B:opts[1],C:opts[2],D:opts[3]}, correct, explanation: exp, image: currentImage, explanationImage: currentExplanationImage };
  const main = localStorage.getItem("selectedMain") || "demo";
  const sub = localStorage.getItem("selectedSub") || "demo";
  const key = `quiz_${main}_${sub}`;
  if (editIndex >= 0) { questions[editIndex] = newQ; editIndex = -1; alert("тЬЕ рдкреНрд░рд╢реНрди рдЕрдкрдбреЗрдЯ рд╣реЛ рдЧрдпрд╛!"); }
  else { questions.push(newQ); alert("тЬЕ рдирдпрд╛ рдкреНрд░рд╢реНрди рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛!"); }
  await saveQuizToDB(key, questions);
  clearForm();
  document.getElementById("questionCount").textContent = `ЁЯФв рдХреБрд▓ рдкреНрд░рд╢реНрди: ${questions.length}`;
  showAllQuestions();
}

function formatQuestionText(text) {
  const parts = text.split('\n');
  let html = `<strong>${parts[0]}</strong>`;
  for (let i=1; i<parts.length; i++) if (parts[i].trim()) html += `<div class="statement">${parts[i]}</div>`;
  return html;
}

function showAllQuestions() {
  const list = document.getElementById("questionList");
  list.innerHTML = questions.length === 0 ? '<div style="text-align:center;padding:20px;color:#666;">тЭМ рдХреЛрдИ рдкреНрд░рд╢реНрди рдирд╣реАрдВ рд╣реИ</div>' : '';
  questions.forEach((q, i) => {
    const div = document.createElement("div");
    div.className = "question-item";
    div.innerHTML = `
      <div style="position:relative;">
        <button onclick="editQuestion(${i})" style="position:absolute;right:2px;top:2px;background:#FFC107;border:none;padding:2px;border-radius:4px;">тЬПя╕П</button>
        <button onclick="deleteQuestion(${i})" style="position:absolute;right:28px;top:2px;background:#f44336;border:none;padding:2px;border-radius:4px;">ЁЯЧСя╕П</button>
        <div class="question-text">Q${i+1}: ${formatQuestionText(q.question)}</div>
        ${q.image ? '<div style="font-size:12px;color:#666;margin-top:5px;">ЁЯУ╖ рдкреНрд░рд╢реНрди рдЫрд╡рд┐</div>' : ''}
        ${q.explanationImage ? '<div style="font-size:12px;color:#666;margin-top:5px;">ЁЯУ╖ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдЫрд╡рд┐</div>' : ''}
      </div>`;
    list.appendChild(div);
  });
}

function editQuestion(i) {
  const q = questions[i];
  document.getElementById("question").value = q.question;
  ["A","B","C","D"].forEach(k => document.getElementById("opt"+k).value = q.options[k]);
  document.getElementById("correct").value = q.correct;
  document.getElementById("explanation").value = q.explanation;
  currentImage = q.image || null; currentExplanationImage = q.explanationImage || null;
  ["image","explanationImage"].forEach(prefix => {
    const has = q[prefix+"Image"];
    document.getElementById(prefix+"Preview").style.display = has ? "block" : "none";
    document.getElementById(prefix+"Preview").src = has ? q[prefix+"Image"] : "";
    document.getElementById("remove"+prefix[0].toUpperCase()+prefix.slice(1)+"Btn").style.display = has ? "block" : "none";
  });
  editIndex = i;
  document.getElementById("inputSection").style.display = "block";
  document.getElementById("practiceSection").style.display = "none";
  document.getElementById("pageTitle").textContent = "тЬПя╕П рдкреНрд░рд╢реНрди рд╕рдВрдкрд╛рджрд┐рдд рдХрд░реЗрдВ";
  window.scrollTo({top:0,behavior:'smooth'});
}

async function deleteQuestion(i) {
  if (!confirm("рдХреНрдпрд╛ рдЖрдк рдЗрд╕ рдкреНрд░рд╢реНрди рдХреЛ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ?")) return;
  questions.splice(i,1);
  const key = `quiz_${localStorage.getItem("selectedMain") || "demo"}_${localStorage.getItem("selectedSub") || "demo"}`;
  await saveQuizToDB(key, questions);
  document.getElementById("questionCount").textContent = `ЁЯФв рдХреБрд▓ рдкреНрд░рд╢реНрди: ${questions.length}`;
  showAllQuestions();
}

/* Practice Mode */
function goToQuestion() {
  const n = parseInt(document.getElementById("gotoInput").value);
  if (n < 1 || n > questions.length) { alert(`1 рд╕реЗ ${questions.length} рдХреЗ рдмреАрдЪ рдирдВрдмрд░ рдбрд╛рд▓реЗрдВ`); return; }
  currentQuestion = n-1;
  showQuestion();
}

function showQuestion() {
  const q = questions[currentQuestion];
  const img = q.image ? `<div class="question-image-container"><img src="${q.image}" class="question-image"></div>` : '';
  document.getElementById("quizQuestionContainer").innerHTML = `<div class="question-container"><div class="question-text">ЁЯУШ рдкреНрд░рд╢реНрди ${currentQuestion+1}/${questions.length}: ${formatQuestionText(q.question)}</div>${img}</div>`;
  const optsDiv = document.getElementById("quizOptions");
  optsDiv.innerHTML = '';
  for (let k in q.options) {
    const btn = document.createElement("button");
    btn.className = "btn-option";
    btn.textContent = `${k}: ${q.options[k]}`;
    btn.onclick = () => handleAnswer(k);
    optsDiv.appendChild(btn);
  }
  const submit = document.createElement("button");
  submit.className = "btn submit-btn";
  submit.textContent = "тЬЕ рдХреНрд╡рд┐рдЬ рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ";
  submit.onclick = () => confirm(`рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ? (${correctCount+incorrectCount} рдЙрддреНрддрд░ рджрд┐рдП)`) && submitQuiz();
  optsDiv.appendChild(submit);
  document.getElementById("progress").textContent = `ЁЯУШ рдкреНрд░рд╢реНрди ${currentQuestion+1} / ${questions.length}`;
}

function handleAnswer(sel) {
  const q = questions[currentQuestion];
  document.querySelectorAll(".btn-option").forEach(b => b.disabled = true);
  document.querySelectorAll(".btn-option").forEach(b => {
    const k = b.textContent[0];
    if (k === q.correct) b.style = "background:#4CAF50;color:white;";
    else if (k === sel) b.style = "background:#F44336;color:white;";
  });
  const expDiv = document.createElement("div");
  expDiv.className = "explanation";
  let expHTML = `<strong>ЁЯУШ рд╡реНрдпрд╛рдЦреНрдпрд╛:</strong><br>${(q.explanation || 'рдХреЛрдИ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдирд╣реАрдВ').replace(/\n/g,'<br>')}`;
  if (q.explanationImage) expHTML += `<div class="question-image-container"><img src="${q.explanationImage}" class="question-image"></div>`;
  expDiv.innerHTML = expHTML;
  document.getElementById("quizOptions").appendChild(expDiv);
  if (sel === q.correct) correctCount++; else incorrectCount++;
  const next = document.createElement("button");
  next.className = "btn";
  next.style.marginTop = "20px";
  next.textContent = currentQuestion < questions.length-1 ? "тЮбя╕П рдЕрдЧрд▓рд╛ рдкреНрд░рд╢реНрди" : "тЬЕ рдХреНрд╡рд┐рдЬ рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ";
  next.onclick = () => { currentQuestion++; currentQuestion >= questions.length ? submitQuiz() : showQuestion(); };
  document.getElementById("quizOptions").appendChild(next);
}

function submitQuiz() {
  const acc = correctCount + incorrectCount > 0 ? Math.round((correctCount / (correctCount + incorrectCount)) * 100) : 0;
  ["totalQuestions","correctAnswers","incorrectAnswers"].forEach((id,i) => document.getElementById(id).textContent = [questions.length,correctCount,incorrectCount][i]);
  ["accuracyPercent","bigAccuracy"].forEach(id => document.getElementById(id).textContent = acc + "%");
  new Chart(document.getElementById('resultChart').getContext('2d'), {
    type:'doughnut', data:{labels:['рд╕рд╣реА','рдЧрд▓рдд'],datasets:[{data:[correctCount,incorrectCount],backgroundColor:['#4CAF50','#F44336']}]},
    options:{cutout:'65%',plugins:{legend:{position:'bottom'}}}
  });
  document.getElementById("practiceSection").style.display = "none";
  document.getElementById("resultSection").style.display = "block";
}

function showInputSection() {
  document.getElementById("resultSection").style.display = "none";
  document.getElementById("inputSection").style.display = "block";
  document.getElementById("pageTitle").textContent = "тЮХ рдкреНрд░рд╢реНрди рдЬреЛрдбрд╝реЗрдВ";
}

function resetQuiz() {
  currentQuestion = correctCount = incorrectCount = 0;
  document.getElementById("resultSection").style.display = "none";
  document.getElementById("practiceSection").style.display = "block";
  showQuestion();
}

/* Main Loader */
async function populateQuiz() {
  const main = localStorage.getItem("selectedMain") || "demo";
  const sub = localStorage.getItem("selectedSub") || "demo";
  const mode = localStorage.getItem("quizMode") || "practice";
  const key = `quiz_${main}_${sub}`;
  try {
    await openDB();
    questions = await loadQuizFromDB(key);
    if (questions.length === 0) {
      const ls = localStorage.getItem(key);
      if (ls) questions = JSON.parse(ls);
    }
    document.getElementById("pageTitle").textContent = mode === "input" ? "тЮХ рдкреНрд░рд╢реНрди рдЬреЛрдбрд╝реЗрдВ" : "ЁЯОп рдЕрднреНрдпрд╛рд╕";
    if (mode === "input") {
      document.getElementById("inputSection").style.display = "block";
      document.getElementById("questionCount").textContent = `ЁЯФв рдХреБрд▓ рдкреНрд░рд╢реНрди: ${questions.length}`;
      showAllQuestions();
    } else {
      if (questions.length === 0) { alert("тЭЧ рдХреЛрдИ рдкреНрд░рд╢реНрди рдирд╣реАрдВ рдорд┐рд▓рд╛!"); showInputSection(); }
      else { document.getElementById("practiceSection").style.display = "block"; showQuestion(); }
    }
  } catch (e) {
    console.error(e);
    alert('рдХреНрд╡рд┐рдЬ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐ред рдкреЗрдЬ рд░реАрд▓реЛрдб рдХрд░реЗрдВред');
  }
}

/* JSON Import/Export */
async function importJSONData() {
  const file = document.getElementById('jsonImportFile').files[0];
  if (!file) { alert("рдлрд╝рд╛рдЗрд▓ рдЪреБрдиреЗрдВ"); return; }
  const text = await file.text();
  try {
    const data = JSON.parse(text);
    if (!data.questions?.length) throw "рдкреНрд░рд╢реНрди рдирд╣реАрдВ рдорд┐рд▓реЗ";
    if (!confirm(`${data.questions.length} рдкреНрд░рд╢реНрди рдЖрдпрд╛рдд рдХрд░реЗрдВ?`)) return;
    const main = localStorage.getItem("selectedMain") || "demo";
    const sub = localStorage.getItem("selectedSub") || "demo";
    const key = `quiz_${main}_${sub}`;
    const existing = await loadQuizFromDB(key) || [];
    const merged = [...existing, ...data.questions];
    await saveQuizToDB(key, merged);
    questions = merged;
    document.getElementById("questionCount").textContent = `ЁЯФв рдХреБрд▓ рдкреНрд░рд╢реНрди: ${questions.length}`;
    showAllQuestions();
    alert("тЬЕ рдЖрдпрд╛рдд рд╕рдлрд▓!");
  } catch (e) { alert("тЭЧ JSON рддреНрд░реБрдЯрд┐: " + e); }
}

function exportJSONData() {
  const main = localStorage.getItem("selectedMain") || "unknown";
  const sub = localStorage.getItem("selectedSub") || "unknown";
  const data = { subject: main, subtopic: sub, questions, exportedAt: new Date().toISOString() };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `quiz_${main}_${sub}_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  alert(`ЁЯУд ${questions.length} рдкреНрд░рд╢реНрди рдирд┐рд░реНрдпрд╛рдд рдХрд┐рдП рдЧрдП`);
}

/* Init */
window.onload = async () => {
  if (!localStorage.getItem("selectedMain")) {
    localStorage.setItem("selectedMain", "demo");
    localStorage.setItem("selectedSub", "demo");
    localStorage.setItem("quizMode", "input");
  }
  await populateQuiz();
  setTimeout(updateStorageUsage, 5000);
  document.getElementById('jsonImportFile').addEventListener('change', function() {
    document.getElementById('jsonImportLabel').textContent = this.files[0] ? `рдЪрдпрдирд┐рдд: ${this.files[0].name}` : 'ЁЯУБ JSON рдлрд╝рд╛рдЗрд▓ рдЖрдпрд╛рдд рдХрд░реЗрдВ';
  });
};
</script>
</body>
</html>
