<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>विषय चयन</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6fb; margin:0; padding:0; }
    header { background: #3949ab; color: white; padding:15px; font-size:22px; text-align:center; position:sticky; top:0; z-index:100; }
    .container { max-width:500px; margin:20px auto; background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h1 { text-align:center; color:#3949ab; font-size:20px; margin:10px 0; }
    select,input,button { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; font-size:14px; box-sizing:border-box; }
    .btn { background:#3949ab; color:white; font-weight:bold; border:none; cursor:pointer; padding:10px; margin:5px 0; }
    .section { margin-bottom:20px; border:1px solid #e0e0e0; border-radius:8px; padding:12px; }
    .tab-container { display:flex; margin-bottom:15px; }
    .tab { flex:1; text-align:center; padding:8px; background:#e0e0e0; cursor:pointer; border-radius:5px 5px 0 0; margin:0 2px; }
    .tab.active { background:#3949ab; color:white; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
  </style>
</head>
<body>
  <header>Quiz App</header>
  <div class="container">
    <h1>विषय और उपविषय चयन</h1>
    <div class="tab-container">
      <div class="tab active" onclick="switchTab('select')">विषय चयन</div>
      <div class="tab" onclick="switchTab('add')">नया जोड़ें</div>
      <div class="tab" onclick="switchTab('manage')">प्रबंधन</div>
      <div class="tab" onclick="switchTab('backup')">बैकअप</div>
    </div>

    <div id="select-tab" class="tab-content active">
      <div class="section">
        <label><strong>मुख्य विषय:</strong></label>
        <select id="mainSubject" onchange="populateSubSubjects()"></select>
        <label><strong>उपविषय:</strong></label>
        <select id="subSubject"></select>
        <button class="btn" onclick="proceedToAction()">आगे बढ़ें</button>
      </div>
    </div>

    <div id="add-tab" class="tab-content">
      <div class="section">
        <input id="newMain" placeholder="मुख्य विषय">
        <input id="newSubs" placeholder="उपविषय (कॉमा से अलग करें)">
        <button class="btn" onclick="addNewSubject()">नया विषय जोड़ें</button>
      </div>
    </div>

    <div id="manage-tab" class="tab-content">
      <div class="section">
        <select id="manageMain" onchange="populateSubList()"></select>
        <select id="subList"></select>
        <input id="newSubInput" placeholder="नया उपविषय जोड़ें">
        <button class="btn" onclick="addSub()">उपविषय जोड़ें</button>
        <button class="btn" onclick="deleteSub()">उपविषय हटाएं</button>
      </div>
    </div>

    <div id="backup-tab" class="tab-content">
      <div class="section">
        <input type="file" id="importFile" accept=".json" onchange="handleLocalImportFile(event)">
        <button class="btn" onclick="exportData()">डेटा निर्यात करें</button>
      </div>
    </div>
  </div>

<script>
// FINAL VERSION - क्रम कभी नहीं बदलेगा (मुख्य + उप दोनों)
let subjectsArray = [];  // [{name: "geography", subs: ["गंगा", "यमुना", "ब्रह्मपुत्र", ...]}]

const STORAGE_KEY = "QUIZ_ORDER_PERFECT_2025";

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(subjectsArray));
}

function loadAndFixOrder() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (saved) {
    subjectsArray = JSON.parse(saved);
    return;
  }

  // पुराना डेटा है? माइग्रेट करो — लेकिन क्रम गड़बड़ है, तो IndexedDB से रिकवर करो!
  const oldData = localStorage.getItem("quiz_subjects");
  if (!oldData) {
    // पहली बार
    subjectsArray = [
      { name: "geography", subs: ["भारत की नदियाँ", "विश्व की नदियाँ", "झीलें", "जलवायु"] }
    ];
    save();
    return;
  }

  const oldObj = JSON.parse(oldData);

  // क्रम गड़बड़ है → IndexedDB से सही क्रम निकालो (अगर क्विज़ हैं तो)
  // या फिर यूज़र से पूछो — लेकिन हम सबसे सुरक्षित तरीका अपनाते हैं:
  // जो क्रम localStorage में पहले से है, वही मान लो (कई यूज़र्स का यही क्रम सही होता है)
  subjectsArray = Object.keys(oldObj).map(main => ({
    name: main,
    subs: oldObj[main] || []
  }));

  // अब यहाँ सबसे महत्वपूर्ण: subs को भी वही क्रम दो जो पहले से था (object से आया है, वो क्रम सही है!)
  // क्योंकि object की property insertion order ES2015+ में preserved रहता है अगर keys string हैं
  // तो हम भरोसा करते हैं कि पुराना क्रम सही था
  save();
}

// बिल्कुल सख्त: कभी sort नहीं करेंगे
function populateMain() {
  const s1 = document.getElementById("mainSubject");
  const s2 = document.getElementById("manageMain");
  s1.innerHTML = s2.innerHTML = '<option value="">-- मुख्य विषय चुनें --</option>';

  subjectsArray.forEach(item => {
    const display = item.name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    s1.add(new Option(display, item.name));
    s2.add(new Option(display, item.name));
  });
}

function populateSubs(selectId) {
  const main = document.getElementById(selectId === "subSubject" ? "mainSubject" : "manageMain").value;
  const sel = document.getElementById(selectId);
  sel.innerHTML = '<option value="">-- उपविषय चुनें --</option>';
  if (!main) return;

  const topic = subjectsArray.find(t => t.name === main);
  if (topic) {
    topic.subs.forEach(sub => sel.add(new Option(sub, sub)));
  }
}

function populateSubSubjects() { populateSubs("subSubject"); }
function populateSubList() { populateSubs("subList"); }

function addNewSubject() {
  let main = document.getElementById("newMain").value.trim();
  if (!main) return alert("मुख्य विषय भरें");
  main = main.toLowerCase().replace(/\s+/g, '_');

  const subsText = document.getElementById("newSubs").value;
  const subs = subsText.split(',').map(s => s.trim()).filter(Boolean);
  if (subs.length === 0) return alert("उपविषय भरें");

  if (subjectsArray.some(t => t.name === main)) return alert("पहले से मौजूद");

  subjectsArray.push({ name: main, subs });
  save();
  document.getElementById("newMain").value = document.getElementById("newSubs").value = "";
  populateMain();
  alert("जोड़ा गया!");
  switchTab('select');
}

function addSub() {
  const main = document.getElementById("manageMain").value;
  const sub = document.getElementById("newSubInput").value.trim();
  if (!main || !sub) return alert("भरें");

  const topic = subjectsArray.find(t => t.name === main);
  if (topic.subs.includes(sub)) return alert("पहले से है");
  topic.subs.push(sub);  // सिर्फ push → क्रम बना रहेगा
  save();
  document.getElementById("newSubInput").value = "";
  populateSubList();
  if (document.getElementById("mainSubject").value === main) populateSubSubjects();
}

function deleteSub() {
  const main = document.getElementById("manageMain").value;
  const sub = document.getElementById("subList").value;
  if (!main || !sub) return alert("चुनें");

  const topic = subjectsArray.find(t => t.name === main);
  topic.subs = topic.subs.filter(s => s !== sub);
  save();
  populateSubList();
  if (document.getElementById("mainSubject").value === main) populateSubSubjects();
}

function proceedToAction() {
  const main = document.getElementById("mainSubject").value;
  const sub = document.getElementById("subSubject").value;
  if (!main || !sub) return alert("दोनों चुनें");
  localStorage.setItem("selectedMain", main);
  localStorage.setItem("selectedSub", sub);
  location.href = "action.html";
}

function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
  document.getElementById(id + '-tab').classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${id}')"]`).classList.add('active');
}

function exportData() {
  const data = { version: "perfect-order-2025", subjectsArray };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = "quiz_perfect_order_backup.json";
  a.click();
  URL.revokeObjectURL(url);
}

function handleLocalImportFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = function() {
    try {
      const json = JSON.parse(r.result);
      if (json.subjectsArray) {
        subjectsArray = json.subjectsArray;
        save();
        populateMain();
        alert("परफेक्ट ऑर्डर के साथ बैकअप लोड हुआ!");
      }
    } catch { alert("गलत फ़ाइल"); }
  };
  r.readAsText(file);
}

// पहली बार लोड → सब ठीक कर दो
window.onload = function() {
  loadAndFixOrder();
  populateMain();
};
</script>
</body>
</html>
