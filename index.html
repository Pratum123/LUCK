<script>
let subjects = {};
let subjectOrder = [];
let subOrder = {}; // नया: हर main subject के sub-topics का sequence

// Load everything
function loadSubjects() {
  const order = localStorage.getItem("quiz_subject_order");
  const data = localStorage.getItem("quiz_subjects");
  const subData = localStorage.getItem("quiz_sub_order");

  if (order) subjectOrder = JSON.parse(order);
  if (data) {
    subjects = JSON.parse(data);
    if (subjectOrder.length === 0) {
      subjectOrder = Object.keys(subjects);
      saveOrder();
    }
  } else {
    // Default data
    subjects = { "भूगोल": ["गंगा", "यमुना"], "इतिहास": ["मौर्य", "मुगल"] };
    subjectOrder = ["भूगोल", "इतिहास"];
    subOrder = {
      "भूगोल": ["गंगा", "यमुना"],
      "इतिहास": ["मौर्य", "मुगल"]
    };
    saveAll();
  }

  // load subOrder if present
  if (subData) {
    try { subOrder = JSON.parse(subData); } catch(e) { subOrder = {}; }
  } else {
    // अगर subOrder खाली हो और subjects हैं, तो default से भर दें
    Object.keys(subjects).forEach(k => {
      if (!subOrder[k]) subOrder[k] = Array.isArray(subjects[k]) ? [...subjects[k]] : [];
    });
    saveAll();
  }
}

function saveAll() {
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  localStorage.setItem("quiz_subject_order", JSON.stringify(subjectOrder));
  localStorage.setItem("quiz_sub_order", JSON.stringify(subOrder));
}
function saveOrder() { localStorage.setItem("quiz_subject_order", JSON.stringify(subjectOrder)); }

// Populate main subjects (order-wise, no capitalization)
function populateMain() {
  const s1 = document.getElementById("mainSubject");
  const s2 = document.getElementById("manageMain");
  s1.innerHTML = s2.innerHTML = '<option value="">-- मुख्य विषय चुनें --</option>';

  subjectOrder.forEach(key => {
    if (subjects[key]) {
      s1.add(new Option(key, key));
      s2.add(new Option(key, key));
    }
  });
}

// Load sub-topics (use subOrder to preserve sequence)
function populateSubSubjects() {
  const key = document.getElementById("mainSubject").value;
  const sel = document.getElementById("subSubject");
  sel.innerHTML = '<option value="">-- उपविषय चुनें --</option>';
  const list = (subOrder[key] && subOrder[key].length) ? subOrder[key] : (subjects[key] || []);
  list.forEach(s => sel.add(new Option(s, s)));
}

function loadManageSection() {
  const key = document.getElementById("manageMain").value;
  const list = document.getElementById("subList");
  list.innerHTML = '<option value="">-- उपविषय चुनें --</option>';
  const arr = (subOrder[key] && subOrder[key].length) ? subOrder[key] : (subjects[key] || []);
  arr.forEach(s => list.add(new Option(s, s)));
  document.getElementById("newSubInput").value = "";
  hideAllRename();
}

function loadSubRename() {
  const oldName = document.getElementById("subList").value;
  document.getElementById("renameSubOld").value = oldName;
}

// Rename Main Subject
function toggleRenameMain() {
  const box = document.getElementById("renameMainBox");
  const current = document.getElementById("manageMain").value;
  document.getElementById("renameMainOld").value = current;
  document.getElementById("renameMainNew").value = current;
  box.classList.toggle("show");
}
function renameMainSubject() {
  const oldName = document.getElementById("manageMain").value;
  const newName = document.getElementById("renameMainNew").value.trim();
  if (!newName || newName === oldName) return alert("नया नाम अलग होना चाहिए");
  if (subjects[newName]) return alert("यह नाम पहले से मौजूद है");

  // move subjects
  subjects[newName] = subjects[oldName];
  delete subjects[oldName];

  // move order in subjectOrder
  subjectOrder = subjectOrder.map(k => k === oldName ? newName : k);

  // move subOrder entry as well
  if (subOrder[oldName]) {
    subOrder[newName] = subOrder[oldName];
    delete subOrder[oldName];
  } else {
    subOrder[newName] = subjects[newName] ? [...subjects[newName]] : [];
  }

  saveAll();
  populateMain();
  loadManageSection();
  alert(`"${oldName}" → "${newName}" नाम बदल दिया गया!`);
  toggleRenameMain();
}

// Rename Sub-topic
function toggleRenameSub() {
  const box = document.getElementById("renameSubBox");
  const current = document.getElementById("subList").value;
  if (!current) return alert("पहले उपविषय चुनें");
  document.getElementById("renameSubNew").value = current;
  box.classList.toggle("show");
}
function renameSubTopic() {
  const main = document.getElementById("manageMain").value;
  const oldSub = document.getElementById("subList").value;
  const newSub = document.getElementById("renameSubNew").value.trim();

  if (!newSub || newSub === oldSub) return alert("नया नाम अलग लिखें");
  // check duplicate
  const existing = (subOrder[main] || subjects[main] || []);
  if (existing.includes(newSub)) return alert("यह उपविषय पहले से मौजूद है");

  // update in subjects array
  if (subjects[main]) {
    subjects[main] = subjects[main].map(s => s === oldSub ? newSub : s);
  }
  // update in subOrder array (preserve position)
  if (!subOrder[main]) subOrder[main] = subjects[main] ? [...subjects[main]] : [];
  subOrder[main] = subOrder[main].map(s => s === oldSub ? newSub : s);

  saveAll();
  loadManageSection();
  alert(`"${oldSub}" → "${newSub}" नाम बदल दिया गया!`);
  toggleRenameSub();
}

function hideAllRename() {
  document.getElementById("renameMainBox").classList.remove("show");
  document.getElementById("renameSubBox").classList.remove("show");
}

// बाकी फंक्शन (add, delete, etc)
function addNewSubject() {
  let name = document.getElementById("newMain").value.trim();
  if (!name) return alert("नाम भरें");
  const subs = document.getElementById("newSubs").value.split(',').map(s=>s.trim()).filter(Boolean);
  if (subs.length === 0) return alert("उपविषय भरें");
  if (subjects[name]) return alert("पहले से है");

  subjects[name] = subs;
  subjectOrder.push(name);

  // नई subOrder बनाओ
  subOrder[name] = [...subs];

  saveAll();
  document.getElementById("newMain").value = "";
  document.getElementById("newSubs").value = "";
  populateMain();
  alert("जोड़ा गया!");
  switchTab('select');
}

function addSub() {
  const main = document.getElementById("manageMain").value;
  const sub = document.getElementById("newSubInput").value.trim();
  if (!main || !sub) return alert("भरें");
  const arr = subOrder[main] && subOrder[main].length ? subOrder[main] : (subjects[main] || []);
  if (arr.includes(sub)) return alert("पहले से है");

  // update both places
  if (!subjects[main]) subjects[main] = [];
  subjects[main].push(sub);

  if (!subOrder[main]) subOrder[main] = [];
  subOrder[main].push(sub);

  saveAll();
  document.getElementById("newSubInput").value = "";
  loadManageSection();
}

function deleteSub() {
  const main = document.getElementById("manageMain").value;
  const sub = document.getElementById("subList").value;
  if (!sub) return alert("उपविषय चुनें");

  if (subjects[main]) subjects[main] = subjects[main].filter(s => s !== sub);
  if (subOrder[main]) subOrder[main] = subOrder[main].filter(s => s !== sub);

  saveAll();
  loadManageSection();
}

function proceedToAction() {
  const main = document.getElementById("mainSubject").value;
  const sub = document.getElementById("subSubject").value;
  if (!main || !sub) return alert("दोनों चुनें");
  localStorage.setItem("selectedMain", main);
  localStorage.setItem("selectedSub", sub);
  location.href = "action.html";
}

function switchTab(t) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
  document.getElementById(t + '-tab').classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');
  if (t === 'manage') loadManageSection();
}

// Export & Import (order भी सेव रहेगा)
function exportData() {
  const data = { subjects, order: subjectOrder, subOrder };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'quiz_full_backup_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
}

function importData() {
  const file = document.getElementById("importFile").files[0];
  if (!file) return;
  const r = new FileReader();
  r.onload = function() {
    try {
      const d = JSON.parse(r.result);
      subjects = d.subjects || {};
      subjectOrder = d.order || Object.keys(subjects);
      // support both names: subOrder or quiz_sub_order inside file
      subOrder = d.subOrder || d.sub_order || {};
      // if subOrder empty, create from subjects
      Object.keys(subjects).forEach(k => {
        if (!subOrder[k]) subOrder[k] = Array.isArray(subjects[k]) ? [...subjects[k]] : [];
      });
      saveAll();
      populateMain();
      alert("बैकअप लोड हो गया — नाम बदलने का फीचर भी काम करेगा!");
    } catch (e) { console.error(e); alert("गलत फ़ाइल"); }
  };
  r.readAsText(file);
}

// Start
loadSubjects();
populateMain();
</script>
