<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>ЁЯУЪ рд╡рд┐рд╖рдп рдЪрдпрди</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6fb; margin:0; padding:0; }
    header { background: #3949ab; color: white; padding:15px; font-size:22px; text-align:center; position:sticky; top:0; z-index:100; }
    .container { max-width:500px; margin:20px auto; background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h1 { text-align:center; color:#3949ab; font-size:20px; margin:10px 0; }
    select,input,button { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; font-size:14px; box-sizing:border-box; }
    .btn { background:#3949ab; color:white; font-weight:bold; border:none; cursor:pointer; padding:10px; margin:5px 0; }
    .section { margin-bottom:20px; border:1px solid #e0e0e0; border-radius:8px; padding:12px; }
    .tab-container { display:flex; margin-bottom:15px; }
    .tab { flex:1; text-align:center; padding:8px; background:#e0e0e0; cursor:pointer; border-radius:5px 5px 0 0; margin:0 2px; }
    .tab.active { background:#3949ab; color:white; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    pre { font-size:12px; }
  </style>
</head>
<body>
  <header>ЁЯУЪ Quiz App</header>

  <div class="container">
    <h1>ЁЯУЪ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪрдпрди</h1>

    <div class="tab-container">
      <div class="tab active" onclick="switchTab('select')">рд╡рд┐рд╖рдп рдЪрдпрди</div>
      <div class="tab" onclick="switchTab('add')">рдирдпрд╛ рдЬреЛрдбрд╝реЗрдВ</div>
      <div class="tab" onclick="switchTab('manage')">рдкреНрд░рдмрдВрдзрди</div>
      <div class="tab" onclick="switchTab('backup')">рдмреИрдХрдЕрдк</div>
    </div>

    <!-- рд╡рд┐рд╖рдп рдЪрдпрди -->
    <div id="select-tab" class="tab-content active">
      <div class="section">
        <label><strong>рдореБрдЦреНрдп рд╡рд┐рд╖рдп:</strong></label>
        <select id="mainSubject" onchange="populateSubSubjects()"></select>

        <label><strong>рдЙрдкрд╡рд┐рд╖рдп:</strong></label>
        <select id="subSubject"></select>

        <button class="btn" onclick="proceedToAction()">ЁЯСЙ рдЖрдЧреЗ рдмрдврд╝реЗрдВ</button>
      </div>
    </div>

    <!-- рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ -->
    <div id="add-tab" class="tab-content">
      <div class="section">
        <input id="newMain" placeholder="рдореБрдЦреНрдп рд╡рд┐рд╖рдп">
        <input id="newSubs" placeholder="рдЙрдкрд╡рд┐рд╖рдп (рдХреЙрдорд╛ рд╕реЗ рдЕрд▓рдЧ рдХрд░реЗрдВ)">
        <button class="btn" onclick="addNewSubject()">ЁЯУВ рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛреЬреЗрдВ</button>
      </div>
    </div>

    <!-- рдЙрдкрд╡рд┐рд╖рдп рдкреНрд░рдмрдВрдзрди -->
    <div id="manage-tab" class="tab-content">
      <div class="section">
        <select id="manageMain" onchange="populateSubList()"></select>
        <select id="subList"></select>
        <input id="newSubInput" placeholder="рдирдпрд╛ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ">
        <button class="btn" onclick="addSub()">тЮХ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ</button>
        <button class="btn" onclick="deleteSub()">ЁЯЧСя╕П рдЙрдкрд╡рд┐рд╖рдп рд╣рдЯрд╛рдПрдВ</button>
      </div>
    </div>

    <!-- рд▓реЛрдХрд▓ JSON Backup / Import -->
    <div id="backup-tab" class="tab-content">
      <div class="section">
        <input type="file" id="importFile" accept=".json" onchange="handleLocalImportFile(event)">
        <button class="btn" onclick="exportData()">ЁЯУе рдбреЗрдЯрд╛ рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдВ</button>
        <p style="font-size:13px; color:#444; margin-top:10px;">
          рдиреЛрдЯ: JSON рдлрд╝рд╛рдЗрд▓ рдЬрд┐рд╕рдореЗрдВ "questions" рд╣реЛ, рдЙрд╕реЗ IndexedDB рдореЗрдВ merge рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдпрджрд┐ JSON рдореЗрдВ рд╕рд┐рд░реНрдл subjects рдореМрдЬреВрдж рд╣реИрдВ рддреЛ рд╡реЛ localStorage рдореЗрдВ рдмрдиреЗ рд░рд╣реЗрдВрдЧреЗред
        </p>
      </div>
    </div>
  </div>

<script>
/*
  рд╕реБрдзрд╛рд░рд┐рдд index.html:
  - IndexedDB (QuizAppDB / quizzes) рд╕реЗ рд╕рдмреНрдЬреЗрдХреНрдЯ/рд╕рдмрдЯреЙрдкрд┐рдХреНрд╕ рд▓реЛрдб рдХрд░реЗрдЧрд╛
  - localStorage fallback рднреА рд░рдЦреЗрдЧрд╛ (рдкреБрд░рд╛рдирд╛ рд╡реНрдпрд╡рд╣рд╛рд░ рдмрд░рдХрд░рд╛рд░)
  - JSON import рдореЗрдВ рдпрджрд┐ questions рд╣реИрдВ -> IndexedDB рдореЗрдВ рд╕реЗрд╡ рдХрд░реЗрдЧрд╛ (merge), рдЕрдиреНрдпрдерд╛ localStorage рдореЗрдВ рд░рдЦреЗрдЧрд╛
*/

// Local subjects object (fallback)
let subjects = {};

// IndexedDB constants (same as quiz.html)
const DB_NAME = 'QuizAppDB';
const DB_VERSION = 2;
const STORE_NAME = 'quizzes';
let db = null;

// рд╕рд╛рдорд╛рдиреНрдп tab switch
function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabName + '-tab').classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
}

// capitalize
function capitalize(str){ if(!str) return str; return str.charAt(0).toUpperCase() + str.slice(1); }

// IndexedDB open
function openDB() {
  return new Promise((resolve, reject) => {
    if (db) return resolve(db);
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = (e) => reject(e.target.error);
    request.onsuccess = (e) => { db = e.target.result; resolve(db); };
    request.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
  });
}

// DB рд╕реЗ рд╕рдмреНрдЬреЗрдХреНрдЯ рдФрд░ рд╕рдмрдЯреЙрдкрд┐рдХ рдирд┐рдХрд╛рд▓реЛ (id parsing рд╕реЗ)
async function loadSubjectsFromDB() {
  await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const subjectsSet = new Set();
    const subtopicsMap = {}; // { subject: Set(...) }

    store.openCursor().onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor) {
        const item = cursor.value;

        // рдЕрдЧрд░ object рдореЗрдВ explicit fields рд╣реЛрдВ рддреЛ рдЙрдкрдпреЛрдЧ рдХрд░реЛ
        let main = item.subject || null;
        let sub = item.subtopic || item.subtopicName || null;

        // рдЕрдиреНрдпрдерд╛ id рд╕реЗ рдирд┐рдХрд╛рд▓реЛ: expected "quiz_<main>_<sub...>"
        if (!main || !sub) {
          if (typeof item.id === 'string' && item.id.startsWith('quiz_')) {
            const rest = item.id.slice(5); // remove "quiz_"
            // split at first underscore: subject could be multiple words separated by spaces originally,
            // but earlier code used `quiz_${main}_${sub}` where spaces likely preserved.
            // We'll split at FIRST "_" to be safe: main = before first '_', sub = after.
            const firstUnd = rest.indexOf('_');
            if (firstUnd > 0) {
              main = main || rest.slice(0, firstUnd);
              sub = sub || rest.slice(firstUnd + 1);
            } else {
              // fallback: whole rest as main
              main = main || rest;
            }
          }
        }

        if (main) {
          subjectsSet.add(main);
          if (!subtopicsMap[main]) subtopicsMap[main] = new Set();
          if (sub) subtopicsMap[main].add(sub);
        }

        cursor.continue();
      } else {
        // cursor finished
        resolve({ subjectsSet, subtopicsMap });
      }
    };

    store.openCursor().onerror = (err) => reject(err);
  });
}

// dropdown fill рдХрд░рдиреЗ рдХрд╛ function (merge localStorage subjects + DB)
async function populateDropdowns() {
  // load localStorage subjects first
  const ls = JSON.parse(localStorage.getItem("quiz_subjects") || "{}");
  subjects = ls && Object.keys(ls).length ? ls : subjects;

  // DB рд╕реЗ load рдХрд░ рдХреЗ merge рдХрд░реЛ
  try {
    const { subjectsSet, subtopicsMap } = await loadSubjectsFromDB();

    // Merge: subjectsSet may have many; merge into 'subjects' object
    subjectsSet.forEach(s => {
      if (!subjects[s]) subjects[s] = []; // initialize
      // add subtopics from map
      const subsFromDB = Array.from(subtopicsMap[s] || []);
      subsFromDB.forEach(st => {
        if (!subjects[s].includes(st)) subjects[s].push(st);
      });
    });
  } catch (err) {
    console.warn('DB рд╕реЗ subjects рд▓реЛрдб рдореЗрдВ рддреНрд░реБрдЯрд┐:', err);
  }

  // рдЕрдЧрд░ рдЕрдм рднреА subjects рдЦрд╛рд▓реА рд╣реЛрдВ рддреЛ default рд░рдЦреЗрдВ
  if (!localStorage.getItem("quiz_subjects") && Object.keys(subjects).length === 0) {
    subjects = {
      economics: ["Micro", "Macro"],
      history: ["Ancient", "Modern"],
      geography: ["India", "World"]
    };
    localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  }

  // Populate selects
  const main = document.getElementById("mainSubject");
  const manage = document.getElementById("manageMain");
  main.innerHTML = ""; manage.innerHTML = "";
  document.getElementById("subSubject").innerHTML = '<option value="">-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>';
  document.getElementById("subList").innerHTML = '<option value="">-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>';

  main.appendChild(new Option("-- рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --",""));
  manage.appendChild(new Option("-- рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --",""));

  for (let key in subjects) {
    main.appendChild(new Option(capitalize(key), key));
    manage.appendChild(new Option(capitalize(key), key));
  }
}

// рдЬрдм mainSubject рдмрджрд▓реЗ рддреЛ sub рднрд░рдирд╛
function populateSubSubjects() {
  const subject = document.getElementById("mainSubject").value;
  const subs = subjects[subject] || [];
  const subSelect = document.getElementById("subSubject");
  subSelect.innerHTML = "";
  subSelect.appendChild(new Option("-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --",""));
  subs.forEach(sub => subSelect.appendChild(new Option(sub, sub)));
}

// manage рдХреЗ рд▓рд┐рдП рд╕реВрдЪреА
function populateSubList() {
  const subject = document.getElementById("manageMain").value;
  const list = document.getElementById("subList");
  list.innerHTML = "";
  list.appendChild(new Option("-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --", ""));
  if (subjects[subject]) subjects[subject].forEach(sub => list.appendChild(new Option(sub, sub)));
}

// рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛрдбрд╝рдирд╛ (localStorage рдореЗрдВ)
function addNewSubject() {
  const newMain = document.getElementById("newMain").value.trim();
  const newSubs = document.getElementById("newSubs").value.split(',').map(s => s.trim()).filter(Boolean);
  if (!newMain || newSubs.length === 0) { alert("тЭЧ рдХреГрдкрдпрд╛ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рднрд░реЗрдВ"); return; }
  if (!subjects[newMain]) subjects[newMain] = [];
  newSubs.forEach(s => { if (!subjects[newMain].includes(s)) subjects[newMain].push(s); });
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  document.getElementById("newMain").value = "";
  document.getElementById("newSubs").value = "";
  populateDropdowns();
  alert("тЬЕ рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛!");
  switchTab('select');
}

// add sub (manage tab)
function addSub() {
  const subject = document.getElementById("manageMain").value;
  const newSub = document.getElementById("newSubInput").value.trim();
  if (!subject || !newSub) { alert("тЭЧ рдХреГрдкрдпрд╛ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рднрд░реЗрдВ"); return; }
  if (!subjects[subject]) subjects[subject] = [];
  if (subjects[subject].includes(newSub)) { alert("тЪая╕П рдпрд╣ рдЙрдкрд╡рд┐рд╖рдп рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИ"); return; }
  subjects[subject].push(newSub);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  document.getElementById("newSubInput").value = "";
  populateSubList(); populateSubSubjects();
  alert("тЬЕ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛!");
}

// delete sub
function deleteSub() {
  const subject = document.getElementById("manageMain").value;
  const sub = document.getElementById("subList").value;
  if (!subject || !sub) { alert("тЭЧ рдХреГрдкрдпрд╛ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ"); return; }
  subjects[subject] = subjects[subject].filter(s => s !== sub);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  populateSubList(); populateSubSubjects();
  alert("ЁЯЧСя╕П рдЙрдкрд╡рд┐рд╖рдп рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛!");
}

// рдЖрдЧреЗ рдмрдврд╝реЛ -> action.html
function proceedToAction() {
  const main = document.getElementById("mainSubject").value;
  const sub = document.getElementById("subSubject").value;
  if (!main || !sub) { alert("тЪая╕П рдХреГрдкрдпрд╛ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ!"); return; }
  localStorage.setItem("selectedMain", main);
  localStorage.setItem("selectedSub", sub);
  window.location.href = "action.html";
}

/* ======================
   Import handling (improved)
   - рдЕрдЧрд░ JSON рдореЗрдВ "questions" рд╣реИ => IndexedDB рдореЗрдВ merge рдХрд░рдХреЗ рд╕реЗрд╡ рдХрд░реЗрдЧрд╛
   - рдирд╣реАрдВ рддреЛ рдкреБрд░рд╛рдиреЗ рдЬреИрд╕рд╛ localStorage рдореЗрдВ quiz_subjects рдЖрджрд┐ рдЕрдкрд▓реЛрдб рдХрд░реЗрдЧрд╛
   ====================== */
function handleLocalImportFile(evt) {
  const file = evt.target.files && evt.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = async function(e) {
    try {
      const data = JSON.parse(e.target.result);

      // рдЕрдЧрд░ JSON рдореЗрдВ quizData рдЬреИрд╕реА structure рд╣реИ (keys starting with quiz_) - рдкреБрд░рд╛рдирд╛ localStorage рддрд░реАрдХрд╛
      if (data.subjects || data.quizData) {
        if (data.subjects) {
          // old-style subjects object
          localStorage.setItem("quiz_subjects", JSON.stringify(data.subjects));
          subjects = data.subjects;
        }
        if (data.quizData) {
          // store quizData keys into localStorage (backward compatibility)
          for (let key in data.quizData) {
            localStorage.setItem(key, JSON.stringify(data.quizData[key]));
          }
        }
        alert("тЬЕ рдкреБрд░рд╛рдирд╛ рдмреИрдХрдЕрдк рд▓реЛрдб рд╣реЛ рдЧрдпрд╛ (localStorage)");
        populateDropdowns();
        return;
      }

      // рдЕрдЧрд░ JSON рдореЗрдВ direct questions array рд╣реИ (quiz export schema from quiz.html)
      if (Array.isArray(data.questions) && (data.subject || data.subtopic)) {
        // Merge into IndexedDB under key quiz_<subject>_<subtopic>
        const main = data.subject;
        const sub = data.subtopic;
        const key = `quiz_${main}_${sub}`;
        await openDB();
        const tx = db.transaction(STORE_NAME, 'readwrite');
        const store = tx.objectStore(STORE_NAME);

        // get existing questions if present
        const getReq = store.get(key);
        getReq.onsuccess = async function(ev) {
          const existing = ev.target.result;
          let merged = [];
          if (existing && Array.isArray(existing.questions)) merged = [...existing.questions];
          // append new questions
          merged = merged.concat(data.questions);
          const putReq = store.put({ id: key, questions: merged, lastUpdated: new Date() });
          putReq.onsuccess = function() {
            alert(`тЬЕ ${data.questions.length} рдкреНрд░рд╢реНрди IndexedDB рдореЗрдВ merge рд╣реЛрдХрд░ рд╕реЗрд╡ рд╣реЛ рдЧрдП!`);
            // refresh dropdowns after small delay
            setTimeout(populateDropdowns, 500);
          };
          putReq.onerror = function(err) { console.error('put error', err); alert('DB рдореЗрдВ рд╕реЗрд╡ рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐'); };
        };
        getReq.onerror = function(err) { console.error('get error', err); alert('DB рдкрдврд╝рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐'); };
        return;
      }

      // рдЕрдиреНрдп/рдЕрдирд┐рд╢реНрдЪрд┐рдд structure -> рдкреБрд░рд╛рдирд╛ fallback: рдпрджрд┐ data.quizData keys рд╣реИрдВ рддреЛ localStorage рдореЗрдВ рдбрд╛рд▓реЛ
      if (data.quizData || data.subjects) {
        if (data.subjects) { localStorage.setItem("quiz_subjects", JSON.stringify(data.subjects)); subjects = data.subjects; }
        if (data.quizData) { for (let key in data.quizData) localStorage.setItem(key, JSON.stringify(data.quizData[key])); }
        alert("тЬЕ рдбреЗрдЯрд╛ import рд╣реЛ рдЧрдпрд╛ (fallback localStorage)");
        populateDropdowns();
        return;
      }

      alert("тЭЧ JSON рдХрд╛ рдлреЙрд░реНрдореИрдЯ рдкрд╣рдЪрд╛рди рдореЗрдВ рдирд╣реАрдВ рдЖрдпрд╛ред рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рдлрд╛рдЗрд▓ рд╕рд╣реА рд╣реИ (subject+subtopic+questions)ред");
    } catch (err) {
      console.error('Import error', err);
      alert("тЭЧ JSON рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐: " + err.message);
    }
  };
  reader.readAsText(file);
}

// Export: current localStorage subjects + quiz_* keys into a JSON (old behavior preserved)
function exportData() {
  const data = {
    subjects: JSON.parse(localStorage.getItem("quiz_subjects") || "{}"),
    main: localStorage.getItem("selectedMain"),
    sub: localStorage.getItem("selectedSub"),
    quizData: {}
  };

  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith("quiz_") && key !== "quiz_subjects") {
      try {
        data.quizData[key] = JSON.parse(localStorage.getItem(key));
      } catch (e) { data.quizData[key] = localStorage.getItem(key); }
    }
  }

  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'quiz_backup_' + new Date().toISOString().slice(0,10) + '.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// On load -> populate from DB + localStorage
window.addEventListener('load', async () => {
  // load from localStorage first
  subjects = JSON.parse(localStorage.getItem("quiz_subjects") || "{}");
  await populateDropdowns();
});
</script>
</body>
</html>
