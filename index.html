<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìö ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‡§ê‡§™ (JSON ‡§Ü‡§Ø‡§æ‡§§ ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü)</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #e4e7f0);
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: linear-gradient(135deg, #3949ab, #283593);
      color: white;
      padding: 20px;
      font-size: 24px;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
    }
    .section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
      max-width: 850px;
      margin: 30px auto;
      transition: all 0.3s ease;
    }
    textarea, input, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 16px;
      box-sizing: border-box;
      transition: border 0.3s;
    }
    textarea:focus, input:focus, select:focus {
      border-color: #3949ab;
      outline: none;
      box-shadow: 0 0 0 2px rgba(57, 73, 171, 0.2);
    }
    .btn {
      background: linear-gradient(135deg, #3949ab, #5c6bc0);
      color: white;
      font-weight: bold;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      transition: all 0.2s;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: inline-block;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .btn-option {
      display: block;
      width: 100%;
      text-align: left;
      padding: 12px 15px;
      border-radius: 8px;
      background: #f8f9fa;
      border: 1px solid #e0e0e0;
      margin: 8px 0;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-option:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }
    .explanation {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      color: #555;
      line-height: 1.5;
      background: #f9f9f9;
      border-radius: 8px;
      padding: 15px;
    }
    .edit-btn {
      position: absolute;
      top: 2px;
      right: 2px;
      background: #FFC107;
      color: #000;
      border: none;
      padding: 2px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .question-item {
      padding: 12px 0;
      border-bottom: 1px solid #eee;
      position: relative;
    }
    .submit-btn {
      background: linear-gradient(135deg, #4CAF50, #66BB6A);
    }
    .delete-btn {
      background: linear-gradient(135deg, #f44336, #e53935);
    }
    .accuracy-display {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 32px;
      font-weight: bold;
      color: #3949ab;
      text-align: center;
    }
    .question-container {
      position: relative;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      margin-bottom: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      border-left: 4px solid #3949ab;
    }
    .question-text {
      font-weight: bold;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    .statement {
      font-weight: normal;
      color: #555;
      margin: 5px 0;
      line-height: 1.4;
      padding-left: 15px;
      border-left: 2px solid #e0e0e0;
    }
    .image-preview-container {
      margin: 15px 0;
      text-align: center;
      width: 100%;
      height: 200px;
      border: 1px dashed #ddd;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #fafafa;
    }
    .image-preview {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .remove-image-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 5px;
      font-size: 12px;
    }
    .upload-btn-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    .upload-btn {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px dashed #64b5f6;
      padding: 12px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      text-align: center;
      margin: 10px 0;
      display: block;
      transition: all 0.3s;
    }
    .upload-btn:hover {
      background: #bbdefb;
    }
    .upload-btn-wrapper input[type=file] {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    .question-image-container {
      width: 100%;
      height: 50vh;
      min-height: 200px;
      max-height: 300px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      border-radius: 8px;
      background: #f8f9f9;
      border: 1px solid #e0e0e0;
    }
    .question-image {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .action-buttons .btn {
      flex: 1;
    }
    .db-info {
      background: #e3f2fd;
      padding: 10px 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }
    .status-connected {
      background: #4CAF50;
    }
    .status-disconnected {
      background: #f44336;
    }
    .backup-section {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .backup-title {
      text-align: center;
      color: #3949ab;
      margin-bottom: 15px;
    }
    .backup-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .backup-actions .btn {
      flex: 1;
    }
    @media (max-width: 600px) {
      .result-content {
        flex-direction: column;
      }
      .question-image-container {
        height: 30vh;
        max-height: 250px;
      }
      .section {
        padding: 15px;
        margin: 15px;
      }
      .action-buttons {
        flex-direction: column;
      }
      .backup-actions {
        flex-direction: column;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <div>üìö ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä ‡§ê‡§™ (JSON ‡§Ü‡§Ø‡§æ‡§§ ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü)</div>
  <div style="font-size: 16px; margin-top: 10px;">‡§Ö‡§¨ JSON ‡§´‡§º‡§æ‡§á‡§≤‡•ã‡§Ç ‡§∏‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡•á ‡§π‡•à‡§Ç</div>
</header>
<h2 id="pageTitle" style="text-align:center; color:#3949ab;"></h2>

<div id="inputSection" class="section" style="display:none;">
  <h3>‚ûï ‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</h3>
  <textarea id="question" placeholder="‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§≤‡§ø‡§ñ‡•á‡§Ç (‡§¨‡•ã‡§≤‡•ç‡§° ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ)"></textarea>
  
  <div class="upload-btn-wrapper">
    <div class="upload-btn">
      <span>üì∑ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</span>
    </div>
    <input type="file" id="imageUpload" accept="image/*">
  </div>
  
  <div class="image-preview-container">
    <img id="imagePreview" class="image-preview" alt="‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§õ‡§µ‡§ø ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®">
    <button id="removeImageBtn" class="remove-image-btn" style="display:none;">‚ùå ‡§õ‡§µ‡§ø ‡§π‡§ü‡§æ‡§è‡§Ç</button>
  </div>
  
  <input id="optA" placeholder="‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ A">
  <input id="optB" placeholder="‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ B">
  <input id="optC" placeholder="‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ C">
  <input id="optD" placeholder="‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ D">
  <select id="correct">
    <option value="A">A</option>
    <option value="B">B</option>
    <option value="C">C</option>
    <option value="D">D</option>
  </select>
  <textarea id="explanation" placeholder="‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§≤‡§ø‡§ñ‡•á‡§Ç (‡§∏‡§æ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü)"></textarea>
  
  <div class="upload-btn-wrapper">
    <div class="upload-btn">
      <span>üì∑ ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§õ‡§µ‡§ø ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)</span>
    </div>
    <input type="file" id="explanationImageUpload" accept="image/*">
  </div>
  
  <div class="image-preview-container">
    <img id="explanationImagePreview" class="image-preview" alt="‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§õ‡§µ‡§ø ‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§µ‡§≤‡•ã‡§ï‡§®">
    <button id="removeExplanationImageBtn" class="remove-image-btn" style="display:none;">‚ùå ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§õ‡§µ‡§ø ‡§π‡§ü‡§æ‡§è‡§Ç</button>
  </div>
  
  <div class="action-buttons">
    <button class="btn" onclick="saveQuestion()">üíæ ‡§∏‡•á‡§µ ‡§ï‡§∞‡•á‡§Ç</button>
    <button class="btn delete-btn" onclick="clearForm()">üóëÔ∏è ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç</button>
  </div>
  
  <div class="db-info">
    <div>
      <span class="status-indicator status-connected" id="dbStatus"></span>
      <span>IndexedDB ‡§ï‡§®‡•á‡§ï‡•ç‡§ü‡•á‡§°</span>
    </div>
    <div id="storageInfo">‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§â‡§™‡§Ø‡•ã‡§ó: ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à...</div>
  </div>
  
  <div id="questionCount"></div>
  <div id="questionList"></div>
  
  <div class="backup-section">
    <h3 class="backup-title">üì• JSON ‡§¨‡•à‡§ï‡§Ö‡§™ ‡§î‡§∞ ‡§Ü‡§Ø‡§æ‡§§</h3>
    <p style="text-align: center; margin-bottom: 15px;">
      ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§ø‡§è ‡§ó‡§è JSON ‡§´‡§º‡§æ‡§á‡§≤ ‡§∏‡•á ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§§‡§Æ‡§æ‡§® ‡§°‡•á‡§ü‡§æ ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç
    </p>
    
    <div class="upload-btn-wrapper">
      <div class="upload-btn">
        <span>üìÅ JSON ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç</span>
      </div>
      <input type="file" id="jsonImportFile" accept=".json">
    </div>
    
    <div class="backup-actions">
      <button class="btn" onclick="importJSONData()">‚¨ÜÔ∏è JSON ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
      <button class="btn" onclick="exportJSONData()">‚¨áÔ∏è JSON ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
    </div>
    
    <div style="margin-top: 15px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
      <h4 style="margin-top: 0; color: #3949ab;">JSON ‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™:</h4>
      <pre style="overflow: auto; max-height: 150px; background: white; padding: 10px; border-radius: 4px;">
{
  "subject": "‡§µ‡§ø‡§∑‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ",
  "subtopic": "‡§â‡§™‡§µ‡§ø‡§∑‡§Ø ‡§ï‡§æ ‡§®‡§æ‡§Æ",
  "questions": [
    {
      "question": "‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü",
      "options": {
        "A": "‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ A",
        "B": "‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ B",
        "C": "‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ C",
        "D": "‡§µ‡§ø‡§ï‡§≤‡•ç‡§™ D"
      },
      "correct": "A",
      "explanation": "‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§ü‡•á‡§ï‡•ç‡§∏‡•ç‡§ü",
      "image": "base64 ‡§õ‡§µ‡§ø ‡§°‡•á‡§ü‡§æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)",
      "explanationImage": "base64 ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§õ‡§µ‡§ø ‡§°‡•á‡§ü‡§æ (‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï)"
    }
  ]
}</pre>
    </div>
  </div>
</div>

<div id="practiceSection" class="section" style="display:none;">
  <h3>üéØ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏ ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</h3>
  <div id="progress" style="font-weight:bold; font-size:18px; text-align:center; margin-bottom:15px;"></div>
  <div id="gotoContainer" style="display:flex; gap:10px; margin-top:15px;">
    <input id="gotoInput" type="number" placeholder="‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ" style="flex:1; padding:12px;">
    <button id="gotoBtn" onclick="goToQuestion()" class="btn">üîç ‡§ú‡§æ‡§è‡§Ç</button>
  </div>
  <div id="quizQuestionContainer" style="margin-top:20px;">
    <div id="quizQuestion" class="question-container"></div>
  </div>
  <div id="quizOptions"></div>
</div>

<div id="resultSection" class="section" style="display:none;">
  <div class="result-card">
    <h3 style="text-align:center; color:#3949ab;">üìä ‡§Ü‡§™‡§ï‡•á ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ</h3>
    <div style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center; align-items:center;">
      <div style="flex:1; min-width:200px;">
        <div style="background:#f9f9f9; padding:15px; border-radius:8px;">
          <p><strong>üìù ‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®:</strong> <span id="totalQuestions">0</span></p>
          <p><strong>‚úÖ ‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞:</strong> <span id="correctAnswers">0</span></p>
          <p><strong>‚ùå ‡§ó‡§≤‡§§ ‡§â‡§§‡•ç‡§§‡§∞:</strong> <span id="incorrectAnswers">0</span></p>
          <p><strong>üìä ‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ:</strong> <span id="accuracyPercent" style="font-weight:bold; color:#3949ab;">0%</span></p>
        </div>
      </div>
      <div style="position:relative; width:250px; height:250px;">
        <canvas id="resultChart"></canvas>
        <div class="accuracy-display">
          <span id="bigAccuracy">0%</span>
          <div style="font-size:14px; color:#666;">‡§∏‡§ü‡•Ä‡§ï‡§§‡§æ</div>
        </div>
      </div>
    </div>
    <div class="action-buttons">
      <button class="btn" onclick="resetQuiz()">üîÑ ‡§®‡§Ø‡§æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§∂‡•Å‡§∞‡•Ç ‡§ï‡§∞‡•á‡§Ç</button>
      <button class="btn" onclick="showInputSection()">üìù ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç</button>
    </div>
  </div>
</div>

<script>
// IndexedDB ‡§ï‡•â‡§®‡•ç‡§´‡§º‡§ø‡§ó‡§∞‡•á‡§∂‡§®
const DB_NAME = 'QuizAppDB';
const DB_VERSION = 2;
const STORE_NAME = 'quizzes';

let db;
let questions = [];
let currentQuestion = 0;
let correctCount = 0;
let incorrectCount = 0;
let editIndex = -1;
let currentImage = null;
let currentExplanationImage = null;

// IndexedDB ‡§ñ‡•ã‡§≤‡•á‡§Ç
function openDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    
    request.onerror = (event) => {
      console.error('‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', event.target.error);
      document.getElementById('dbStatus').className = 'status-indicator status-disconnected';
      reject(event.target.error);
    };
    
    request.onsuccess = (event) => {
      db = event.target.result;
      console.log('‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§ñ‡•ã‡§≤‡§æ ‡§ó‡§Ø‡§æ');
      document.getElementById('dbStatus').className = 'status-indicator status-connected';
      updateStorageUsage();
      resolve(db);
    };
    
    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
        console.log(`‡§ë‡§¨‡•ç‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•ç‡§ü‡•ã‡§∞ ${STORE_NAME} ‡§¨‡§®‡§æ‡§Ø‡§æ ‡§ó‡§Ø‡§æ`);
      }
    };
  });
}

// ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§∏‡•á ‡§ï‡•ç‡§µ‡§ø‡§ú ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
async function loadQuizFromDB(quizId) {
  if (!db) await openDB();
  
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readonly');
    const store = transaction.objectStore(STORE_NAME);
    const request = store.get(quizId);
    
    request.onerror = (event) => {
      console.error('‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', event.target.error);
      reject(event.target.error);
    };
    
    request.onsuccess = (event) => {
      const quizData = event.target.result;
      resolve(quizData ? quizData.questions : []);
    };
  });
}

// ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§ï‡•ç‡§µ‡§ø‡§ú ‡§∏‡§π‡•á‡§ú‡•á‡§Ç
async function saveQuizToDB(quizId, questions) {
  if (!db) await openDB();
  
  return new Promise((resolve, reject) => {
    const transaction = db.transaction([STORE_NAME], 'readwrite');
    const store = transaction.objectStore(STORE_NAME);
    
    const quizData = {
      id: quizId,
      questions: questions,
      lastUpdated: new Date()
    };
    
    const request = store.put(quizData);
    
    request.onerror = (event) => {
      console.error('‡§°‡•á‡§ü‡§æ ‡§∏‡§π‡•á‡§ú‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', event.target.error);
      reject(event.target.error);
    };
    
    request.onsuccess = (event) => {
      console.log(`‡§ï‡•ç‡§µ‡§ø‡§ú ${quizId} ‡§∏‡§π‡•á‡§ú‡•Ä ‡§ó‡§à`);
      updateStorageUsage();
      resolve();
    };
  });
}

// ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§â‡§™‡§Ø‡•ã‡§ó ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
function updateStorageUsage() {
  if (!navigator.storage || !navigator.storage.estimate) return;
  
  navigator.storage.estimate().then(estimate => {
    const usedMB = (estimate.usage / (1024 * 1024)).toFixed(2);
    const quotaMB = (estimate.quota / (1024 * 1024)).toFixed(2);
    document.getElementById('storageInfo').textContent = 
      `‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§â‡§™‡§Ø‡•ã‡§ó: ${usedMB} MB / ${quotaMB} MB`;
  });
}

// ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§á‡§Æ‡•á‡§ú ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•à‡§Ç‡§°‡§≤‡§∞
document.getElementById("imageUpload").addEventListener("change", function(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      currentImage = e.target.result;
      document.getElementById("imagePreview").src = currentImage;
      document.getElementById("imagePreview").style.display = "block";
      document.getElementById("removeImageBtn").style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});

// ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§á‡§Æ‡•á‡§ú ‡§∞‡§ø‡§Æ‡•Ç‡§µ ‡§π‡•à‡§Ç‡§°‡§≤‡§∞
document.getElementById("removeImageBtn").addEventListener("click", function() {
  currentImage = null;
  document.getElementById("imagePreview").src = "";
  document.getElementById("imagePreview").style.display = "none";
  document.getElementById("removeImageBtn").style.display = "none";
  document.getElementById("imageUpload").value = "";
});

// ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§á‡§Æ‡•á‡§ú ‡§Ö‡§™‡§≤‡•ã‡§° ‡§π‡•à‡§Ç‡§°‡§≤‡§∞
document.getElementById("explanationImageUpload").addEventListener("change", function(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      currentExplanationImage = e.target.result;
      document.getElementById("explanationImagePreview").src = currentExplanationImage;
      document.getElementById("explanationImagePreview").style.display = "block";
      document.getElementById("removeExplanationImageBtn").style.display = "block";
    };
    reader.readAsDataURL(file);
  }
});

// ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§á‡§Æ‡•á‡§ú ‡§∞‡§ø‡§Æ‡•Ç‡§µ ‡§π‡•à‡§Ç‡§°‡§≤‡§∞
document.getElementById("removeExplanationImageBtn").addEventListener("click", function() {
  currentExplanationImage = null;
  document.getElementById("explanationImagePreview").src = "";
  document.getElementById("explanationImagePreview").style.display = "none";
  document.getElementById("removeExplanationImageBtn").style.display = "none";
  document.getElementById("explanationImageUpload").value = "";
});

// ‡§´‡•â‡§∞‡•ç‡§Æ ‡§∏‡§æ‡§´ ‡§ï‡§∞‡•á‡§Ç
function clearForm() {
  document.getElementById("question").value = '';
  document.getElementById("optA").value = '';
  document.getElementById("optB").value = '';
  document.getElementById("optC").value = '';
  document.getElementById("optD").value = '';
  document.getElementById("explanation").value = '';
  document.getElementById("correct").value = 'A';
  
  currentImage = null;
  document.getElementById("imagePreview").src = "";
  document.getElementById("imagePreview").style.display = "none";
  document.getElementById("removeImageBtn").style.display = "none";
  document.getElementById("imageUpload").value = "";
  
  currentExplanationImage = null;
  document.getElementById("explanationImagePreview").src = "";
  document.getElementById("explanationImagePreview").style.display = "none";
  document.getElementById("removeExplanationImageBtn").style.display = "none";
  document.getElementById("explanationImageUpload").value = "";
  
  editIndex = -1;
}

// ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§∏‡§π‡•á‡§ú‡•á‡§Ç
async function saveQuestion() {
  const q = document.getElementById("question").value.trim();
  const A = document.getElementById("optA").value.trim();
  const B = document.getElementById("optB").value.trim();
  const C = document.getElementById("optC").value.trim();
  const D = document.getElementById("optD").value.trim();
  const correct = document.getElementById("correct").value;
  const exp = document.getElementById("explanation").value.trim();
  
  if (!q || !A || !B || !C || !D || !correct) {
    alert("‚ùó ‡§∏‡§≠‡•Ä ‡§´‡§º‡•Ä‡§≤‡•ç‡§° ‡§≠‡§∞‡•á‡§Ç!");
    return;
  }
  
  const newQ = {
    question: q,
    options: { A, B, C, D },
    correct,
    explanation: exp,
    image: currentImage,
    explanationImage: currentExplanationImage
  };
  
  const currentKey = `quiz_${localStorage.getItem("selectedMain")}_${localStorage.getItem("selectedSub")}`;
  
  if (editIndex >= 0) {
    questions[editIndex] = newQ;
    editIndex = -1;
    alert("‚úÖ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ö‡§™‡§°‡•á‡§ü ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
  } else {
    questions.push(newQ);
    alert("‚úÖ ‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ú‡•ã‡§°‡§º‡§æ ‡§ó‡§Ø‡§æ!");
  }
  
  await saveQuizToDB(currentKey, questions);
  clearForm();
  document.getElementById("questionCount").textContent = `üî¢ ‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: ${questions.length}`;
  showAllQuestions();
}

// ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§´‡•â‡§∞‡•ç‡§Æ‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
function formatQuestionText(text) {
  const parts = text.split('\n');
  let result = `<strong>${parts[0]}</strong>`;
  
  if (parts.length > 1) {
    for (let i = 1; i < parts.length; i++) {
      if (parts[i].trim() !== '') {
        result += `<div class="statement">${parts[i]}</div>`;
      }
    }
  }
  
  return result;
}

// ‡§∏‡§≠‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
function showAllQuestions() {
  const listDiv = document.getElementById("questionList");
  listDiv.innerHTML = '';
  
  if (questions.length === 0) {
    listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">‚ùå ‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§®‡§Ø‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç</div>';
    return;
  }
  
  questions.forEach((q, index) => {
    const div = document.createElement("div");
    div.className = "question-item";
    div.innerHTML = `
      <div style="position:relative;">
        <button class="edit-btn" onclick="editQuestion(${index})">‚úèÔ∏è</button>
        <button class="edit-btn" onclick="deleteQuestion(${index})" style="right:25px; background:#f44336;">üóëÔ∏è</button>
        <div class="question-text">Q${index + 1}: ${formatQuestionText(q.question)}</div>
        ${q.image ? '<div style="font-size:12px; color:#666; margin-top:5px;">üì∑ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§õ‡§µ‡§ø ‡§ú‡•Å‡§°‡§º‡•Ä ‡§π‡•Å‡§à ‡§π‡•à</div>' : ''}
        ${q.explanationImage ? '<div style="font-size:12px; color:#666; margin-top:5px;">üì∑ ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§õ‡§µ‡§ø ‡§ú‡•Å‡§°‡§º‡•Ä ‡§π‡•Å‡§à ‡§π‡•à</div>' : ''}
      </div>
    `;
    listDiv.appendChild(div);
  });
}

// ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç
function editQuestion(index) {
  const q = questions[index];
  document.getElementById("question").value = q.question;
  document.getElementById("optA").value = q.options.A;
  document.getElementById("optB").value = q.options.B;
  document.getElementById("optC").value = q.options.C;
  document.getElementById("optD").value = q.options.D;
  document.getElementById("correct").value = q.correct;
  document.getElementById("explanation").value = q.explanation;
  
  if (q.image) {
    currentImage = q.image;
    document.getElementById("imagePreview").src = q.image;
    document.getElementById("imagePreview").style.display = "block";
    document.getElementById("removeImageBtn").style.display = "block";
  } else {
    currentImage = null;
    document.getElementById("imagePreview").src = "";
    document.getElementById("imagePreview").style.display = "none";
    document.getElementById("removeImageBtn").style.display = "none";
  }
  
  if (q.explanationImage) {
    currentExplanationImage = q.explanationImage;
    document.getElementById("explanationImagePreview").src = q.explanationImage;
    document.getElementById("explanationImagePreview").style.display = "block";
    document.getElementById("removeExplanationImageBtn").style.display = "block";
  } else {
    currentExplanationImage = null;
    document.getElementById("explanationImagePreview").src = "";
    document.getElementById("explanationImagePreview").style.display = "none";
    document.getElementById("removeExplanationImageBtn").style.display = "none";
  }
  
  editIndex = index;
  document.getElementById("inputSection").style.display = "block";
  document.getElementById("practiceSection").style.display = "none";
  document.getElementById("pageTitle").textContent = "‚úèÔ∏è ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç";
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§π‡§ü‡§æ‡§è‡§Ç
async function deleteQuestion(index) {
  if (confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§á‡§∏ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ï‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?`)) {
    questions.splice(index, 1);
    const currentKey = `quiz_${localStorage.getItem("selectedMain")}_${localStorage.getItem("selectedSub")}`;
    await saveQuizToDB(currentKey, questions);
    showAllQuestions();
    document.getElementById("questionCount").textContent = `üî¢ ‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: ${questions.length}`;
  }
}

// ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡§∞ ‡§ú‡§æ‡§è‡§Ç
function goToQuestion() {
  const input = parseInt(document.getElementById("gotoInput").value);
  if (!input || input < 1 || input > questions.length) {
    alert(`‚ö†Ô∏è ‡§Æ‡§æ‡§®‡•ç‡§Ø ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§∏‡§Ç‡§ñ‡•ç‡§Ø‡§æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç (1 ‡§∏‡•á ${questions.length} ‡§ï‡•á ‡§¨‡•Ä‡§ö)`);
    return;
  }
  currentQuestion = input - 1;
  showQuestion();
}

// ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
function showQuestion() {
  const q = questions[currentQuestion];
  
  let imageHTML = '';
  if (q.image) {
    imageHTML = `
      <div class="question-image-container">
        <img src="${q.image}" class="question-image" alt="‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§õ‡§µ‡§ø">
      </div>
    `;
  }
  
  const quizQuestionHTML = `
    <div id="quizQuestion" class="question-container">
      <div class="question-text">üìò ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ${currentQuestion + 1}/${questions.length}: ${formatQuestionText(q.question)}</div>
      ${imageHTML}
    </div>
  `;
  
  document.getElementById("quizQuestionContainer").innerHTML = quizQuestionHTML;
  
  const optionsDiv = document.getElementById("quizOptions");
  optionsDiv.innerHTML = '';
  
  for (let key in q.options) {
    const btn = document.createElement("button");
    btn.className = "btn-option";
    btn.textContent = `${key}: ${q.options[key]}`;
    btn.onclick = () => handleAnswer(key);
    optionsDiv.appendChild(btn);
  }
  
  const submitBtn = document.createElement("button");
  submitBtn.textContent = "‚úÖ ‡§ï‡•ç‡§µ‡§ø‡§ú ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç";
  submitBtn.className = "btn submit-btn";
  submitBtn.onclick = () => {
    if (confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ‡§ï‡•ç‡§µ‡§ø‡§ú ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?\n‡§Ü‡§™‡§®‡•á ${correctCount + incorrectCount} ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§ï‡•á ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡§ø‡§è ‡§π‡•à‡§Ç‡•§`)) {
      submitQuiz();
    }
  };
  optionsDiv.appendChild(submitBtn);
  
  document.getElementById("progress").innerHTML = `üìò ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ${currentQuestion + 1} / ${questions.length}`;
}

// ‡§â‡§§‡•ç‡§§‡§∞ ‡§∏‡§Ç‡§≠‡§æ‡§≤‡•á‡§Ç
function handleAnswer(selected) {
  const q = questions[currentQuestion];
  const optionsDiv = document.getElementById("quizOptions");
  
  document.querySelectorAll(".btn-option").forEach(btn => btn.disabled = true);
  
  for (let btn of optionsDiv.children) {
    if (btn.className !== "btn-option") continue;
    
    const key = btn.textContent[0];
    if (key === q.correct) {
      btn.style.backgroundColor = "#4CAF50";
      btn.style.color = "white";
    } else if (key === selected) {
      btn.style.backgroundColor = "#F44336";
      btn.style.color = "white";
    }
  }
  
  const expl = document.createElement("div");
  expl.className = "explanation";
  let explanationContent = `<strong>üìò ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ:</strong><br>${(q.explanation || '‡§ï‡•ã‡§à ‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§®‡§π‡•Ä‡§Ç ‡§¶‡•Ä ‡§ó‡§à ‡§π‡•à').replace(/\n/g, "<br>")}`;
  if (q.explanationImage) {
    explanationContent += `
      <div class="question-image-container">
        <img src="${q.explanationImage}" class="question-image" alt="‡§µ‡•ç‡§Ø‡§æ‡§ñ‡•ç‡§Ø‡§æ ‡§õ‡§µ‡§ø">
      </div>
    `;
  }
  expl.innerHTML = explanationContent;
  optionsDiv.appendChild(expl);
  
  if (selected === q.correct) {
    correctCount++;
  } else {
    incorrectCount++;
  }
  
  const nextBtn = document.createElement("button");
  nextBtn.textContent = currentQuestion < questions.length - 1 ? "‚û°Ô∏è ‡§Ö‡§ó‡§≤‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®" : "‚úÖ ‡§ï‡•ç‡§µ‡§ø‡§ú ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç";
  nextBtn.className = "btn";
  nextBtn.style.marginTop = "20px";
  nextBtn.onclick = () => {
    currentQuestion++;
    if (currentQuestion >= questions.length) submitQuiz();
    else showQuestion();
  };
  optionsDiv.appendChild(nextBtn);
}

// ‡§ï‡•ç‡§µ‡§ø‡§ú ‡§∏‡§¨‡§Æ‡§ø‡§ü ‡§ï‡§∞‡•á‡§Ç
function submitQuiz() {
  const totalAnswered = correctCount + incorrectCount;
  const totalQuestions = questions.length;
  const accuracyPercent = totalAnswered > 0 ? Math.round((correctCount / totalAnswered) * 100) : 0;
  
  document.getElementById("totalQuestions").textContent = totalQuestions;
  document.getElementById("correctAnswers").textContent = correctCount;
  document.getElementById("incorrectAnswers").textContent = incorrectCount;
  document.getElementById("accuracyPercent").textContent = `${accuracyPercent}%`;
  document.getElementById("bigAccuracy").textContent = `${accuracyPercent}%`;
  
  const ctx = document.getElementById('resultChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['‡§∏‡§π‡•Ä ‡§â‡§§‡•ç‡§§‡§∞', '‡§ó‡§≤‡§§ ‡§â‡§§‡•ç‡§§‡§∞'],
      datasets: [{
        data: [correctCount, incorrectCount],
        backgroundColor: ['#4CAF50', '#F44336'],
        borderWidth: 0
      }]
    },
    options: {
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom'
        }
      }
    }
  });
  
  document.getElementById("practiceSection").style.display = "none";
  document.getElementById("resultSection").style.display = "block";
}

// ‡§á‡§®‡§™‡•Å‡§ü ‡§∏‡•á‡§ï‡•ç‡§∂‡§® ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Ç
function showInputSection() {
  document.getElementById("resultSection").style.display = "none";
  document.getElementById("inputSection").style.display = "block";
  document.getElementById("pageTitle").textContent = "‚ûï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç";
}

// ‡§ï‡•ç‡§µ‡§ø‡§ú ‡§∞‡•Ä‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç
function resetQuiz() {
  currentQuestion = 0;
  correctCount = 0;
  incorrectCount = 0;
  
  document.getElementById("resultSection").style.display = "none";
  document.getElementById("practiceSection").style.display = "block";
  showQuestion();
}

// ‡§ï‡•ç‡§µ‡§ø‡§ú ‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç
async function populateQuiz() {
  const main = localStorage.getItem("selectedMain");
  const sub = localStorage.getItem("selectedSub");
  const mode = localStorage.getItem("quizMode") || "practice";
  const currentKey = `quiz_${main}_${sub}`;
  
  try {
    await openDB();
    questions = await loadQuizFromDB(currentKey);
    
    currentQuestion = 0;
    correctCount = 0;
    incorrectCount = 0;
    editIndex = -1;
    currentImage = null;
    currentExplanationImage = null;
    
    document.getElementById("pageTitle").textContent = mode === "input" ? "‚ûï ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§ú‡•ã‡§°‡§º‡•á‡§Ç" : "üéØ ‡§Ö‡§≠‡•ç‡§Ø‡§æ‡§∏";
    
    if (mode === "input") {
      document.getElementById("inputSection").style.display = "block";
      document.getElementById("questionCount").textContent = `üî¢ ‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: ${questions.length}`;
      showAllQuestions();
    } else {
      if (questions.length === 0) {
        alert("‚ùó ‡§ï‡•ã‡§à ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡§æ!");
        showInputSection();
      } else {
        document.getElementById("practiceSection").style.display = "block";
        showQuestion();
      }
    }
  } catch (error) {
    console.error('‡§ï‡•ç‡§µ‡§ø‡§ú ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
    alert('‡§ï‡•ç‡§µ‡§ø‡§ú ‡§≤‡•ã‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡•á‡§ú ‡§∞‡•Ä‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç‡•§');
  }
}

// JSON ‡§°‡•á‡§ü‡§æ ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç
async function importJSONData() {
  const fileInput = document.getElementById('jsonImportFile');
  if (!fileInput.files || fileInput.files.length === 0) {
    alert('‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï JSON ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç');
    return;
  }
  
  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = async function(e) {
    try {
      const jsonData = JSON.parse(e.target.result);
      
      if (!jsonData.questions || !Array.isArray(jsonData.questions)) {
        throw new Error('‡§Ö‡§Æ‡§æ‡§®‡•ç‡§Ø JSON ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™: ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§∏‡§∞‡§£‡•Ä ‡§ó‡§æ‡§Ø‡§¨ ‡§π‡•à');
      }
      
      if (!confirm(`‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§µ‡§æ‡§ï‡§à ${jsonData.questions.length} ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?\n\n‡§µ‡§ø‡§∑‡§Ø: ${jsonData.subject || '‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç'}\n‡§â‡§™‡§µ‡§ø‡§∑‡§Ø: ${jsonData.subtopic || '‡§®‡§ø‡§∞‡•ç‡§¶‡§ø‡§∑‡•ç‡§ü ‡§®‡§π‡•Ä‡§Ç'}`)) {
        return;
      }
      
      const currentKey = `quiz_${localStorage.getItem("selectedMain")}_${localStorage.getItem("selectedSub")}`;
      const existingQuestions = await loadQuizFromDB(currentKey) || [];
      const mergedQuestions = [...existingQuestions, ...jsonData.questions];
      
      await saveQuizToDB(currentKey, mergedQuestions);
      
      questions = mergedQuestions;
      document.getElementById("questionCount").textContent = `üî¢ ‡§ï‡•Å‡§≤ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: ${questions.length}`;
      showAllQuestions();
      
      alert(`‚úÖ ${jsonData.questions.length} ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§ø‡§è ‡§ó‡§è!`);
      
    } catch (error) {
      console.error('JSON ‡§Ü‡§Ø‡§æ‡§§ ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø:', error);
      alert(`‚ùó JSON ‡§´‡§º‡§æ‡§á‡§≤ ‡§Ü‡§Ø‡§æ‡§§ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: ${error.message}`);
    }
  };
  
  reader.readAsText(file);
}

// JSON ‡§°‡•á‡§ü‡§æ ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§∞‡•á‡§Ç
async function exportJSONData() {
  const main = localStorage.getItem("selectedMain") || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
  const sub = localStorage.getItem("selectedSub") || '‡§Ö‡§ú‡•ç‡§û‡§æ‡§§';
  
  const exportData = {
    subject: main,
    subtopic: sub,
    questions: questions,
    exportedAt: new Date().toISOString()
  };
  
  const jsonStr = JSON.stringify(exportData, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  
  const a = document.createElement('a');
  a.href = url;
  a.download = `‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§§‡•ç‡§§‡§∞‡•Ä_${main}_${sub}_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  alert(`üì§ ${questions.length} ‡§™‡•ç‡§∞‡§∂‡•ç‡§®‡•ã‡§Ç ‡§ï‡•ã JSON ‡§´‡§º‡§æ‡§á‡§≤ ‡§ï‡•á ‡§∞‡•Ç‡§™ ‡§Æ‡•á‡§Ç ‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§ ‡§ï‡§ø‡§Ø‡§æ ‡§ó‡§Ø‡§æ!`);
}

// ‡§ê‡§™ ‡§á‡§®‡§ø‡§∂‡§ø‡§Ø‡§≤‡§æ‡§á‡§ú‡§º ‡§ï‡§∞‡•á‡§Ç
window.onload = async function() {
  if (!localStorage.getItem("selectedMain")) {
    localStorage.setItem("selectedMain", "demo");
    localStorage.setItem("selectedSub", "demo");
    localStorage.setItem("quizMode", "input");
  }
  
  await populateQuiz();
  
  setTimeout(updateStorageUsage, 5000);
  
  document.getElementById('jsonImportFile').addEventListener('change', function() {
    document.querySelector('.upload-btn span').textContent = 
      `‡§ö‡§Ø‡§®‡§ø‡§§ ‡§´‡§º‡§æ‡§á‡§≤: ${this.files[0].name}`;
  });
};
</script>
</body>
</html>
