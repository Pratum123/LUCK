<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>विषय चयन</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6fb; margin:0; padding:0; }
    header { background: #3949ab; color: white; padding:15px; font-size:22px; text-align:center; position:sticky; top:0; z-index:100; }
    .container { max-width:500px; margin:20px auto; background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h1 { text-align:center; color:#3949ab; font-size:20px; margin:10px 0; }
    select,input,button { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; font-size:14px; box-sizing:border-box; }
    .btn { background:#3949ab; color:white; font-weight:bold; border:none; cursor:pointer; padding:10px; margin:5px 0; }
    .section { margin-bottom:20px; border:1px solid #e0e0e0; border-radius:8px; padding:12px; }
    .tab-container { display:flex; margin-bottom:15px; }
    .tab { flex:1; text-align:center; padding:8px; background:#e0e0e0; cursor:pointer; border-radius:5px 5px 0 0; margin:0 2px; }
    .tab.active { background:#3949ab; color:white; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
  </style>
</head>
<body>
  <header>Quiz App</header>
  <div class="container">
    <h1>विषय और उपविषय चयन</h1>
    <div class="tab-container">
      <div class="tab active" onclick="switchTab('select')">विषय चयन</div>
      <div class="tab" onclick="switchTab('add')">नया जोड़ें</div>
      <div class="tab" onclick="switchTab('manage')">प्रबंधन</div>
      <div class="tab" onclick="switchTab('backup')">बैकअप</div>
    </div>

    <div id="select-tab" class="tab-content active">
      <div class="section">
        <label><strong>मुख्य विषय:</strong></label>
        <select id="mainSubject" onchange="populateSubSubjects()"></select>
        <label><strong>उपविषय:</strong></label>
        <select id="subSubject"></select>
        <button class="btn" onclick="proceedToAction()">आगे बढ़ें</button>
      </div>
    </div>

    <div id="add-tab" class="tab-content">
      <div class="section">
        <input id="newMain" placeholder="मुख्य विषय">
        <input id="newSubs" placeholder="उपविषय (कॉमा से अलग करें)">
        <button class="btn" onclick="addNewSubject()">नया विषय जोड़ें</button>
      </div>
    </div>

    <div id="manage-tab" class="tab-content">
      <div class="section">
        <select id="manageMain" onchange="populateSubList()"></select>
        <select id="subList"></select>
        <input id="newSubInput" placeholder="नया उपविषय जोड़ें">
        <button class="btn" onclick="addSub()">उपविषय जोड़ें</button>
        <button class="btn" onclick="deleteSub()">उपविषय हटाएं</button>
      </div>
    </div>

    <div id="backup-tab" class="tab-content">
      <div class="section">
        <input type="file" id="importFile" accept=".json" onchange="handleLocalImportFile(event)">
        <button class="btn" onclick="exportData()">डेटा निर्यात करें</button>
      </div>
    </div>
  </div>

<script>
// मुख्य डेटा: क्रम बिल्कुल वही रहेगा!
let subjectsArray = [];  // [{ name: "gk", subs: ["भारत", "विश्व", "विज्ञान", "इतिहास"] }, ...]
let subjects = {};       // backward compatibility के लिए

const STORAGE_KEY = "quiz_subjects_array_v3";

function saveToStorage() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(subjectsArray));
}

function loadFromStorage() {
  const data = localStorage.getItem(STORAGE_KEY);
  if (data) {
    subjectsArray = JSON.parse(data);
  } else if (localStorage.getItem("quiz_subjects")) {
    // पुराना डेटा माइग्रेट करें
    const old = JSON.parse(localStorage.getItem("quiz_subjects") || "{}");
    subjectsArray = Object.keys(old).map(key => ({
      name: key,
      subs: old[key] || []
    }));
    saveToStorage();
  }

  // object भी बनाए रखें (पुराना कोड टूटे नहीं)
  subjects = {};
  subjectsArray.forEach(item => {
    subjects[item.name] = item.subs;
  });
}

function capitalize(str) {
  return str ? str.charAt(0).toUpperCase() + str.slice(1).replace(/_/g, ' ') : str;
}

// MAIN SUBJECTS - क्रम वही रहेगा
function populateMainSubjects() {
  const mainSelect = document.getElementById("mainSubject");
  const manageSelect = document.getElementById("manageMain");
  mainSelect.innerHTML = '<option value="">-- मुख्य विषय चुनें --</option>';
  manageSelect.innerHTML = '<option value="">-- मुख्य विषय चुनें --</option>';

  subjectsArray.forEach(item => {
    const displayName = capitalize(item.name);
    mainSelect.add(new Option(displayName, item.name));
    manageSelect.add(new Option(displayName, item.name));
  });
}

// SUB SUBJECTS - अब अल्फाबेट में नहीं, बिल्कुल वही क्रम जिसमें जोड़ा!
function populateSubSubjects() {
  const selectedMain = document.getElementById("mainSubject").value;
  const subSelect = document.getElementById("subSubject");
  subSelect.innerHTML = '<option value="">-- उपविषय चुनें --</option>';

  if (!selectedMain) return;

  const topic = subjectsArray.find(t => t.name === selectedMain);
  if (topic && topic.subs.length > 0) {
    topic.subs.forEach(sub => {
      subSelect.add(new Option(sub, sub));
    });
  }
}

function populateSubList() {
  const selectedMain = document.getElementById("manageMain").value;
  const subList = document.getElementById("subList");
  subList.innerHTML = '<option value="">-- उपविषय चुनें --</option>';

  if (!selectedMain) return;

  const topic = subjectsArray.find(t => t.name === selectedMain);
  if (topic && topic.subs.length > 0) {
    topic.subs.forEach(sub => {
      subList.add(new Option(sub, sub));
    });
  }
}

// नया विषय + उपविषय जोड़ें
function addNewSubject() {
  let mainName = document.getElementById("newMain").value.trim();
  if (!mainName) return alert("मुख्य विषय भरें!");

  const subsInput = document.getElementById("newSubs").value;
  const newSubs = subsInput.split(',').map(s => s.trim()).filter(Boolean);

  if (newSubs.length === 0) return alert("कम से कम एक उपविषय डालें!");

  mainName = mainName.toLowerCase().replace(/\s+/g, '_');

  if (subjectsArray.some(t => t.name === mainName)) {
    return alert("यह विषय पहले से मौजूद है!");
  }

  subjectsArray.push({ name: mainName, subs: newSubs });
  subjects[mainName] = newSubs;
  saveToStorage();

  document.getElementById("newMain").value = "";
  document.getElementById("newSubs").value = "";

  populateMainSubjects();
  alert("नया विषय और उपविषय सफलतापूर्वक जोड़े गए!");
  switchTab('select');
}

// उपविषय जोड़ें (Manage टैब)
function addSub() {
  const main = document.getElementById("manageMain").value;
  const newSub = document.getElementById("newSubInput").value.trim();

  if (!main || !newSub) return alert("सभी फ़ील्ड भरें!");
  if (subjects[main].includes(newSub)) return alert("पहले से मौजूद है!");

  const topic = subjectsArray.find(t => t.name === main);
  topic.subs.push(newSub);  // सिर्फ push → क्रम वही रहेगा
  subjects[main] = topic.subs;
  saveToStorage();

  document.getElementById("newSubInput").value = "";
  populateSubList();
  if (document.getElementById("mainSubject").value === main) populateSubSubjects();
  alert("उपविषय जोड़ा गया!");
}

// उपविषय हटाएं
function deleteSub() {
  const main = document.getElementById("manageMain").value;
  const sub = document.getElementById("subList").value;
  if (!main || !sub) return alert("उपविषय चुनें!");

  const topic = subjectsArray.find(t => t.name === main);
  topic.subs = topic.subs.filter(s => s !== sub);
  subjects[main] = topic.subs;
  saveToStorage();

  populateSubList();
  if (document.getElementById("mainSubject").value === main) populateSubSubjects();
  alert("उपविषय हटा दिया गया!");
}

function proceedToAction() {
  const main = document.getElementById("mainSubject").value;
  const sub = document.getElementById("subSubject").value;
  if (!main || !sub) return alert("दोनों चुनें!");
  localStorage.setItem("selectedMain", main);
  localStorage.setItem("selectedSub", sub);
  location.href = "action.html";
}

function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tab + '-tab').classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
}

// Export & Import
function exportData() {
  const data = {
    version: "3.0-order-preserved",
    subjectsArray: subjectsArray
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'quiz_backup_ordered_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function handleLocalImportFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.subjectsArray) {
        subjectsArray = data.subjectsArray;
      } else if (data.subjects) {
        const old = data.subjects;
        subjectsArray = Object.keys(old).map(k => ({name: k, subs: old[k]}));
      } else {
        return alert("गलत फॉर्मेट");
      }
      subjects = {};
      subjectsArray.forEach(t => subjects[t.name] = t.subs);
      saveToStorage();
      populateMainSubjects();
      alert("बैकअप सफलतापूर्वक लोड हुआ! क्रम भी सुरक्षित है");
    } catch (err) {
      alert("फ़ाइल में त्रुटि: " + err.message);
    }
  };
  reader.readAsText(file);
}

// पेज लोड होते ही सब सेट करें
window.onload = function() {
  loadFromStorage();
  populateMainSubjects();
};
</script>
</body>
</html>
