<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>विषय चयन</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6fb; margin:0; padding:0; }
    header { background: #3949ab; color: white; padding:15px; font-size:22px; text-align:center; position:sticky; top:0; z-index:100; }
    .container { max-width:500px; margin:20px auto; background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h1 { text-align:center; color:#3949ab; font-size:20px; margin:10px 0; }
    select,input,button { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; font-size:14px; box-sizing:border-box; }
    .btn { background:#3949ab; color:white; font-weight:bold; border:none; cursor:pointer; padding:10px; margin:5px 0; }
    .section { margin-bottom:20px; border:1px solid #e0e0e0; border-radius:8px; padding:12px; }
    .tab-container { display:flex; margin-bottom:15px; }
    .tab { flex:1; text-align:center; padding:8px; background:#e0e0e0; cursor:pointer; border-radius:5px 5px 0 0; margin:0 2px; }
    .tab.active { background:#3949ab; color:white; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    pre { font-size:12px; }
  </style>
</head>
<body>
  <header>Quiz App</header>
  <div class="container">
    <h1>विषय और उपविषय चयन</h1>
    <div class="tab-container">
      <div class="tab active" onclick="switchTab('select')">विषय चयन</div>
      <div class="tab" onclick="switchTab('add')">नया जोड़ें</div>
      <div class="tab" onclick="switchTab('manage')">प्रबंधन</div>
      <div class="tab" onclick="switchTab('backup')">बैकअप</div>
    </div>

    <!-- विषय चयन -->
    <div id="select-tab" class="tab-content active">
      <div class="section">
        <label><strong>मुख्य विषय:</strong></label>
        <select id="mainSubject" onchange="populateSubSubjects()"></select>
        <label><strong>उपविषय:</strong></label>
        <select id="subSubject"></select>
        <button class="btn" onclick="proceedToAction()">आगे बढ़ें</button>
      </div>
    </div>

    <!-- नया विषय जोड़ें -->
    <div id="add-tab" class="tab-content">
      <div class="section">
        <input id="newMain" placeholder="मुख्य विषय (जैसे: सामान्य ज्ञान)">
        <input id="newSubs" placeholder="उपविषय (कॉमा से अलग करें, जैसे: भारत, विश्व)">
        <button class="btn" onclick="addNewSubject()">नया विषय जोड़ें</button>
      </div>
    </div>

    <!-- उपविषय प्रबंधन -->
    <div id="manage-tab" class="tab-content">
      <div class="section">
        <select id="manageMain" onchange="populateSubList()"></select>
        <select id="subList"></select>
        <input id="newSubInput" placeholder="नया उपविषय जोड़ें">
        <button class="btn" onclick="addSub()">उपविषय जोड़ें</button>
        <button class="btn" onclick="deleteSub()">उपविषय हटाएं</button>
      </div>
    </div>

    <!-- बैकअप -->
    <div id="backup-tab" class="tab-content">
      <div class="section">
        <input type="file" id="importFile" accept=".json" onchange="handleLocalImportFile(event)">
        <button class="btn" onclick="exportData()">डेटा निर्यात करें</button>
        <p style="font-size:13px; color:#444; margin-top:10px;">
          नोट: पुराना डेटा भी सपोर्ट करता है। अब क्रम हमेशा आपका चुना हुआ रहेगा!
        </p>
      </div>
    </div>
  </div>

<script>
// नया सिस्टम: क्रम बरकरार रखने के लिए Array इस्तेमाल करेंगे
let subjectsArray = [];     // [{name: "gk", subs: ["भारत", "विश्व"]}, ...]
let subjects = {};          // पुराना object (बाकी कोड के लिए अभी भी रखा है)

// IndexedDB कॉन्फ़िगरेशन
const DB_NAME = 'QuizAppDB';
const DB_VERSION = 2;
const STORE_NAME = 'quizzes';
let db = null;

function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabName + '-tab').classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
}

function capitalize(str) { return str ? str.charAt(0).toUpperCase() + str.slice(1) : str; }

// IndexedDB खोलें
function openDB() {
  return new Promise((resolve, reject) => {
    if (db) return resolve(db);
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onerror = () => reject(req.error);
    req.onsuccess = () => { db = req.result; resolve(db); };
    req.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
  });
}

// DB से विषय निकालें (मर्ज करने के लिए)
async function loadSubjectsFromDB() {
  await openDB();
  return new Promise((resolve) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const set = new Set();
    const map = {};
    store.openCursor().onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor) {
        const val = cursor.value;
        let main = val.subject;
        let sub = val.subtopic || val.subtopicName;
        if (!main && val.id?.startsWith('quiz_')) {
          const parts = val.id.slice(5).split('_');
          main = parts[0];
          sub = parts.slice(1).join('_');
        }
        if (main) {
          set.add(main);
          if (!map[main]) map[main] = new Set();
          if (sub) map[main].add(sub);
        }
        cursor.continue();
      } else {
        resolve({ set, map });
      }
    };
  });
}

// माइग्रेशन + लोड
async function loadSubjects() {
  // 1. नया Array वाला डेटा लोड करें
  const savedArray = localStorage.getItem("quiz_subjects_array");
  if (savedArray) {
    subjectsArray = JSON.parse(savedArray);
  }

  // 2. अगर नया डेटा नहीं है, लेकिन पुराना object है → माइग्रेट करें
  if (subjectsArray.length === 0) {
    const old = localStorage.getItem("quiz_subjects");
    if (old) {
      const oldObj = JSON.parse(old);
      subjectsArray = Object.keys(oldObj).map(key => ({ name: key, subs: oldObj[key] || [] }));
      localStorage.setItem("quiz_subjects_array", JSON.stringify(subjectsArray));
      // पुराना object भी रखें (बैकवर्ड कम्पैटिबिलिटी)
      subjects = oldObj;
    }
  }

  // 3. Array से object बनाएं (बाकी कोड के लिए)
  subjects = {};
  subjectsArray.forEach(item => {
    subjects[item.name] = item.subs;
  });

  // 4. IndexedDB से भी मर्ज करें
  try {
    const { set, map } = await loadSubjectsFromDB();
    set.forEach(s => {
      if (!subjects[s]) {
        subjects[s] = [];
        subjectsArray.push({ name: s, subs: [] });
      }
      (map[s] || new Set()).forEach(sub => {
        if (!subjects[s].includes(sub)) {
          subjects[s].push(sub);
          subjectsArray.find(i => i.name === s).subs.push(sub);
        }
      });
    });
  } catch (e) { console.warn("DB से लोड करते समय त्रुटि:", e); }

  // डिफ़ॉल्ट डेटा (पहली बार)
  if (subjectsArray.length === 0) {
    subjectsArray = [
      { name: "economics", subs: ["Micro", "Macro"] },
      { name: "history", subs: ["Ancient", "Modern"] },
      { name: "geography", subs: ["India", "World"] }
    ];
    subjects = { economics: ["Micro","Macro"], history: ["Ancient","Modern"], geography: ["India","World"] };
  }

  saveToStorage(); // sync करें
}

function saveToStorage() {
  localStorage.setItem("quiz_subjects_array", JSON.stringify(subjectsArray));
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects)); // पुराना भी रखें
}

// Dropdown भरें — अब क्रम बिल्कुल वही रहेगा!
async function populateDropdowns() {
  await loadSubjects();

  const mainSelect = document.getElementById("mainSubject");
  const manageSelect = document.getElementById("manageMain");
  mainSelect.innerHTML = '<option value="">-- विषय चुनें --</option>';
  manageSelect.innerHTML = '<option value="">-- विषय चुनें --</option>';

  subjectsArray.forEach(item => {
    const display = capitalize(item.name.replace(/_/g, ' '));
    mainSelect.add(new Option(display, item.name));
    manageSelect.add(new Option(display, item.name));
  });
}

function populateSubSubjects() {
  const selected = document.getElementById("mainSubject").value;
  const subSelect = document.getElementById("subSubject");
  subSelect.innerHTML = '<option value="">-- उपविषय चुनें --</option>';
  if (selected && subjects[selected]) {
    subjects[selected].forEach(sub => {
      subSelect.add(new Option(sub, sub));
    });
  }
}

function populateSubList() {
  const selected = document.getElementById("manageMain").value;
  const list = document.getElementById("subList");
  list.innerHTML = '<option value="">-- उपविषय चुनें --</option>';
  if (selected && subjects[selected]) {
    subjects[selected].forEach(sub => list.add(new Option(sub, sub)));
  }
}

// नया विषय जोड़ें
function addNewSubject() {
  const name = document.getElementById("newMain").value.trim().toLowerCase().replace(/\s+/g, '_');
  const subsInput = document.getElementById("newSubs").value;
  const subs = subsInput.split(',').map(s => s.trim()).filter(Boolean);

  if (!name || subs.length === 0) return alert("सभी फ़ील्ड भरें!");

  if (subjectsArray.some(i => i.name === name)) return alert("यह विषय पहले से है!");

  subjectsArray.push({ name, subs });
  subjects[name] = subs;
  saveToStorage();

  document.getElementById("newMain").value = "";
  document.getElementById("newSubs").value = "";
  populateDropdowns();
  alert("नया विषय सफलतापूर्वक जोड़ा गया!");
  switchTab('select');
}

// बाकी फंक्शन वही
function addSub() {
  const main = document.getElementById("manageMain").value;
  const newSub = document.getElementById("newSubInput").value.trim();
  if (!main || !newSub) return alert("भरें!");
  const item = subjectsArray.find(i => i.name === main);
  if (item.subs.includes(newSub)) return alert("पहले से मौजूद है!");
  item.subs.push(newSub);
  subjects[main] = item.subs;
  saveToStorage();
  document.getElementById("newSubInput").value = "";
  populateSubList();
  populateSubSubjects();
  alert("उपविषय जोड़ा गया!");
}

function deleteSub() {
  const main = document.getElementById("manageMain").value;
  const sub = document.getElementById("subList").value;
  if (!main || !sub) return alert("चुनें!");
  const item = subjectsArray.find(i => i.name === main);
  item.subs = item.subs.filter(s => s !== sub);
  subjects[main] = item.subs;
  saveToStorage();
  populateSubList();
  populateSubSubjects();
  alert("उपविषय हटा दिया गया!");
}

function proceedToAction() {
  const main = document.getElementById("mainSubject").value;
  const sub = document.getElementById("subSubject").value;
  if (!main || !sub) return alert("विषय और उपविषय चुनें!");
  localStorage.setItem("selectedMain", main);
  localStorage.setItem("selectedSub", sub);
  location.href = "action.html";
}

// Export & Import (पुराना बैकअप भी सपोर्ट करता है)
function exportData() {
  const data = { subjectsArray, subjects, version: "2.0" };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'quiz_backup_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
}

function handleLocalImportFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const data = JSON.parse(ev.target.result);
      if (data.subjectsArray) {
        subjectsArray = data.subjectsArray;
        subjects = data.subjects || {};
        saveToStorage();
        populateDropdowns();
        alert("नया बैकअप सफलतापूर्वक लोड हुआ!");
      } else if (data.subjects) {
        // पुराना फॉर्मेट
        const old = data.subjects;
        subjectsArray = Object.keys(old).map(k => ({name: k, subs: old[k]}));
        subjects = old;
        saveToStorage();
        populateDropdowns();
        alert("पुराना बैकअप भी सफलतापूर्वक लोड हुआ!");
      } else {
        alert("गलत फॉर्मेट");
      }
    } catch (err) {
      alert("फ़ाइल पढ़ने में त्रुटि: " + err.message);
    }
  };
  reader.readAsText(file);
}

// लोड होते ही सब सेट करें
window.onload = () => {
  populateDropdowns();
};
</script>
</body>
</html>
