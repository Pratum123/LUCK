<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>ЁЯУЪ Quiz App - рд╡рд┐рд╖рдп рдЪрдпрди</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {font-family:'Segoe UI',sans-serif;background:#f4f6fb;margin:0;padding:0}
    header {background:#3949ab;color:white;padding:15px;font-size:22px;text-align:center;position:sticky;top:0;z-index:100}
    .container {max-width:500px;margin:20px auto;background:white;padding:15px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
    h1 {text-align:center;color:#3949ab;font-size:20px;margin:10px 0}
    select,input,button {width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;font-size:14px;box-sizing:border-box}
    .btn {background:#3949ab;color:white;font-weight:bold;border:none;cursor:pointer;padding:10px;margin:5px 0}
    .section {margin-bottom:20px;border:1px solid #e0e0e0;border-radius:8px;padding:12px}
    .tab-container {display:flex;flex-wrap:wrap;margin-bottom:15px}
    .tab {flex:1;text-align:center;padding:8px;background:#e0e0e0;cursor:pointer;border-radius:5px 5px 0 0;margin:2px;min-width:80px}
    .tab.active {background:#3949ab;color:white}
    .tab-content {display:none}
    .tab-content.active {display:block}
  </style>
</head>
<body>
  <header>ЁЯУЪ Quiz App</header>
  <div class="container">
    <h1>рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪрдпрди</h1>

    <div class="tab-container">
      <div class="tab active" onclick="switchTab('select')">рд╡рд┐рд╖рдп рдЪрдпрди</div>
      <div class="tab" onclick="switchTab('add')">рдирдпрд╛ рдЬреЛрдбрд╝реЗрдВ</div>
      <div class="tab" onclick="switchTab('manage')">рдкреНрд░рдмрдВрдзрди</div>
    </div>

    <!-- рд╡рд┐рд╖рдп рдЪрдпрди -->
    <div id="select-tab" class="tab-content active">
      <div class="section">
        <label><strong>рдореБрдЦреНрдп рд╡рд┐рд╖рдп:</strong></label>
        <select id="mainSubject" onchange="populateSubSubjects()"></select>
        <label><strong>рдЙрдкрд╡рд┐рд╖рдп:</strong></label>
        <select id="subSubject"></select>
        <button class="btn" onclick="proceedToAction()">ЁЯСЙ рдЖрдЧреЗ рдмрдврд╝реЗрдВ</button>
      </div>
    </div>

    <!-- рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ -->
    <div id="add-tab" class="tab-content">
      <div class="section">
        <input id="newMain" placeholder="рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдирд╛рдо">
        <input id="newSubs" placeholder="рдЙрдкрд╡рд┐рд╖рдп (рдХреЙрдорд╛ рд╕реЗ рдЕрд▓рдЧ рдХрд░реЗрдВ, рдЬреИрд╕реЗ: 1,2,3)">
        <button class="btn" onclick="addNewSubject()">ЁЯУВ рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛреЬреЗрдВ</button>
      </div>
    </div>

    <!-- рдкреНрд░рдмрдВрдзрди -->
    <div id="manage-tab" class="tab-content">
      <div class="section">
        <select id="manageMain" onchange="populateSubList()"></select>
        <select id="subList"></select>

        <input id="newSubInput" placeholder="рдирдпрд╛ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ">
        <button class="btn" onclick="addSub()">тЮХ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ</button>
        <button class="btn" onclick="deleteSub()">ЁЯЧСя╕П рдЙрдкрд╡рд┐рд╖рдп рд╣рдЯрд╛рдПрдВ</button>
        <button class="btn" onclick="renameSubtopic()">тЬПя╕П рдЙрдкрд╡рд┐рд╖рдп рдирд╛рдо рдмрджрд▓реЗрдВ</button>

        <hr>

        <input id="renameMainInput" placeholder="рдирдпрд╛ рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдирд╛рдо">
        <button class="btn" onclick="renameSubject()">тЬПя╕П рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдирд╛рдо рдмрджрд▓реЗрдВ</button>
      </div>
    </div>
  </div>

<script>
// ==================== рдЧреНрд▓реЛрдмрд▓ рд╡реИрд░рд┐рдПрдмрд▓ ====================
let subjects = {};
const DB_NAME = 'QuizAppDB';
const DB_VERSION = 2;
const STORE_NAME = 'quizzes';
let db = null;

// ==================== рд╣реЗрд▓реНрдкрд░ рдлрдВрдХреНрд╢рди ====================
function naturalSort(a, b) {
  return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
}

function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabName + '-tab').classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
}

// ==================== IndexedDB рдУрдкрди ====================
function openDB() {
  return new Promise((resolve, reject) => {
    if (db) return resolve(db);
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onsuccess = () => { db = req.result; resolve(db); };
    req.onerror = () => reject(req.error);
    req.onupgradeneeded = e => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
  });
}

// ==================== рдбреНрд░реЙрдкрдбрд╛рдЙрди рднрд░рдирд╛ ====================
async function populateDropdowns() {
  subjects = JSON.parse(localStorage.getItem("quiz_subjects") || "{}");

  // IndexedDB рд╕реЗ рднреА рд╕рдмреНрдЬреЗрдХреНрдЯ/рд╕рдмрдЯреЙрдкрд┐рдХ рд▓реЛрдб рдХрд░реЛ
  try {
    await openDB();
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    store.openCursor().onsuccess = e => {
      const cursor = e.target.result;
      if (cursor) {
        const d = cursor.value;
        let main = d.subject || (d.id && d.id.split('_')[1]);
        let sub = d.subtopic || d.subtopicName || (d.id && d.id.split('_')[2]);
        if (main && sub) {
          if (!subjects[main]) subjects[main] = [];
          if (!subjects[main].includes(sub)) subjects[main].push(sub);
        }
        cursor.continue();
      }
    };
    await tx.done;
  } catch (e) { console.log(e); }

  const mainSel = document.getElementById("mainSubject");
  const manageSel = document.getElementById("manageMain");
  mainSel.innerHTML = manageSel.innerHTML = '<option>-- рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>';

  Object.keys(subjects).sort(naturalSort).forEach(key => {
    mainSel.add(new Option(key, key));
    manageSel.add(new Option(key, key));
  });
}

function populateSubSubjects() {
  const sel = document.getElementById("subSubject");
  sel.innerHTML = '<option>-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>';
  const main = document.getElementById("mainSubject").value;
  (subjects[main] || []).sort(naturalSort).forEach(s => sel.add(new Option(s, s)));
}

function populateSubList() {
  const list = document.getElementById("subList");
  list.innerHTML = '<option>-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>';
  const main = document.getElementById("manageMain").value;
  (subjects[main] || []).sort(naturalSort).forEach(s => list.add(new Option(s, s)));
}

// ==================== рдЙрдкрд╡рд┐рд╖рдп рдирд╛рдо рдмрджрд▓реЗрдВ (рдЕрдм 100% рдХрд╛рдо рдХрд░реЗрдЧрд╛) ====================
async function renameSubtopic() {
  const main = document.getElementById("manageMain").value;
  const oldSub = document.getElementById("subList").value;
  if (!main || !oldSub) return alert("тЭЧ рдкрд╣рд▓реЗ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ");

  const newSub = prompt(`рдкреБрд░рд╛рдирд╛ рдирд╛рдо: "${oldSub}"\nрдирдпрд╛ рдирд╛рдо рдбрд╛рд▓реЗрдВ:`, oldSub)?.trim();
  if (!newSub || newSub === oldSub) return;
  if (subjects[main].includes(newSub)) return alert("тЪая╕П рдпрд╣ рдирд╛рдо рдкрд╣рд▓реЗ рд╕реЗ рд╣реИ!");

  // 1. localStorage рдЕрдкрдбреЗрдЯ
  subjects[main] = subjects[main].filter(x => x !== oldSub);
  subjects[main].push(newSub);
  subjects[main].sort(naturalSort);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));

  // 2. IndexedDB рдЕрдкрдбреЗрдЯ
  try {
    await openDB();
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);
    let updated = 0;

    store.openCursor().onsuccess = e => {
      const cursor = e.target.result;
      if (cursor) {
        const d = cursor.value;
        let changed = false;

        if (d.subject === main) {
          if (d.subtopic === oldSub) { d.subtopic = newSub; changed = true; }
          if (d.subtopicName === oldSub) { d.subtopicName = newSub; changed = true; }
        }

        // id рдореЗрдВ рднреА рдкреБрд░рд╛рдирд╛ subtopic рд╣реЛ рддреЛ рдмрджрд▓ рджреЛ
        if (d.id && d.id.startsWith(`quiz_${main}_${oldSub}_`)) {
          const rest = d.id.slice(`quiz |

_${main}_${oldSub}_`.length);
          d.id = `quiz_${main}_${newSub}_${rest}`;
          changed = true;
        }

        if (changed) {
          cursor.update(d);
          updated++;
        }
        cursor.continue();
      }
    };

    await tx.done;

    populateSubList();
    populateSubSubjects();
    alert(`тЬЕ "${oldSub}" тЖТ "${newSub}" рд╣реЛ рдЧрдпрд╛!\n${updated} рдкреНрд░рд╢реНрди рднреА рдирдП рдирд╛рдо рдкрд░ рдЖ рдЧрдПред`);
  } catch (err) {
    console.error(err);
    alert("тЭМ рдбреЗрдЯрд╛рдмреЗрд╕ рдЕрдкрдбреЗрдЯ рдореЗрдВ рддреНрд░реБрдЯрд┐");
  }
}

// ==================== рдмрд╛рдХреА рдлрдВрдХреНрд╢рди ====================
function addNewSubject() {
  const main = document.getElementById("newMain").value.trim();
  const subs = document.getElementById("newSubs").value.split(',').map(s => s.trim()).filter(Boolean);
  if (!main || subs.length === 0) return alert("тЭЧ рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдФрд░ рдХрдо рд╕реЗ рдХрдо рдПрдХ рдЙрдкрд╡рд┐рд╖рдп рднрд░реЗрдВ");
  subjects[main] = (subjects[main] || []).concat(subs);
  subjects[main].sort(naturalSort);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  document.getElementById("newMain").value = "";
  document.getElementById("newSubs").value = "";
  populateDropdowns();
  alert("тЬЕ рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛!");
  switchTab('select');
}

function addSub() {
  const main = document.getElementById("manageMain").value;
  const sub = document.getElementById("newSubInput").value.trim();
  if (!main || !sub) return alert("тЭЧ рднрд░реЗрдВ");
  if (subjects[main].includes(sub)) return alert("тЪая╕П рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж");
  subjects[main].push(sub);
  subjects[main].sort(naturalSort);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  document.getElementById("newSubInput").value = "";
  populateSubList();
  populateSubSubjects();
  alert("тЬЕ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛");
}

function deleteSub() {
  if (!confirm("тЪая╕П рдЙрдкрд╡рд┐рд╖рдп рдФрд░ рдЙрд╕рдХрд╛ рд╕рд╛рд░рд╛ рдбреЗрдЯрд╛ рд╣рдореЗрд╢рд╛ рдХреЗ рд▓рд┐рдП рд╣рдЯ рдЬрд╛рдПрдЧрд╛!")) return;
  const main = document.getElementById("manageMain").value;
  const sub = document.getElementById("subList").value;
  subjects[main] = subjects[main].filter(x => x !== sub);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  populateSubList();
  populateSubSubjects();
  alert("ЁЯЧСя╕П рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛");
}

function renameSubject() {
  const oldName = document.getElementById("manageMain").value;
  const newName = document.getElementById("renameMainInput").value.trim();
  if (!oldName || !newName) return alert("тЭЧ рднрд░реЗрдВ");
  if (subjects[newName]) return alert("тЪая╕П рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж");
  subjects[newName] = subjects[oldName];
  delete subjects[oldName];
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  document.getElementById("renameMainInput").value = "";
  populateDropdowns();
  alert("тЬЕ рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдирд╛рдо рдмрджрд▓рд╛ рдЧрдпрд╛");
}

function proceedToAction() {
  const main = document.getElementById("mainSubject").value;
  const sub = document.getElementById("subSubject").value;
  if (!main || !sub) return alert("тЪая╕П рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ");
  localStorage.setItem("selectedMain", main);
  localStorage.setItem("selectedSub", sub);
  location.href = "action.html";
}

// ==================== рдЗрдирд┐рд╢рд┐рдпрд▓ рд▓реЛрдб ====================
window.onload = populateDropdowns;
</script>
</body>
</html>
