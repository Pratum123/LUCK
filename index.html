<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>ЁЯУЪ рд╡рд┐рд╖рдп рдЪрдпрди</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6fb; margin:0; padding:0; }
    header { background: #3949ab; color: white; padding:15px; font-size:22px; text-align:center; position:sticky; top:0; z-index:100; }
    .container { max-width:500px; margin:20px auto; background:white; padding:15px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h1 { text-align:center; color:#3949ab; font-size:20px; margin:10px 0; }
    select,input,button { width:100%; padding:10px; margin:8px 0; border-radius:6px; border:1px solid #ccc; font-size:14px; box-sizing:border-box; }
    .btn { background:#3949ab; color:white; font-weight:bold; border:none; cursor:pointer; padding:10px; margin:5px 0; }
    .section { margin-bottom:20px; border:1px solid #e0e0e0; border-radius:8px; padding:12px; }
    .tab-container { display:flex; margin-bottom:15px; flex-wrap:wrap; }
    .tab { flex:1; text-align:center; padding:8px; background:#e0e0e0; cursor:pointer; border-radius:5px 5px 0 0; margin:2px; min-width:80px; }
    .tab.active { background:#3949ab; color:white; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }
    pre { font-size:12px; }
  </style>
</head>
<body>
  <header>ЁЯУЪ Quiz App</header>
  <div class="container">
    <h1>ЁЯУЪ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪрдпрди</h1>
    <div class="tab-container">
      <div class="tab active" onclick="switchTab('select')">рд╡рд┐рд╖рдп рдЪрдпрди</div>
      <div class="tab" onclick="switchTab('add')">рдирдпрд╛ рдЬреЛрдбрд╝реЗрдВ</div>
      <div class="tab" onclick="switchTab('manage')">рдкреНрд░рдмрдВрдзрди</div>
      <div class="tab" onclick="switchTab('backup')">рдмреИрдХрдЕрдк</div>
    </div>

    <!-- рд╡рд┐рд╖рдп рдЪрдпрди -->
    <div id="select-tab" class="tab-content active">
      <div class="section">
        <label><strong>рдореБрдЦреНрдп рд╡рд┐рд╖рдп:</strong></label>
        <select id="mainSubject" onchange="populateSubSubjects()"></select>
        <label><strong>рдЙрдкрд╡рд┐рд╖рдп:</strong></label>
        <select id="subSubject"></select>
        <button class="btn" onclick="proceedToAction()">ЁЯСЙ рдЖрдЧреЗ рдмрдврд╝реЗрдВ</button>
      </div>
    </div>

    <!-- рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ -->
    <div id="add-tab" class="tab-content">
      <div class="section">
        <input id="newMain" placeholder="рдореБрдЦреНрдп рд╡рд┐рд╖рдп">
        <input id="newSubs" placeholder="рдЙрдкрд╡рд┐рд╖рдп (рдХреЙрдорд╛ рд╕реЗ рдЕрд▓рдЧ рдХрд░реЗрдВ)">
        <button class="btn" onclick="addNewSubject()">ЁЯУВ рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛреЬреЗрдВ</button>
      </div>
    </div>

    <!-- рдЙрдкрд╡рд┐рд╖рдп рдкреНрд░рдмрдВрдзрди -->
    <div id="manage-tab" class="tab-content">
      <div class="section">
        <select id="manageMain" onchange="populateSubList()"></select>
        <select id="subList"></select>
        
        <input id="newSubInput" placeholder="рдирдпрд╛ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ">
        <button class="btn" onclick="addSub()">тЮХ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ</button>
        <button class="btn" onclick="deleteSub()">ЁЯЧСя╕П рдЙрдкрд╡рд┐рд╖рдп рд╣рдЯрд╛рдПрдВ</button>
        <button class="btn" onclick="renameSubtopic()">тЬПя╕П рдЙрдкрд╡рд┐рд╖рдп рдирд╛рдо рдмрджрд▓реЗрдВ</button> <!-- рдирдпрд╛ рдмрдЯрди -->
        
        <hr>
        <input id="renameMainInput" placeholder="рдирдпрд╛ рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдирд╛рдо рд▓рд┐рдЦреЗрдВ">
        <button class="btn" onclick="renameSubject()">тЬПя╕П рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдирд╛рдо рдмрджрд▓реЗрдВ</button>
      </div>
    </div>

    <!-- рдмреИрдХрдЕрдк -->
    <div id="backup-tab" class="tab-content">
      <div class="section">
        <input type="file" id="importFile" accept=".json" onchange="handleLocalImportFile(event)">
        <button class="btn" onclick="exportData()">ЁЯУе рдбреЗрдЯрд╛ рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдВ</button>
      </div>
    </div>
  </div>

<script>
/* ===============================
   GLOBAL + DEFAULT SETTINGS
================================ */
let subjects = {};
const DB_NAME = 'QuizAppDB';
const DB_VERSION = 2;
const STORE_NAME = 'quizzes';
let db = null;

/* Natural Sort тАФ 1,2,3,10, A,B,C */
function naturalSort(a, b) {
  return a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' });
}

function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById(tabName + '-tab').classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
}

function capitalize(str){ return str ? str.charAt(0).toUpperCase() + str.slice(1) : str; }

/* ===============================
   IndexedDB Open
================================ */
function openDB() {
  return new Promise((resolve, reject) => {
    if (db) return resolve(db);
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onerror = (e) => reject(e.target.error);
    request.onsuccess = (e) => { db = e.target.result; resolve(db); };
    request.onupgradeneeded = (e) => {
      db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
      }
    };
  });
}

/* ===============================
   Load Subjects From IndexedDB
================================ */
async function loadSubjectsFromDB() {
  await openDB();
  return new Promise((resolve) => {
    const tx = db.transaction(STORE_NAME, 'readonly');
    const store = tx.objectStore(STORE_NAME);
    const subjectsSet = new Set();
    const subtopicsMap = {};
    store.openCursor().onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor) {
        const item = cursor.value;
        let main = item.subject || null;
        let sub = item.subtopic || item.subtopicName || null;
        if (!main || !sub) {
          if (item.id.startsWith("quiz_")) {
            const rest = item.id.slice(5);
            const idx = rest.indexOf("_");
            if (idx > 0) {
              main = main || rest.slice(0, idx);
              sub = sub || rest.slice(idx + 1);
            }
          }
        }
        if (main) {
          subjectsSet.add(main);
          if (!subtopicsMap[main]) subtopicsMap[main] = new Set();
          if (sub) subtopicsMap[main].add(sub);
        }
        cursor.continue();
      } else {
        resolve({ subjectsSet, subtopicsMap });
      }
    };
  });
}

/* ===============================
   Populate Dropdowns
================================ */
async function populateDropdowns() {
  const ls = JSON.parse(localStorage.getItem("quiz_subjects") || "{}");
  subjects = Object.keys(ls).length ? ls : subjects;
  try {
    const { subjectsSet, subtopicsMap } = await loadSubjectsFromDB();
    subjectsSet.forEach(s => {
      if (!subjects[s]) subjects[s] = [];
      const subs = Array.from(subtopicsMap[s] || []);
      subs.forEach(st => { if (!subjects[s].includes(st)) subjects[s].push(st); });
    });
  } catch {}

  const main = document.getElementById("mainSubject");
  const manage = document.getElementById("manageMain");
  main.innerHTML = ""; manage.innerHTML = "";
  main.appendChild(new Option("-- рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --",""));
  manage.appendChild(new Option("-- рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --",""));

  Object.keys(subjects).sort(naturalSort).forEach(key => {
    main.appendChild(new Option(capitalize(key), key));
    manage.appendChild(new Option(capitalize(key), key));
  });
}

function populateSubSubjects() {
  const subject = document.getElementById("mainSubject").value;
  const subs = subjects[subject] || [];
  const subSelect = document.getElementById("subSubject");
  subSelect.innerHTML = "";
  subSelect.appendChild(new Option("-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --",""));
  subs.sort(naturalSort).forEach(sub => subSelect.appendChild(new Option(sub, sub)));
}

function populateSubList() {
  const subject = document.getElementById("manageMain").value;
  const list = document.getElementById("subList");
  list.innerHTML = "";
  list.appendChild(new Option("-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --", ""));
  if (subjects[subject])
    subjects[subject].sort(naturalSort).forEach(sub => list.appendChild(new Option(sub, sub)));
}

/* ===============================
   Add / Delete / Rename Subject & Subtopic
================================ */
function addNewSubject() {
  const newMain = document.getElementById("newMain").value.trim();
  const newSubs = document.getElementById("newSubs").value.split(',').map(s => s.trim()).filter(Boolean);
  if (!newMain || newSubs.length === 0) return alert("тЭЧ рдХреГрдкрдпрд╛ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рднрд░реЗрдВ");
  if (!subjects[newMain]) subjects[newMain] = [];
  newSubs.forEach(s => { if (!subjects[newMain].includes(s)) subjects[newMain].push(s); });
  subjects[newMain].sort(naturalSort);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  document.getElementById("newMain").value = "";
  document.getElementById("newSubs").value = "";
  populateDropdowns();
  alert("тЬЕ рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛!");
  switchTab('select');
}

function addSub() {
  const subject = document.getElementById("manageMain").value;
  const newSub = document.getElementById("newSubInput").value.trim();
  if (!subject || !newSub) return alert("тЭЧ рдХреГрдкрдпрд╛ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рднрд░реЗрдВ");
  if (subjects[subject].includes(newSub)) return alert("тЪая╕П рдпрд╣ рдЙрдкрд╡рд┐рд╖рдп рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИ");
  subjects[subject].push(newSub);
  subjects[subject].sort(naturalSort);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  document.getElementById("newSubInput").value = "";
  populateSubList();
  populateSubSubjects();
  alert("тЬЕ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛!");
}

function deleteSub() {
  const subject = document.getElementById("manageMain").value;
  const sub = document.getElementById("subList").value;
  if (!subject || !sub) return alert("тЭЧ рдХреГрдкрдпрд╛ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ");
  subjects[subject] = subjects[subject].filter(s => s !== sub);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  populateSubList();
  populateSubSubjects();
  alert("ЁЯЧСя╕П рдЙрдкрд╡рд┐рд╖рдп рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛!");
}

/* ===== рдЙрдкрд╡рд┐рд╖рдп рдХрд╛ рдирд╛рдо рдмрджрд▓реЗрдВ (рдирдпрд╛ рдлреАрдЪрд░) ===== */
function renameSubtopic() {
  const subject = document.getElementById("manageMain").value;
  const oldSub = document.getElementById("subList").value;

  if (!subject || !oldSub) return alert("тЭЧ рдкрд╣рд▓реЗ рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ");

  const newSubName = prompt(`рдкреБрд░рд╛рдирд╛ рдирд╛рдо: "${oldSub}"\nрдирдпрд╛ рдЙрдкрд╡рд┐рд╖рдп рдирд╛рдо рд▓рд┐рдЦреЗрдВ:`, oldSub);
  if (newSubName === null) return; // cancel
  const newSub = newSubName.trim();
  if (!newSub) return alert("тЭЧ рдирдпрд╛ рдирд╛рдо рдЦрд╛рд▓реА рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛");
  if (subjects[subject].includes(newSub)) return alert("тЪая╕П рдпрд╣ рдЙрдкрд╡рд┐рд╖рдп рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИ!");

  // рдкреБрд░рд╛рдирд╛ рд╣рдЯрд╛рдУ, рдирдпрд╛ рдЬреЛрдбрд╝реЛ, рдлрд┐рд░ рд╕реЗ рд╕реЙрд░реНрдЯ рдХрд░реЛ
  subjects[subject] = subjects[subject].filter(s => s !== oldSub);
  subjects[subject].push(newSub);
  subjects[subject].sort(naturalSort);

  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  populateSubList();
  populateSubSubjects();
  alert(`тЬЕ рдЙрдкрд╡рд┐рд╖рдп "${oldSub}" рдХрд╛ рдирд╛рдо рдмрджрд▓рдХрд░ "${newSub}" рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛!`);
}

/* ===== рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдХрд╛ рдирд╛рдо рдмрджрд▓реЗрдВ ===== */
function renameSubject() {
  const oldName = document.getElementById("manageMain").value;
  const newName = document.getElementById("renameMainInput").value.trim();
  if (!oldName || !newName) return alert("тЭЧ рдХреГрдкрдпрд╛ рдкреБрд░рд╛рдирд╛ рдФрд░ рдирдпрд╛ рд╡рд┐рд╖рдп рдирд╛рдо рднрд░реЗрдВ");
  if (subjects[newName]) return alert("тЪая╕П рдпрд╣ рд╡рд┐рд╖рдп рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИ!");
  subjects[newName] = subjects[oldName];
  delete subjects[oldName];
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  alert(`тЬЕ "${oldName}" рдХрд╛ рдирд╛рдо рдмрджрд▓рдХрд░ "${newName}" рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛!`);
  document.getElementById("renameMainInput").value = "";
  populateDropdowns();
}

/* ===============================
   Open next page
================================ */
function proceedToAction() {
  const main = document.getElementById("mainSubject").value;
  const sub = document.getElementById("subSubject").value;
  if (!main || !sub) return alert("тЪая╕П рдХреГрдкрдпрд╛ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ!");
  localStorage.setItem("selectedMain", main);
  localStorage.setItem("selectedSub", sub);
  window.location.href = "action.html";
}

/* ===============================
   IMPORT & EXPORT (рдЖрдк рдмрд╛рдж рдореЗрдВ рдкреВрд░рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)
================================ */
function handleLocalImportFile(evt) {
  alert("тЪая╕П Import рдлреАрдЪрд░ рдЕрднреА рдбреЗрд╡рд▓рдкрдореЗрдВрдЯ рдореЗрдВ рд╣реИред");
}
function exportData() {
  alert("тЪая╕П Export рдлреАрдЪрд░ рдЕрднреА рдбреЗрд╡рд▓рдкрдореЗрдВрдЯ рдореЗрдВ рд╣реИред");
}

/* ===============================
   INIT
================================ */
window.addEventListener('load', async () => {
  subjects = JSON.parse(localStorage.getItem("quiz_subjects") || "{}");
  await populateDropdowns();
});
</script>
</body>
</html>
