<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ЁЯУЪ рд╡рд┐рд╖рдп рдЪрдпрди</title>
  <style>
    body{font-family:'Segoe UI',sans-serif;background:#f4f6fb;margin:0;padding:0}
    header{background:#3949ab;color:white;padding:15px;font-size:22px;text-align:center;position:sticky;top:0;z-index:100}
    .container{max-width:500px;margin:20px auto;background:white;padding:15px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
    h1{text-align:center;color:#3949ab;font-size:20px;margin:10px 0}
    select,input,button{width:100%;padding:12px;margin:8px 0;border-radius:6px;border:1px solid #ccc;font-size:16px;box-sizing:border-box}
    .btn{background:#3949ab;color:white;font-weight:bold;border:none;cursor:pointer;padding:12px;margin:8px 0;border-radius:6px}
    .btn:hover{background:#283593}
    .section{margin-bottom:20px;border:1px solid #e0e0e0;border-radius:8px;padding:15px}
    .tab-container{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:15px;justify-content:center}
    .tab{flex:1 1 100px;text-align:center;padding:10px;background:#e0e0e0;cursor:pointer;border-radius:8px 8px 0 0;min-width:80px;font-size:14px}
    .tab.active{background:#3949ab;color:white}
    .tab-content{display:none;padding:10px 0}
    .tab-content.active{display:block}
    @media (max-width: 480px){
      .tab{font-size:15px;padding:12px}
      select,input,button{font-size:16px}
    }
  </style>
</head>
<body>
  <header>ЁЯУЪ Quiz App</header>
  <div class="container">
    <h1>рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪрдпрди</h1>

    <div class="tab-container">
      <div class="tab active" onclick="switchTab('select')">рд╡рд┐рд╖рдп рдЪрдпрди</div>
      <div class="tab" onclick="switchTab('add')">рдирдпрд╛ рдЬреЛрдбрд╝реЗрдВ</div>
      <div class="tab" onclick="switchTab('manage')">рдкреНрд░рдмрдВрдзрди</div>
      <div class="tab" onclick="switchTab('backup')">рдмреИрдХрдЕрдк</div>
    </div>

    <!-- рд╡рд┐рд╖рдп рдЪрдпрди рдЯреИрдм -->
    <div id="select-tab" class="tab-content active">
      <div class="section">
        <label><strong>рдореБрдЦреНрдп рд╡рд┐рд╖рдп:</strong></label>
        <select id="mainSubject">
          <option value="">-- рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>
        </select>

        <label><strong>рдЙрдкрд╡рд┐рд╖рдп:</strong></label>
        <select id="subSubject">
          <option value="">-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>
        </select>

        <button class="btn" onclick="proceedToAction()">ЁЯСЙ рдЖрдЧреЗ рдмрдврд╝реЗрдВ</button>
      </div>
    </div>

    <!-- рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ рдЯреИрдм -->
    <div id="add-tab" class="tab-content">
      <div class="section">
        <input id="newMain" placeholder="рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдХрд╛ рдирд╛рдо">
        <input id="newSubs" placeholder="рдЙрдкрд╡рд┐рд╖рдп (рдХреЙрдорд╛ рд╕реЗ рдЕрд▓рдЧ рдХрд░реЗрдВ, рдЬреИрд╕реЗ: рдЪреИрдкреНрдЯрд░-1, рдЪреИрдкреНрдЯрд░-2)">
        <button class="btn" onclick="addNewSubject()">тЮХ рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛреЬреЗрдВ</button>
      </div>
    </div>

    <!-- рдкреНрд░рдмрдВрдзрди рдЯреИрдм -->
    <div id="manage-tab" class="tab-content">
      <div class="section">
        <select id="manageMain">
          <option value="">-- рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>
        </select>

        <select id="subList">
          <option value="">-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>
        </select>

        <input id="newSubInput" placeholder="рдирдпрд╛ рдЙрдкрд╡рд┐рд╖рдп рдирд╛рдо">
        <button class="btn" onclick="addSub()">тЮХ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ</button>
        <button class="btn" onclick="deleteSub()">ЁЯЧСя╕П рдЙрдкрд╡рд┐рд╖рдп рд╣рдЯрд╛рдПрдВ</button>
        <button class="btn" onclick="renameSubtopic()">тЬПя╕П рдЙрдкрд╡рд┐рд╖рдп рдирд╛рдо рдмрджрд▓реЗрдВ</button>

        <hr style="margin:20px 0">

        <input id="renameMainInput" placeholder="рдирдпрд╛ рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдирд╛рдо">
        <button class="btn" onclick="renameSubject()">тЬПя╕П рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдирд╛рдо рдмрджрд▓реЗрдВ</button>
      </div>
    </div>

    <!-- рдмреИрдХрдЕрдк рдЯреИрдм -->
    <div id="backup-tab" class="tab-content">
      <div class="section">
        <button class="btn" onclick="exportData()">ЁЯУе рдбреЗрдЯрд╛ рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдВ (JSON)</button>
        <button class="btn" onclick="importData()" style="margin-top:10px;background:#43a047">ЁЯУВ рдбреЗрдЯрд╛ рдЖрдпрд╛рдд рдХрд░реЗрдВ</button>
      </div>
    </div>
  </div>

<script>
let subjects = {};
const DB_NAME = 'QuizAppDB', DB_VERSION = 2, STORE_NAME = 'quizzes';
let db = null;

function naturalSort(a,b){return a.localeCompare(b,{numeric:true,sensitivity:'base'});}

function switchTab(t){
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(c=>c.classList.remove('active'));
  document.getElementById(t+'-tab').classList.add('active');
  document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');
}

function openDB(){
  return new Promise((res,rej)=>{
    if(db) return res(db);
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onsuccess = e => {db = e.target.result; res(db);};
    req.onerror = () => rej(req.error);
    req.onupgradeneeded = e => {
      db = e.target.result;
      if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, {keyPath:'id'});
    };
  });
}

async function loadSubjectsFromDB(){
  await openDB();
  return new Promise(res=>{
    const tx = db.transaction(STORE_NAME,'readonly'), store = tx.objectStore(STORE_NAME);
    const set = new Set(), map = {};
    store.openCursor().onsuccess = e => {
      const c = e.target.result;
      if(c){
        const d = c.value;
        let main = d.subject, sub = d.subtopic || d.subtopicName;
        if(!main && d.id && d.id.startsWith('quiz_')){
          const p = d.id.split('_');
          if(p.length >= 3){ main = p[1]; sub = p[2]; }
        }
        if(main){ set.add(main); if(!map[main]) map[main] = new Set(); if(sub) map[main].add(sub); }
        c.continue();
      }else res({subjectsSet:set, subtopicsMap:map});
    };
  });
}

async function populateDropdowns(){
  subjects = JSON.parse(localStorage.getItem("quiz_subjects") || "{}");
  try{
    const {subjectsSet, subtopicsMap} = await loadSubjectsFromDB();
    subjectsSet.forEach(s=>{ if(!subjects[s]) subjects[s] = []; });
    Object.keys(subtopicsMap).forEach(main=>{
      if(!subjects[main]) subjects[main] = [];
      subtopicsMap[main].forEach(st=>{ if(!subjects[main].includes(st)) subjects[main].push(st); });
    });
  }catch(e){console.log(e);}

  const m1 = document.getElementById("mainSubject");
  const m2 = document.getElementById("manageMain");

  m1.innerHTML = `<option value="">-- рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>`;
  m2.innerHTML = `<option value="">-- рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>`;

  Object.keys(subjects).sort(naturalSort).forEach(k=>{
    m1.add(new Option(k,k));
    m2.add(new Option(k,k));
  });
}

function populateSubSubjects(){
  const sub = document.getElementById("subSubject");
  sub.innerHTML = `<option value="">-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>`;
  const s = document.getElementById("mainSubject").value;
  (subjects[s] || []).sort(naturalSort).forEach(x => sub.add(new Option(x,x)));
}

function populateSubList(){
  const list = document.getElementById("subList");
  list.innerHTML = `<option value="">-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>`;
  const s = document.getElementById("manageMain").value;
  (subjects[s] || []).sort(naturalSort).forEach(x => list.add(new Option(x,x)));
}

function addNewSubject(){
  const newMain = document.getElementById("newMain").value.trim();
  const subs = document.getElementById("newSubs").value.split(',').map(s=>s.trim()).filter(Boolean);
  if(!newMain || subs.length===0) return alert("тЭЧ рджреЛрдиреЛрдВ рдлреАрд▓реНрдб рднрд░реЗрдВ");
  if(subjects[newMain]) return alert("тЪая╕П рдпрд╣ рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИ");
  subjects[newMain] = subs;
  subjects[newMain].sort(naturalSort);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  populateDropdowns();
  alert("тЬЕ рдирдпрд╛ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛреЬ рджрд┐рдП рдЧрдП!");
  document.getElementById("newMain").value = "";
  document.getElementById("newSubs").value = "";
  switchTab('select');
}

function addSub(){
  const s = document.getElementById("manageMain").value;
  const n = document.getElementById("newSubInput").value.trim();
  if(!s || !n) return alert("тЭЧ рд╡рд┐рд╖рдп рдФрд░ рдирд╛рдо рднрд░реЗрдВ");
  if(subjects[s].includes(n)) return alert("тЪая╕П рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИ");
  subjects[s].push(n);
  subjects[s].sort(naturalSort);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  document.getElementById("newSubInput").value = "";
  populateSubList();
  populateSubSubjects();
  alert("тЬЕ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛреЬрд╛ рдЧрдпрд╛");
}

function deleteSub(){
  if(!confirm("тЪая╕П рдЗрд╕ рдЙрдкрд╡рд┐рд╖рдп рдХреЗ рд╕рд╛рд░реЗ рдкреНрд░рд╢реНрди рд╣рдореЗрд╢рд╛ рдХреЗ рд▓рд┐рдП рд╣рдЯ рдЬрд╛рдПрдВрдЧреЗ!\nрдХреНрдпрд╛ рдкрдХреНрдХрд╛ рдХрд░рдирд╛ рд╣реИ?")) return;
  const s = document.getElementById("manageMain").value;
  const sub = document.getElementById("subList").value;
  subjects[s] = subjects[s].filter(x => x !== sub);
  if(subjects[s].length === 0) delete subjects[s];
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  populateDropdowns();
  alert("ЁЯЧСя╕П рдЙрдкрд╡рд┐рд╖рдп рдФрд░ рдЙрд╕рдХрд╛ рдбреЗрдЯрд╛ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛");
}

function renameSubject(){
  const old = document.getElementById("manageMain").value;
  const neu = document.getElementById("renameMainInput").value.trim();
  if(!old || !neu) return alert("тЭЧ рджреЛрдиреЛрдВ рдирд╛рдо рднрд░реЗрдВ");
  if(subjects[neu]) return alert("тЪая╕П рдирдпрд╛ рдирд╛рдо рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИ");
  subjects[neu] = subjects[old];
  delete subjects[old];
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));
  document.getElementById("renameMainInput").value = "";
  populateDropdowns();
  alert("тЬЕ рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдХрд╛ рдирд╛рдо рдмрджрд▓ рджрд┐рдпрд╛ рдЧрдпрд╛");
}

async function renameSubtopic(){
  const subject = document.getElementById("manageMain").value;
  const oldSub = document.getElementById("subList").value;
  if(!subject || !oldSub) return alert("тЭЧ рдкрд╣рд▓реЗ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ");
  const newSub = prompt(`рдкреБрд░рд╛рдирд╛ рдирд╛рдо: "${oldSub}"\nрдирдпрд╛ рдирд╛рдо рдбрд╛рд▓реЗрдВ:`, oldSub)?.trim();
  if(!newSub || newSub === oldSub) return;
  if(subjects[subject].includes(newSub)) return alert("тЪая╕П рдпрд╣ рдирд╛рдо рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╣реИ");

  subjects[subject] = subjects[subject].filter(s => s !== oldSub);
  subjects[subject].push(newSub);
  subjects[subject].sort(naturalSort);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));

  try{
    await openDB();
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);
    let count = 0;
    store.openCursor().onsuccess = e => {
      const cursor = e.target.result;
      if(cursor){
        const d = cursor.value;
        let changed = false;
        if(d.subject === subject){
          if(d.subtopic === oldSub){ d.subtopic = newSub; changed = true; }
          if(d.subtopicName === oldSub){ d.subtopicName = newSub; changed = true; }
        }
        if(d.id && d.id.startsWith(`quiz_${subject}_${oldSub}_`)){
          const suffix = d.id.slice(`quiz_${subject}_${oldSub}_`.length);
          d.id = `quiz_${subject}_${newSub}_${suffix}`;
          changed = true;
        }
        if(changed){ cursor.update(d); count++; }
        cursor.continue();
      }
    };
    await tx.done;
    populateSubList();
    populateSubSubjects();
    alert(`тЬЕ "${oldSub}" тЖТ "${newSub}" рд╣реЛ рдЧрдпрд╛!\n${count} рдкреНрд░рд╢реНрди рдЕрдкрдбреЗрдЯ рд╣реБрдПред`);
  }catch(err){
    console.error(err);
    alert("тЭМ IndexedDB рдЕрдкрдбреЗрдЯ рдореЗрдВ рддреНрд░реБрдЯрд┐");
  }
}

function proceedToAction(){
  const m = document.getElementById("mainSubject").value;
  const s = document.getElementById("subSubject").value;
  if(!m || !s) return alert("тЭЧ рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рджреЛрдиреЛрдВ рдЪреБрдиреЗрдВ");
  localStorage.setItem("selectedMain", m);
  localStorage.setItem("selectedSub", s);
  location.href = "action.html";
}

function exportData(){
  const data = {
    subjects: JSON.parse(localStorage.getItem("quiz_subjects") || "{}"),
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'quiz_backup_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
  URL.revokeObjectURL(url);
  alert("тЬЕ рдмреИрдХрдЕрдк рдбрд╛рдЙрдирд▓реЛрдб рд╣реЛ рдЧрдпрд╛!");
}

function importData(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = e => {
    const file = e.target.files[0];
    const reader = new FileReader();
    reader.onload = ev => {
      try{
        const data = JSON.parse(ev.target.result);
        if(data.subjects){
          localStorage.setItem("quiz_subjects", JSON.stringify(data.subjects));
          subjects = data.subjects;
          populateDropdowns();
          alert("тЬЕ рдбреЗрдЯрд╛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЖрдпрд╛рдд рд╣реЛ рдЧрдпрд╛!");
        }else alert("тЭМ рдЧрд▓рдд рдлрд╛рдЗрд▓ рдлреЙрд░реНрдореЗрдЯ");
      }catch(err){ alert("тЭМ рдлрд╛рдЗрд▓ рдкрдврд╝рдиреЗ рдореЗрдВ рддреНрд░реБрдЯрд┐"); }
    };
    reader.readAsText(file);
  };
  input.click();
}

window.addEventListener('load', populateDropdowns);
</script>
</body>
</html>
