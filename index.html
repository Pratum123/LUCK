<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>ЁЯУЪ рд╡рд┐рд╖рдп рдЪрдпрди</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body{font-family:'Segoe UI',sans-serif;background:#f4f6fb;margin:0;padding:0}
    header{background:#3949ab;color:white;padding:15px;font-size:22px;text-align:center;position:sticky;top:0;z-index:100}
    .container{max-width:500px;margin:20px auto;background:white;padding:15px;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,0.1)}
    h1{text-align:center;color:#3949ab;font-size:20px;margin:10px 0}
    select,input,button{width:100%;padding:10px;margin:8px 0;border-radius:6px;border:1px solid #ccc;font-size:14px;box-sizing:border-box}
    .btn{background:#3949ab;color:white;font-weight:bold;border:none;cursor:pointer;padding:10px;margin:5px 0}
    .section{margin-bottom:20px;border:1px solid #e0e0e0;border-radius:8px;padding:12px}
    .tab-container{display:flex;margin-bottom:15px;flex-wrap:wrap}
    .tab{flex:1;text-align:center;padding:8px;background:#e0e0e0;cursor:pointer;border-radius:5px 5px 0 0;margin:2px;min-width:80px}
    .tab.active{background:#3949ab;color:white}
    .tab-content{display:none}
    .tab-content.active{display:block}
  </style>
</head>
<body>
  <header>ЁЯУЪ Quiz App</header>
  <div class="container">
    <h1>рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪрдпрди</h1>
    <div class="tab-container">
      <div class="tab active" onclick="switchTab('select')">рд╡рд┐рд╖рдп рдЪрдпрди</div>
      <div class="tab" onclick="switchTab('add')">рдирдпрд╛ рдЬреЛрдбрд╝реЗрдВ</div>
      <div class="tab" onclick="switchTab('manage')">рдкреНрд░рдмрдВрдзрди</div>
      <div class="tab" onclick="switchTab('backup')">рдмреИрдХрдЕрдк</div>
    </div>

    <div id="select-tab" class="tab-content active">
      <div class="section">
        <label><strong>рдореБрдЦреНрдп рд╡рд┐рд╖рдп:</strong></label>
        <select id="mainSubject" onchange="populateSubSubjects()"></select>
        <label><strong>рдЙрдкрд╡рд┐рд╖рдп:</strong></label>
        <select id="subSubject"></select>
        <button class="btn" onclick="proceedToAction()">ЁЯСЙ рдЖрдЧреЗ рдмрдврд╝реЗрдВ</button>
      </div>
    </div>

    <div id="add-tab" class="tab-content">
      <div class="section">
        <input id="newMain" placeholder="рдореБрдЦреНрдп рд╡рд┐рд╖рдп">
        <input id="newSubs" placeholder="рдЙрдкрд╡рд┐рд╖рдп (рдХреЙрдорд╛ рд╕реЗ рдЕрд▓рдЧ рдХрд░реЗрдВ)">
        <button class="btn" onclick="addNewSubject()">рдирдпрд╛ рд╡рд┐рд╖рдп рдЬреЛреЬреЗрдВ</button>
      </div>
    </div>

    <div id="manage-tab" class="tab-content">
      <div class="section">
        <select id="manageMain" onchange="populateSubList()"></select>
        <select id="subList"></select>
        <input id="newSubInput" placeholder="рдирдпрд╛ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ">
        <button class="btn" onclick="addSub()">тЮХ рдЙрдкрд╡рд┐рд╖рдп рдЬреЛрдбрд╝реЗрдВ</button>
        <button class="btn" onclick="deleteSub()">ЁЯЧСя╕П рдЙрдкрд╡рд┐рд╖рдп рд╣рдЯрд╛рдПрдВ</button>
        <button class="btn" onclick="renameSubtopic()">тЬПя╕П рдЙрдкрд╡рд┐рд╖рдп рдирд╛рдо рдмрджрд▓реЗрдВ</button>
        <hr>
        <input id="renameMainInput" placeholder="рдирдпрд╛ рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдирд╛рдо">
        <button class="btn" onclick="renameSubject()">тЬПя╕П рдореБрдЦреНрдп рд╡рд┐рд╖рдп рдирд╛рдо рдмрджрд▓реЗрдВ</button>
      </div>
    </div>

    <div id="backup-tab" class="tab-content">
      <div class="section">
        <button class="btn" onclick="exportData()">рдбреЗрдЯрд╛ рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдВ</button>
      </div>
    </div>
  </div>

<script>
let subjects = {};
const DB_NAME = 'QuizAppDB', DB_VERSION = 2, STORE_NAME = 'quizzes';
let db = null;

function naturalSort(a,b){return a.localeCompare(b,{numeric:true,sensitivity:'base'});}
function switchTab(t){document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.querySelectorAll('.tab').forEach(c=>c.classList.remove('active'));document.getElementById(t+'-tab').classList.add('active');document.querySelector(`.tab[onclick="switchTab('${t}')"]`).classList.add('active');}

function openDB(){return new Promise((res,rej)=>{if(db) return res(db);const req=indexedDB.open(DB_NAME,DB_VERSION);req.onsuccess=e=> {db=e.target.result;res(db);};req.onerror=()=>rej(req.error);req.onupgradeneeded=e=>{db=e.target.result;if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME,{keyPath:'id'});};});}

async function loadSubjectsFromDB(){
  await openDB();
  return new Promise(res=>{
    const tx=db.transaction(STORE_NAME,'readonly'), store=tx.objectStore(STORE_NAME);
    const set=new Set(), map={};
    store.openCursor().onsuccess=e=>{
      const c=e.target.result;
      if(c){
        const d=c.value;
        let main=d.subject, sub=d.subtopic||d.subtopicName;
        if(!main && d.id && d.id.startsWith('quiz_')){const p=d.id.split('_');if(p.length>=3){main=p[1];sub=p[2];}}
        if(main){set.add(main);if(!map[main])map[main]=new Set();if(sub)map[main].add(sub);}
        c.continue();
      }else res({subjectsSet:set,subtopicsMap:map});
    };
  });
}

async function populateDropdowns(){
  subjects = JSON.parse(localStorage.getItem("quiz_subjects")||"{}");
  try{const {subjectsSet,subtopicsMap}=await loadSubjectsFromDB();
    subjectsSet.forEach(s=>{if(!subjects[s])subjects[s]=[];Array.from(subtopicsMap[s]||[]).forEach(st=>{if(!subjects[s].includes(st))subjects[s].push(st);});});
  }catch(e){console.log(e);}
  const m1=document.getElementById("mainSubject"), m2=document.getElementById("manageMain");
  m1.innerHTML=m2.innerHTML="<option>-- рд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>";
  Object.keys(subjects).sort(naturalSort).forEach(k=>{m1.add(new Option(k,k));m2.add(new Option(k,k));});
}

function populateSubSubjects(){
  const sub=document.getElementById("subSubject"); sub.innerHTML="<option>-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>";
  const s=document.getElementById("mainSubject").value;
  (subjects[s]||[]).sort(naturalSort).forEach(x=>sub.add(new Option(x,x)));
}
function populateSubList(){
  const list=document.getElementById("subList"); list.innerHTML="<option>-- рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ --</option>";
  const s=document.getElementById("manageMain").value;
  (subjects[s]||[]).sort(naturalSort).forEach(x=>list.add(new Option(x,x)));
}

/* ====== рдпрд╣ рд╡рд╛рд▓рд╛ рдлрдВрдХреНрд╢рди рд╣реА рдмрджрд▓рд╛рд╡ рд╣реИ тАФ рдмрд╛рдХреА рд╕рдм рд╡реИрд╕рд╛ рд╣реА ====== */
async function renameSubtopic() {
  const subject = document.getElementById("manageMain").value;
  const oldSub = document.getElementById("subList").value;
  if (!subject || !oldSub) return alert("тЭЧ рдкрд╣рд▓реЗ рд╡рд┐рд╖рдп рдФрд░ рдЙрдкрд╡рд┐рд╖рдп рдЪреБрдиреЗрдВ");

  const newSub = prompt(`рдкреБрд░рд╛рдирд╛: "${oldSub}"\nрдирдпрд╛ рдирд╛рдо:`, oldSub)?.trim();
  if (!newSub || newSub === oldSub) return;
  if (subjects[subject].includes(newSub)) return alert("тЪая╕П рдирд╛рдо рдкрд╣рд▓реЗ рд╕реЗ рд╣реИ!");

  // localStorage update
  subjects[subject] = subjects[subject].filter(s => s !== oldSub);
  subjects[subject].push(newSub);
  subjects[subject].sort(naturalSort);
  localStorage.setItem("quiz_subjects", JSON.stringify(subjects));

  // IndexedDB update
  try {
    await openDB();
    const tx = db.transaction(STORE_NAME, "readwrite");
    const store = tx.objectStore(STORE_NAME);
    let count = 0;

    store.openCursor().onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor) {
        const d = cursor.value;
        let changed = false;
        if (d.subject === subject) {
          if (d.subtopic === oldSub) { d.subtopic = newSub; changed = true; }
          if (d.subtopicName === oldSub) { d.subtopicName = newSub; changed = true; }
        }
        if (d.id && d.id.startsWith(`quiz_${subject}_${oldSub}_`)) {
          const suffix = d.id.slice(`quiz_${subject}_${oldSub}_`.length);
          d.id = `quiz_${subject}_${newSub}_${suffix}`;
          changed = true;
        }
        if (changed) { cursor.update(d); count++; }
        cursor.continue();
      }
    };

    await tx.done;
    populateSubList();
    populateSubSubjects();
    alert(`тЬЕ "${oldSub}" тЖТ "${newSub}" рд╣реЛ рдЧрдпрд╛!\n${count} рдкреНрд░рд╢реНрди рдЕрдкрдбреЗрдЯ рд╣реБрдПред`);
  } catch (err) { console.error(err); alert("тЭМ рддреНрд░реБрдЯрд┐ рд╣реБрдИ"); }
}

/* рдмрд╛рдХреА рдлрдВрдХреНрд╢рди рд╡рд╣реА */
function addNewSubject(){/* рд╡рд╣реА рдХреЛрдб */ const newMain=document.getElementById("newMain").value.trim(); const subs=document.getElementById("newSubs").value.split(',').map(s=>s.trim()).filter(Boolean); if(!newMain||!subs.length)return alert("рднрд░реЗрдВ"); subjects[newMain]=(subjects[newMain]||[]).concat(subs); subjects[newMain].sort(naturalSort); localStorage.setItem("quiz_subjects",JSON.stringify(subjects)); populateDropdowns(); alert("рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛"); document.getElementById("newMain").value=document.getElementById("newSubs").value=""; switchTab('select');}
function addSub(){const s=document.getElementById("manageMain").value; const n=document.getElementById("newSubInput").value.trim(); if(!s||!n)return alert("рднрд░реЗрдВ"); if(subjects[s].includes(n))return alert("рдкрд╣рд▓реЗ рд╕реЗ рд╣реИ"); subjects[s].push(n); subjects[s].sort(naturalSort); localStorage.setItem("quiz_subjects",JSON.stringify(subjects)); document.getElementById("newSubInput").value=""; populateSubList(); populateSubSubjects(); alert("рдЬреЛрдбрд╝рд╛");}
function deleteSub(){if(!confirm("рд╕рд╛рд░рд╛ рдбреЗрдЯрд╛ рд╣рдЯ рдЬрд╛рдПрдЧрд╛!"))return; const s=document.getElementById("manageMain").value; const sub=document.getElementById("subList").value; subjects[s]=subjects[s].filter(x=>x!==sub); localStorage.setItem("quiz_subjects",JSON.stringify(subjects)); populateSubList(); populateSubSubjects();}
function renameSubject(){const old=document.getElementById("manageMain").value; const neu=document.getElementById("renameMainInput").value.trim(); if(!old||!neu)return alert("рднрд░реЗрдВ"); if(subjects[neu])return alert("рдкрд╣рд▓реЗ рд╕реЗ рд╣реИ"); subjects[neu]=subjects[old]; delete subjects[old]; localStorage.setItem("quiz_subjects",JSON.stringify(subjects)); document.getElementById("renameMainInput").value=""; populateDropdowns();}
function proceedToAction(){const m=document.getElementById("mainSubject").value; const s=document.getElementById("subSubject").value; if(!m||!s)return alert("рдЪреБрдиреЗрдВ"); localStorage.setItem("selectedMain",m); localStorage.setItem("selectedSub",s); location.href="action.html";}
function exportData(){alert("рдмрд╛рдж рдореЗрдВ рдЬреЛрдбрд╝реЗрдВрдЧреЗ");}
window.addEventListener('load',populateDropdowns);
</script>
</body>
</html>
